<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹äº”å¤§æˆæœ¬è©¦ç®—ç³»çµ±ï¼ˆMode C å¤šå·¥ç¨‹ç‰ˆï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + ReactDOM + Babel (JSX ç·¨è­¯) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- SheetJSï¼šåŒ¯å‡º Excel ç”¨ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      background: #f3f4f6;
      font-family: "Microsoft JhengHei", sans-serif;
    }
    .tab-active {
      border-bottom: 3px solid #2563eb;
      color: #2563eb;
      font-weight: bold;
    }
    .no-print { display: block; }
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>

<body>
<div id="root"></div>


<!-- ==========================================================
       ğŸ“Œ ç¬¬ 1 æ®µï¼šå…¨åŸŸå·¥å…·å‡½å¼å±¤ï¼ˆç„¡ä»»ä½• React UIï¼‰
=========================================================== -->
<script type="module">

/* ---------------------------------------------------------
   ğŸ“Œ å·¥å…·ï¼šä¸‹è¼‰ Google Sheet CSV
--------------------------------------------------------- */
export async function fetchCSV(url) {
  const res = await fetch(url);
  const text = await res.text();
  return text.trim().split("\n").map(line =>
    line.split(",").map(c => c.replace(/^"|"$/g, ""))
  );
}

/* ---------------------------------------------------------
   ğŸ“Œ localStorage Load / Save
--------------------------------------------------------- */
export function loadDB(key, def) {
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }
  catch { return def; }
}
export function saveDB(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

/* ---------------------------------------------------------
   ğŸ“Œ Sheet è³‡æ–™ç‰ˆæœ¬ç¢¼ï¼ˆåµæ¸¬æ˜¯å¦æœ‰æ›´æ–°ï¼‰
--------------------------------------------------------- */
export function calcSheetVersion(rows) {
  if (!rows || rows.length < 2) return "EMPTY";
  return rows.length + "|" + rows[0].join("|") + "|" + rows.at(-1).join("|");
}

/* ---------------------------------------------------------
   ğŸ“Œ Mode Cï¼šé€šç”¨åŒæ­¥å™¨ï¼ˆ5 å¤§è³‡æ–™åº«å…±ç”¨ï¼‰
--------------------------------------------------------- */
export async function syncDB({ type, url, mapping, setDB, setSheetVersion }) {
  const VERSION_KEY = `${type}DB_version`;
  const rows = await fetchCSV(url);
  if (!rows || rows.length <= 1) return;

  const newVersion = calcSheetVersion(rows);
  const oldVersion = localStorage.getItem(VERSION_KEY);
  const localData = loadDB(`${type}DB`, []);

  // ç‰ˆæœ¬ç›¸åŒ â†’ ä¸æ›´æ–°
  if (newVersion === oldVersion && localData.length > 0) {
    const now = Date.now().toString();
    setSheetVersion(v => ({ ...v, [type]: now }));
    return;
  }

  // ç‰ˆæœ¬ä¸åŒ â†’ é‡æ–°è§£æ
  const list = rows.slice(1).map((r, idx) => {
    const obj = { id: Date.now() + idx };
    mapping.forEach((key, i) => {
      obj[key] = r[i] || "";
      if (["price","qty","weight"].includes(key)) obj[key] = Number(obj[key]) || 0;
    });
    return obj;
  });

  setDB(list);
  localStorage.setItem(VERSION_KEY, newVersion);

  const now = Date.now().toString();
  setSheetVersion(v => ({ ...v, [type]: now }));
}


/* ---------------------------------------------------------
   ğŸ“Œ å¤šå·¥ç¨‹ Load / Save
--------------------------------------------------------- */
export function loadProjects() {
  return loadDB("allProjects", {});
}
export function saveProjects(data) {
  saveDB("allProjects", data);
}


/* ---------------------------------------------------------
   ğŸ“Œ æ•´æ•¸å››æ¨äº”å…¥å·¥å…·ï¼ˆç¦æ­¢å°æ•¸ï¼‰
--------------------------------------------------------- */
export function roundInt(v) {
  if (!v) return 0;
  return Math.round(Number(v));
}


/* ---------------------------------------------------------
   ğŸ“Œ ä¸‹æ‹‰å¼é¸å–®ï¼šä¾ç…§è³‡æ–™åº«ç”¢ç”Ÿ options
--------------------------------------------------------- */
export function extractOptions(db, fields) {
  // fields = ["category", "spec"] ç­‰
  return db.map(item => {
    const label = fields.map(f => item[f]).join(" / ");
    return { label, item };
  });
}


/* ---------------------------------------------------------
   ğŸ“Œ åŒ¯å‡º Excelï¼ˆå…­å¤§ Sheetï¼‰
--------------------------------------------------------- */
export function exportExcel({ projectName, material, purchase, fabricate, transport, install, summary }) {

  const wb = XLSX.utils.book_new();

  function addSheet(sheetName, rows) {
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  }

  addSheet("ææ–™æˆæœ¬", material);
  addSheet("å¸‚è³¼å“", purchase);
  addSheet("è£½ä½œ", fabricate);
  addSheet("é‹è¼¸", transport);
  addSheet("å®‰è£", install);
  addSheet("ç¸½è¡¨", summary);

  XLSX.writeFile(wb, `${projectName}-æˆæœ¬æ˜ç´°.xlsx`);
}

</script>
<!-- ==========================================================
       ğŸ“Œ ç¬¬ 2 æ®µï¼šäº”å¤§æˆæœ¬ React Components
=========================================================== -->
<script type="text/babel" data-type="module">

const { useState, useEffect, useMemo } = React;

/* ---------------------------------------------------------
   ğŸ“Œ Google Sheet è³‡æ–™ä¾†æº
--------------------------------------------------------- */
const GOOGLE_SHEETS = {
  material:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",

  purchase:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",

  fabricate:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",

  transport:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",

  install:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv",
};


/* ---------------------------------------------------------
   ğŸ“Œ åˆ†é  Tabsï¼ˆç½®é ‚å›ºå®šï¼‰
--------------------------------------------------------- */
function TopTabs({ active, setActive }) {
  const tabs = [
    { key: "mat", label: "ææ–™" },
    { key: "pur", label: "å¸‚è³¼å“" },
    { key: "fab", label: "è£½ä½œ" },
    { key: "tra", label: "é‹è¼¸" },
    { key: "ins", label: "å®‰è£" },
    { key: "sum", label: "ç¸½è¡¨" },
  ];

  return (
    <div className="no-print sticky top-0 bg-white shadow z-50">
      <div className="flex border-b">
        {tabs.map(t => (
          <button
            key={t.key}
            onClick={() => setActive(t.key)}
            className={
              "flex-1 py-3 text-center hover:bg-gray-100 " +
              (active === t.key ? "tab-active" : "")
            }
          >
            {t.label}
          </button>
        ))}
      </div>
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ MaterialCalcï¼ˆææ–™æˆæœ¬ï¼‰
--------------------------------------------------------- */
function MaterialCalc({ db, items, addItem, deleteItem, updateItem }) {
  const [category, setCategory] = useState("");
  const [spec, setSpec] = useState("");
  const [L, setL] = useState("");
  const [W, setW] = useState("");
  const [pcs, setPcs] = useState("");
  const [len2, setLen2] = useState("");
  const [qty, setQty] = useState("");

  const categories = useMemo(
    () => [...new Set(db.map(x => x.category))],
    [db]
  );

  const specs = useMemo(
    () => db.filter(x => x.category === category).map(x => x.spec),
    [db, category]
  );

  const selected = useMemo(
    () => db.find(x => x.category === category && x.spec === spec),
    [db, category, spec]
  );

  const isPlate =
    selected &&
    (selected.unit?.includes("mÂ²") ||
      category.includes("æ¿") ||
      spec.includes("æ¿"));

  const density = selected?.weight || 0;

  const weight = useMemo(() => {
    if (!selected) return 0;
    const L_val = Number(isPlate ? L : len2) || 0;
    const W_val = Number(isPlate ? W : 1) || 0;
    const pcs_qty = Number(isPlate ? pcs : qty) || 0;
    return L_val * W_val * pcs_qty * density;
  }, [selected, isPlate, L, W, pcs, len2, qty, density]);

  const subtotal = weight * (selected?.price || 0);

  const add = () => {
    if (!selected) return alert("è«‹é¸æ“‡ææ–™");
    if (subtotal <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºå°ºå¯¸ / æ•¸é‡");

    addItem({
      id: Date.now(),
      type: "ææ–™",
      category,
      spec,
      length: isPlate ? L : len2,
      width: isPlate ? W : "",
      qty: isPlate ? pcs : qty,
      unit: selected.unit,
      weight,
      unitPrice: selected.price,
      subtotal,
    });

    setL(""); setW(""); setPcs(""); setLen2(""); setQty(""); setSpec("");
  };

  const list = items.filter(x => x.type === "ææ–™");
  const totalCost = list.reduce((s, x) => s + x.subtotal, 0);

  return (
    <div className="p-4">

      <div className="bg-white p-4 rounded-xl shadow mb-4">
        <h2 className="text-xl font-bold mb-3">ğŸ§± ææ–™æˆæœ¬è©¦ç®—</h2>

        {/* é¸æ“‡åˆ†é¡ */}
        <div className="mb-3 flex gap-3">
          <div>
            <label>åˆ†é¡</label>
            <select
              className="border p-2 rounded ml-2"
              value={category}
              onChange={e => { setCategory(e.target.value); setSpec(""); }}
            >
              <option value="">è«‹é¸æ“‡</option>
              {categories.map(c => <option key={c}>{c}</option>)}
            </select>
          </div>

          {/* è¦æ ¼ */}
          {category && (
            <div>
              <label>è¦æ ¼</label>
              <select
                className="border p-2 rounded ml-2"
                value={spec}
                onChange={e => setSpec(e.target.value)}
              >
                <option value="">è«‹é¸æ“‡</option>
                {specs.map(s => <option key={s}>{s}</option>)}
              </select>
            </div>
          )}
        </div>

        {/* æ¿æ or å‹é‹¼è¼¸å…¥æ¬„ä½ */}
        {selected && (
          <div className="grid grid-cols-4 gap-4 mb-4">

            <div>
              <label>é•·åº¦ m</label>
              <input
                className="border p-2 rounded w-full"
                value={isPlate ? L : len2}
                type="number"
                onChange={e => isPlate ? setL(e.target.value) : setLen2(e.target.value)}
              />
            </div>

            {isPlate && (
              <div>
                <label>å¯¬åº¦ m</label>
                <input
                  className="border p-2 rounded w-full"
                  value={W}
                  type="number"
                  onChange={e => setW(e.target.value)}
                />
              </div>
            )}

            <div>
              <label>æ•¸é‡</label>
              <input
                className="border p-2 rounded w-full"
                value={isPlate ? pcs : qty}
                type="number"
                onChange={e => isPlate ? setPcs(e.target.value) : setQty(e.target.value)}
              />
            </div>

            <div>
              <label>å–®åƒ¹</label>
              <input
                className="border p-2 rounded w-full bg-gray-100"
                disabled
                value={selected.price}
              />
            </div>

          </div>
        )}

        {/* å°è¨ˆ */}
        {selected && (
          <div className="text-gray-700 mb-3">
            <p>é‡é‡ï¼š{weight.toFixed(2)} kg</p>
            <p>å°è¨ˆï¼š{subtotal.toLocaleString()} å…ƒ</p>
          </div>
        )}

        {/* åŠ å…¥æŒ‰éˆ• */}
        <button
          onClick={add}
          className="px-4 py-2 bg-emerald-600 text-white rounded"
        >
          â• åŠ å…¥ææ–™é …ç›®
        </button>
      </div>

      {/* åˆ—è¡¨ */}
      <ItemList
        title="ææ–™æˆæœ¬åˆ—è¡¨"
        items={list}
        deleteItem={deleteItem}
        updateItem={updateItem}
      />

      {/* ç¸½å’Œ */}
      <SummaryLine label="ææ–™æˆæœ¬åˆè¨ˆ" value={totalCost} color="blue" />
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ PurchaseCalcï¼ˆå¸‚è³¼å“ï¼Œä¸‹æ‹‰å¼é¸å–®ï¼‰
--------------------------------------------------------- */
function PurchaseCalc({ db, items, addItem, deleteItem, updateItem }) {
  const options = extractOptions(db, ["category", "spec"]);

  const [selected, setSelected] = useState(null);
  const [qty, setQty] = useState("");

  const add = () => {
    if (!selected) return alert("è«‹é¸æ“‡å“é …");
    if (!qty || qty <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");

    addItem({
      id: Date.now(),
      type: "å¸‚è³¼å“",
      name: selected.item.category,
      spec: selected.item.spec,
      qty: roundInt(qty),
      unitPrice: selected.item.price,
      subtotal: roundInt(qty) * selected.item.price,
    });

    setQty("");
  };

  const list = items.filter(x => x.type === "å¸‚è³¼å“");
  const total = list.reduce((s, x) => s + x.subtotal, 0);

  return (
    <div className="p-4">

      <div className="bg-white p-4 rounded-xl shadow mb-4">
        <h2 className="text-xl font-bold mb-3">ğŸ›’ å¸‚è³¼å“</h2>

        {/* ä¸‹æ‹‰ */}
        <select
          className="border p-2 rounded w-80 mb-3"
          onChange={e => {
            const obj = options.find(o => o.label === e.target.value);
            setSelected(obj || null);
          }}
        >
          <option value="">è«‹é¸æ“‡å“é …</option>
          {options.map(o => (
            <option key={o.item.id}>{o.label}</option>
          ))}
        </select>

        {selected && (
          <div className="mb-3">
            <p>å–®åƒ¹ï¼š{selected.item.price} å…ƒ</p>
            <input
              className="border p-2 rounded w-40 mt-2"
              type="number"
              placeholder="è¼¸å…¥æ•¸é‡"
              value={qty}
              onChange={e => setQty(e.target.value)}
            />
          </div>
        )}

        <button
          onClick={add}
          className="px-4 py-2 bg-emerald-600 text-white rounded"
        >
          â• åŠ å…¥å¸‚è³¼å“
        </button>
      </div>

      <ItemList
        title="å¸‚è³¼å“åˆ—è¡¨"
        items={list}
        deleteItem={deleteItem}
        updateItem={updateItem}
      />

      <SummaryLine label="å¸‚è³¼å“æˆæœ¬åˆè¨ˆ" value={total} color="green" />
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ FabricateCalcï¼ˆè£½ä½œï¼‰
--------------------------------------------------------- */
function FabricateCalc({ db, items, addItem, deleteItem, updateItem }) {
  const options = extractOptions(db, ["category", "spec"]);
  const [selected, setSelected] = useState(null);

  const add = () => {
    if (!selected) return alert("è«‹é¸æ“‡é …ç›®");

    addItem({
      id: Date.now(),
      type: "è£½ä½œ",
      name: selected.item.category,
      spec: selected.item.spec,
      qty: 1,
      unitPrice: selected.item.price,
      subtotal: selected.item.price,
    });
  };

  const list = items.filter(x => x.type === "è£½ä½œ");
  const total = list.reduce((s, x) => s + x.subtotal, 0);

  return (
    <div className="p-4">

      <div className="bg-white p-4 rounded-xl shadow mb-4">
        <h2 className="text-xl font-bold mb-3">ğŸ”§ è£½ä½œæˆæœ¬</h2>

        <select
          className="border p-2 rounded w-80 mb-3"
          onChange={e => {
            const obj = options.find(o => o.label === e.target.value);
            setSelected(obj || null);
          }}
        >
          <option value="">è«‹é¸æ“‡è£½ä½œé …ç›®</option>
          {options.map(o => <option key={o.item.id}>{o.label}</option>)}
        </select>

        <button
          onClick={add}
          className="px-4 py-2 bg-emerald-600 text-white rounded"
        >
          â• åŠ å…¥è£½ä½œé …ç›®
        </button>
      </div>

      <ItemList title="è£½ä½œåˆ—è¡¨" items={list} deleteItem={deleteItem} updateItem={updateItem} />

      <SummaryLine label="è£½ä½œæˆæœ¬åˆè¨ˆ" value={total} color="yellow" />
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ TransportCalcï¼ˆé‹è¼¸ï¼‰
--------------------------------------------------------- */
function TransportCalc({ db, items, addItem, deleteItem, updateItem }) {
  const options = extractOptions(db, ["category", "spec"]);
  const [selected, setSelected] = useState(null);

  const add = () => {
    if (!selected) return alert("è«‹é¸æ“‡é …ç›®");

    addItem({
      id: Date.now(),
      type: "é‹è¼¸",
      name: selected.item.category,
      spec: selected.item.spec,
      qty: 1,
      unitPrice: selected.item.price,
      subtotal: selected.item.price,
    });
  };

  const list = items.filter(x => x.type === "é‹è¼¸");
  const total = list.reduce((s, x) => s + x.subtotal, 0);

  return (
    <div className="p-4">

      <div className="bg-white p-4 rounded-xl shadow mb-4">
        <h2 className="text-xl font-bold mb-3">ğŸšš é‹è¼¸è²»ç”¨</h2>

        <select
          className="border p-2 rounded w-80 mb-3"
          onChange={e => {
            const obj = options.find(o => o.label === e.target.value);
            setSelected(obj || null);
          }}
        >
          <option value="">è«‹é¸æ“‡é‹è¼¸æ–¹å¼</option>
          {options.map(o => <option key={o.item.id}>{o.label}</option>)}
        </select>

        <button
          onClick={add}
          className="px-4 py-2 bg-emerald-600 text-white rounded"
        >
          â• åŠ å…¥é‹è¼¸è²»ç”¨
        </button>
      </div>

      <ItemList title="é‹è¼¸åˆ—è¡¨" items={list} deleteItem={deleteItem} updateItem={updateItem} />

      <SummaryLine label="é‹è¼¸è²»ç”¨åˆè¨ˆ" value={total} color="red" />
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ InstallCalcï¼ˆå®‰è£ï¼‰
--------------------------------------------------------- */
function InstallCalc({ db, items, addItem, deleteItem, updateItem }) {
  const options = extractOptions(db, ["category", "spec"]);
  const [selected, setSelected] = useState(null);

  const add = () => {
    if (!selected) return alert("è«‹é¸æ“‡é …ç›®");

    addItem({
      id: Date.now(),
      type: "å®‰è£",
      name: selected.item.category,
      spec: selected.item.spec,
      qty: 1,
      unitPrice: selected.item.price,
      subtotal: selected.item.price,
    });
  };

  const list = items.filter(x => x.type === "å®‰è£");
  const total = list.reduce((s, x) => s + x.subtotal, 0);

  return (
    <div className="p-4">

      <div className="bg-white p-4 rounded-xl shadow mb-4">
        <h2 className="text-xl font-bold mb-3">ğŸ›  ç¾å ´å®‰è£</h2>

        <select
          className="border p-2 rounded w-80 mb-3"
          onChange={e => {
            const obj = options.find(o => o.label === e.target.value);
            setSelected(obj || null);
          }}
        >
          <option value="">è«‹é¸æ“‡å®‰è£æ–¹å¼</option>
          {options.map(o => <option key={o.item.id}>{o.label}</option>)}
        </select>

        <button
          onClick={add}
          className="px-4 py-2 bg-emerald-600 text-white rounded"
        >
          â• åŠ å…¥å®‰è£é …ç›®
        </button>
      </div>

      <ItemList title="å®‰è£åˆ—è¡¨" items={list} deleteItem={deleteItem} updateItem={updateItem} />

      <SummaryLine label="å®‰è£æˆæœ¬åˆè¨ˆ" value={total} color="purple" />
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ ItemListï¼ˆå…±ç”¨å…ƒä»¶ï¼‰â€“ å«ç·¨è¼¯ / åˆªé™¤åŠŸèƒ½
--------------------------------------------------------- */
function ItemList({ title, items, deleteItem, updateItem }) {

  const [editId, setEditId] = useState(null);
  const [editQty, setEditQty] = useState("");
  const [editUnit, setEditUnit] = useState("");

  const startEdit = item => {
    setEditId(item.id);
    setEditQty(item.qty);
    setEditUnit(item.unitPrice);
  };

  const saveEdit = item => {
    if (!editQty || editQty <= 0) return alert("æ•¸é‡å¿…é ˆç‚ºæ­£æ•´æ•¸");
    if (!editUnit || editUnit < 0) return alert("å–®åƒ¹éŒ¯èª¤");

    updateItem(item.id, {
      qty: roundInt(editQty),
      unitPrice: roundInt(editUnit),
      subtotal: roundInt(editQty) * roundInt(editUnit),
    });

    setEditId(null);
  };

  if (items.length === 0) return null;

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">
      <h3 className="text-lg font-bold mb-3">{title}</h3>

      <table className="w-full text-sm border-collapse">
        <thead className="bg-gray-100">
          <tr>
            <th className="p-2 border">åç¨±</th>
            <th className="p-2 border">è¦æ ¼</th>
            <th className="p-2 border">æ•¸é‡</th>
            <th className="p-2 border">å–®åƒ¹</th>
            <th className="p-2 border">å°è¨ˆ</th>
            <th className="p-2 border">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map(item => (
            <tr key={item.id} className="hover:bg-gray-50">

              <td className="p-2 border">{item.name || item.category}</td>
              <td className="p-2 border">{item.spec || "â€”"}</td>

              {/* ç·¨è¼¯æ¨¡å¼ */}
              {editId === item.id ? (
                <>
                  <td className="p-2 border">
                    <input
                      className="border p-1 w-20"
                      type="number"
                      value={editQty}
                      onChange={e => setEditQty(e.target.value)}
                    />
                  </td>

                  <td className="p-2 border">
                    <input
                      className="border p-1 w-20"
                      type="number"
                      value={editUnit}
                      onChange={e => setEditUnit(e.target.value)}
                    />
                  </td>

                  <td className="p-2 border">
                    {(roundInt(editQty) * roundInt(editUnit)).toLocaleString()}
                  </td>

                  <td className="p-2 border space-x-2">
                    <button
                      className="px-2 py-1 bg-blue-600 text-white rounded"
                      onClick={() => saveEdit(item)}
                    >
                      å„²å­˜
                    </button>
                    <button
                      className="px-2 py-1 bg-gray-400 text-white rounded"
                      onClick={() => setEditId(null)}
                    >
                      å–æ¶ˆ
                    </button>
                  </td>
                </>
              ) : (
                <>
                  <td className="p-2 border">{item.qty}</td>
                  <td className="p-2 border">{item.unitPrice}</td>
                  <td className="p-2 border">{item.subtotal.toLocaleString()}</td>

                  <td className="p-2 border space-x-2">
                    <button
                      className="px-2 py-1 bg-yellow-500 text-white rounded"
                      onClick={() => startEdit(item)}
                    >
                      ç·¨è¼¯
                    </button>
                    <button
                      className="px-2 py-1 bg-red-600 text-white rounded"
                      onClick={() => deleteItem(item.id)}
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </>
              )}

            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ SummaryLine â€“ å–®è¡Œæ‘˜è¦
--------------------------------------------------------- */
function SummaryLine({ label, value, color }) {
  const colorMap = {
    blue: "text-blue-600",
    green: "text-green-600",
    yellow: "text-yellow-600",
    red: "text-red-600",
    purple: "text-purple-600",
  };

  return (
    <div className="text-right text-lg font-bold mb-6">
      {label}ï¼š
      <span className={colorMap[color]}>
        {value.toLocaleString()} å…ƒ
      </span>
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ SummaryPageï¼ˆç¸½è¡¨ + åœ“é¤…åœ– + è‰²å¡ + åˆ©ç®¡ + æ¯›åˆ©ç‡ï¼‰
--------------------------------------------------------- */
function SummaryPage({ items, projectName, manual, setManual, profitRate, setProfitRate, marginRate, setMarginRate }) {

  const sum = type =>
    items.filter(x => x.type === type).reduce((s, x) => s + x.subtotal, 0);

  const material = sum("ææ–™");
  const purchase = sum("å¸‚è³¼å“");
  const fabricate = sum("è£½ä½œ");
  const transport = sum("é‹è¼¸");
  const install = sum("å®‰è£");

  const subtotal = material + purchase + fabricate + transport + install;

  const afterManual = subtotal + (Number(manual) || 0);

  const profitValue = Math.round(afterManual * (Number(profitRate) / 100));
  const marginValue = Math.round(afterManual * (Number(marginRate) / 100));

  const finalPrice = afterManual + profitValue;

  /* åœ“é¤…åœ–ç™¾åˆ†æ¯” */
  useEffect(() => {
    const ctx = document.getElementById("chart-pie");
    if (!ctx) return;

    if (window.myPie) window.myPie.destroy();

    const dataArr = [material, purchase, fabricate, transport, install];
    const total = dataArr.reduce((s, x) => s + x, 0);

    window.myPie = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["ææ–™", "å¸‚è³¼å“", "è£½ä½œ", "é‹è¼¸", "å®‰è£"],
        datasets: [{
          data: dataArr,
          backgroundColor: ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6"]
        }]
      },
      plugins: [ChartDataLabels],
      options: {
        plugins: {
          datalabels: {
            color: "#fff",
            formatter: v => total ? ((v / total * 100).toFixed(1) + "%") : "",
            font: { weight: "bold" }
          }
        }
      }
    });
  }, [items]);

  return (
    <div className="p-4">
      <div className="bg-white p-4 rounded-xl shadow mb-4">

        <h2 className="text-2xl font-bold mb-4">ğŸ“˜ å·¥ç¨‹ç¸½è¡¨ï¼š{projectName}</h2>

        <table className="w-full text-sm border mb-6">
          <thead className="bg-gray-100">
            <tr>
              <th className="p-2 border">é …ç›®</th>
              <th className="p-2 border">é‡‘é¡</th>
            </tr>
          </thead>
          <tbody>
            <tr><td className="p-2 border">ææ–™</td><td className="p-2 border">{material.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">å¸‚è³¼å“</td><td className="p-2 border">{purchase.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">è£½ä½œ</td><td className="p-2 border">{fabricate.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">é‹è¼¸</td><td className="p-2 border">{transport.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">å®‰è£</td><td className="p-2 border">{install.toLocaleString()}</td></tr>

            <tr className="bg-gray-50 font-bold">
              <td className="p-2 border">æ‰‹å‹•èª¿æ•´</td>
              <td className="p-2 border">
                <input
                  className="border p-1 w-32 text-right"
                  type="number"
                  value={manual}
                  onChange={e => setManual(e.target.value)}
                />
              </td>
            </tr>

            <tr className="bg-gray-100 font-bold">
              <td className="p-2 border">åˆ©ç®¡æ¯”ï¼ˆ%ï¼‰</td>
              <td className="p-2 border">
                <input
                  className="border p-1 w-24 text-right"
                  type="number"
                  value={profitRate}
                  onChange={e => setProfitRate(e.target.value)}
                />
                ï¼ˆåŠ å€¼ï¼š{profitValue.toLocaleString()} å…ƒï¼‰
              </td>
            </tr>

            <tr className="bg-gray-100 font-bold">
              <td className="p-2 border">å»ºè­°æ¯›åˆ©ç‡ï¼ˆ%ï¼‰</td>
              <td className="p-2 border">
                <input
                  className="border p-1 w-24 text-right"
                  type="number"
                  value={marginRate}
                  onChange={e => setMarginRate(e.target.value)}
                />
              </td>
            </tr>

            <tr className="bg-gray-200 font-bold text-lg">
              <td className="p-2 border">å ±åƒ¹ç¸½é¡</td>
              <td className="p-2 border text-blue-600">
                {finalPrice.toLocaleString()} å…ƒ
              </td>
            </tr>
          </tbody>
        </table>

        {/* åœ“é¤…åœ– + è‰²å¡ */}
        <div className="flex gap-10">
          <canvas id="chart-pie" width="300"></canvas>

          <div className="space-y-2 text-sm">
            <div><span className="inline-block w-4 h-4 bg-blue-500 mr-2"></span>ææ–™</div>
            <div><span className="inline-block w-4 h-4 bg-green-500 mr-2"></span>å¸‚è³¼å“</div>
            <div><span className="inline-block w-4 h-4 bg-yellow-500 mr-2"></span>è£½ä½œ</div>
            <div><span className="inline-block w-4 h-4 bg-red-500 mr-2"></span>é‹è¼¸</div>
            <div><span className="inline-block w-4 h-4 bg-purple-500 mr-2"></span>å®‰è£</div>
          </div>
        </div>

      </div>
    </div>
  );
}

</script>
<!-- ==========================================================
       ğŸ“Œ ç¬¬ 3 æ®µï¼šApp ä¸»ç¨‹å¼ + ReactDOM.render()
=========================================================== -->
<script type="text/babel" data-type="module">

/* ---------------------------------------------------------
   ğŸ“Œ App ä¸»ç¨‹å¼ï¼ˆå¤šå·¥ç¨‹ç‰ˆï¼‰
--------------------------------------------------------- */
function App() {
  const [activeTab, setActiveTab] = useState("mat"); // é è¨­ææ–™é 
  const [projects, setProjects] = useState(loadProjects());
  const [activeProject, setActiveProject] = useState("");
  const [manual, setManual] = useState(0);
  const [profitRate, setProfitRate] = useState(15);   // åˆ©ç®¡æ¯”é è¨­ 15%
  const [marginRate, setMarginRate] = useState(35);   // æ¯›åˆ©ç‡é è¨­ 35%

  /* äº”å¤§è³‡æ–™åº« */
  const [matDB, setMatDB] = useState([]);
  const [purDB, setPurDB] = useState([]);
  const [fabDB, setFabDB] = useState([]);
  const [traDB, setTraDB] = useState([]);
  const [insDB, setInsDB] = useState([]);

  /* Sync Sheet ç‰ˆæœ¬è¨˜éŒ„ï¼ˆå¼·åˆ¶é‡æ–°æ¸²æŸ“ç”¨ï¼‰ */
  const [sheetVersion, setSheetVersion] = useState({
    material: "", purchase: "", fabricate: "", transport: "", install: ""
  });

  /* ---------------------------------------------------------
       ğŸ“Œ åˆå§‹åŒ–ï¼šè¼‰å…¥ Google Sheet â†’ å»ºç«‹äº”å¤§è³‡æ–™åº«
  --------------------------------------------------------- */
  useEffect(() => {
    syncDB({
      type: "material",
      url: GOOGLE_SHEETS.material,
      mapping: ["category", "spec", "unit", "price", "weight"],
      setDB: setMatDB,
      setSheetVersion
    });

    syncDB({
      type: "purchase",
      url: GOOGLE_SHEETS.purchase,
      mapping: ["category", "spec", "unit", "price"],
      setDB: setPurDB,
      setSheetVersion
    });

    syncDB({
      type: "fabricate",
      url: GOOGLE_SHEETS.fabricate,
      mapping: ["category", "spec", "unit", "price"],
      setDB: setFabDB,
      setSheetVersion
    });

    syncDB({
      type: "transport",
      url: GOOGLE_SHEETS.transport,
      mapping: ["category", "spec", "unit", "price"],
      setDB: setTraDB,
      setSheetVersion
    });

    syncDB({
      type: "install",
      url: GOOGLE_SHEETS.install,
      mapping: ["category", "spec", "unit", "price"],
      setDB: setInsDB,
      setSheetVersion
    });
  }, []);


  /* ---------------------------------------------------------
       ğŸ“Œ å·¥ç¨‹ï¼ˆProjectï¼‰è³‡æ–™çµæ§‹
       æ¯å€‹å·¥ç¨‹æœƒæœ‰ï¼š
       - itemsï¼šäº”å¤§æˆæœ¬æ‰€æœ‰ç´€éŒ„
       - manualï¼šæ‰‹å‹•èª¿æ•´
       - profitRateï¼šåˆ©ç®¡æ¯”
       - marginRateï¼šæ¯›åˆ©ç‡
  --------------------------------------------------------- */
  const ensureProject = name => {
    if (!projects[name]) {
      const newData = {
        ...projects,
        [name]: {
          items: [],
          manual: 0,
          profitRate: 15,
          marginRate: 35
        }
      };
      setProjects(newData);
      saveProjects(newData);
    }
  };


  /* ---------------------------------------------------------
       ğŸ“Œ å»ºç«‹æ–°å·¥ç¨‹
  --------------------------------------------------------- */
  const createProject = () => {
    const name = prompt("è«‹è¼¸å…¥æ–°å·¥ç¨‹åç¨±ï¼š");
    if (!name) return;

    ensureProject(name);
    setActiveProject(name);

    setManual(0);
    setProfitRate(15);
    setMarginRate(35);
  };


  /* ---------------------------------------------------------
       ğŸ“Œ åˆ‡æ›å·¥ç¨‹
  --------------------------------------------------------- */
  const switchProject = name => {
    setActiveProject(name);
    const p = projects[name];
    if (p) {
      setManual(p.manual);
      setProfitRate(p.profitRate);
      setMarginRate(p.marginRate);
    }
  };


  /* ---------------------------------------------------------
       ğŸ“Œ åˆªé™¤å·¥ç¨‹
  --------------------------------------------------------- */
  const removeProject = name => {
    if (!confirm(`ç¢ºå®šåˆªé™¤å·¥ç¨‹ï¼š${name}ï¼Ÿ`)) return;
    const newData = { ...projects };
    delete newData[name];
    setProjects(newData);
    saveProjects(newData);
    setActiveProject("");
  };


  /* ---------------------------------------------------------
       ğŸ“Œ ç•¶å‰å·¥ç¨‹ items å¿«å–
  --------------------------------------------------------- */
  const currentItems = activeProject ? (projects[activeProject]?.items || []) : [];


  /* ---------------------------------------------------------
       ğŸ“Œ æ›´æ–°å·¥ç¨‹è³‡æ–™ï¼ˆAdd / Delete / Editï¼‰
  --------------------------------------------------------- */
  const updateProjectItems = newItems => {
    if (!activeProject) return;

    const updated = {
      ...projects,
      [activeProject]: {
        ...projects[activeProject],
        items: newItems,
        manual,
        profitRate,
        marginRate
      }
    };

    setProjects(updated);
    saveProjects(updated);
  };

  /* æ–°å¢ */
  const addItem = item => {
    const newList = [...currentItems, item];
    updateProjectItems(newList);
  };

  /* åˆªé™¤ */
  const deleteItem = id => {
    const newList = currentItems.filter(x => x.id !== id);
    updateProjectItems(newList);
  };

  /* ä¿®æ”¹ */
  const updateItem = (id, data) => {
    const newList = currentItems.map(x => x.id === id ? { ...x, ...data } : x);
    updateProjectItems(newList);
  };


  /* ---------------------------------------------------------
       ğŸ“Œ åŒ¯å‡º Excelï¼ˆå‘¼å«å·¥å…·ï¼‰
  --------------------------------------------------------- */
  const exportExcelFile = () => {
    if (!activeProject) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹");

    const items = currentItems;

    const format = type =>
      items
        .filter(x => x.type === type)
        .map(x => ({
          åç¨±: x.name || x.category,
          è¦æ ¼: x.spec,
          æ•¸é‡: x.qty,
          å–®åƒ¹: x.unitPrice,
          å°è¨ˆ: x.subtotal
        }));

    exportExcel({
      projectName: activeProject,
      material: format("ææ–™"),
      purchase: format("å¸‚è³¼å“"),
      fabricate: format("è£½ä½œ"),
      transport: format("é‹è¼¸"),
      install: format("å®‰è£"),
      summary: [{
        å·¥ç¨‹åç¨±: activeProject,
        æ‰‹å‹•èª¿æ•´: manual,
        åˆ©ç®¡æ¯”: profitRate + "%",
        æ¯›åˆ©ç‡: marginRate + "%"
      }]
    });
  };


  /* ---------------------------------------------------------
       ğŸ“Œ Render UI
  --------------------------------------------------------- */
  return (
    <div>

      {/* å·¥ç¨‹é¸æ“‡åˆ— */}
      <div className="no-print bg-white shadow p-3 flex items-center gap-3">

        <button
          className="px-4 py-2 bg-blue-600 text-white rounded"
          onClick={createProject}
        >
          â• æ–°å·¥ç¨‹
        </button>

        <select
          className="border p-2 rounded"
          value={activeProject}
          onChange={e => switchProject(e.target.value)}
        >
          <option value="">è«‹é¸æ“‡å·¥ç¨‹</option>
          {Object.keys(projects).map(name => (
            <option key={name}>{name}</option>
          ))}
        </select>

        {activeProject && (
          <button
            className="px-3 py-1 bg-red-500 text-white rounded"
            onClick={() => removeProject(activeProject)}
          >
            åˆªé™¤å·¥ç¨‹
          </button>
        )}

        <button
          onClick={exportExcelFile}
          className="px-4 py-2 bg-emerald-600 text-white rounded ml-auto"
        >
          ğŸ“¤ åŒ¯å‡º Excel
        </button>
      </div>

      {/* åˆ†é  Tabs */}
      <TopTabs active={activeTab} setActive={setActiveTab} />

      {/* ä¸»å…§å®¹ */}
      <div>
        {activeTab === "mat" && (
          <MaterialCalc
            db={matDB}
            items={currentItems}
            addItem={addItem}
            deleteItem={deleteItem}
            updateItem={updateItem}
          />
        )}

        {activeTab === "pur" && (
          <PurchaseCalc
            db={purDB}
            items={currentItems}
            addItem={addItem}
            deleteItem={deleteItem}
            updateItem={updateItem}
          />
        )}

        {activeTab === "fab" && (
          <FabricateCalc
            db={fabDB}
            items={currentItems}
            addItem={addItem}
            deleteItem={deleteItem}
            updateItem={updateItem}
          />
        )}

        {activeTab === "tra" && (
          <TransportCalc
            db={traDB}
            items={currentItems}
            addItem={addItem}
            deleteItem={deleteItem}
            updateItem={updateItem}
          />
        )}

        {activeTab === "ins" && (
          <InstallCalc
            db={insDB}
            items={currentItems}
            addItem={addItem}
            deleteItem={deleteItem}
            updateItem={updateItem}
          />
        )}

        {activeTab === "sum" && (
          <SummaryPage
            items={currentItems}
            projectName={activeProject}
            manual={manual}
            setManual={setManual}
            profitRate={profitRate}
            setProfitRate={setProfitRate}
            marginRate={marginRate}
            setMarginRate={setMarginRate}
          />
        )}
      </div>
    </div>
  );
}


/* ---------------------------------------------------------
   ğŸ“Œ ReactDOM æ¸²æŸ“ï¼ˆå…¥å£ï¼‰
--------------------------------------------------------- */
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>

</body>
</html>
