<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>工程五大成本試算系統（C-2 版）</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js + DataLabels 插件 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- Excel 匯出用 SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { background-color: #f3f4f6; }
    .print-hidden { display: block; }
    @media print {
      .print-hidden { display: none !important; }
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- React Root -->
  <div id="root"></div>

  <!-- Main Application Script -->
  <script type="text/babel">

/****************************************************
 * PART 1 — 全域常數、工具函式（含金額千分位表示）
 ****************************************************/

// Google Sheet CSV URLs
const CSV_URLS = {
  material: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",
  purchase: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",
  fabrication: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",
  transport: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",
  install: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv"
};

// 金額千分位格式化
function formatMoney(num) {
  if (isNaN(num)) return "0";
  return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// 重量小數兩位
function formatWeight(num) {
  if (isNaN(num)) return "0.00";
  return Number(num).toFixed(2);
}

// CSV 解析
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim());
    return obj;
  });
}
/****************************************************
 * PART 2 — 多工程管理 ProjectManager（第 2 段）
 ****************************************************/

// 多工程管理
function ProjectManager({ currentProject, setCurrentProject, projects, setProjects }) {

  // 新增工程
  function addProject() {
    const name = prompt("請輸入工程名稱：");
    if (!name) return;

    if (projects[name]) {
      alert("工程名稱已存在！");
      return;
    }

    const updated = {
      ...projects,
      [name]: {
        allItems: [],
        manualAdjust: 0   // ★ 正確寫法
      }
    };

    setProjects(updated);
    setCurrentProject(name);
    saveProjects(updated);
  }

  // 刪除工程
  function deleteProject(name) {
    if (!window.confirm(`確定刪除工程「${name}」？`)) return;

    const updated = { ...projects };
    delete updated[name];

    const next = Object.keys(updated)[0] || "";
    setProjects(updated);
    setCurrentProject(next);
    saveProjects(updated);
  }

  return (
    <div className="bg-white p-4 rounded shadow mb-4 print-hidden">
      <h2 className="text-lg font-bold mb-3">工程管理</h2>

      <div className="flex flex-wrap gap-2">

        {Object.keys(projects).map(key => (
          <button
            key={key}
            onClick={() => setCurrentProject(key)}
            className={
              "px-3 py-1 rounded border " +
              (currentProject === key
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {key}
          </button>
        ))}

        <button
          onClick={addProject}
          className="px-3 py-1 rounded bg-green-600 text-white font-bold"
        >
          ＋ 新增工程
        </button>

        {currentProject && (
          <button
            onClick={() => deleteProject(currentProject)}
            className="px-3 py-1 rounded bg-red-600 text-white"
          >
            刪除目前工程
          </button>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * PART 4 — MaterialsPage（新版，無模式選單）
 * 自動判斷是否為板材（分類含「板」）
 * 板材公式：
 *   重量 = L(m) × W(m) × unitWeight(kg/m²) × pcs
 * 型鋼公式：
 *   重量 = 長度(m) × qty × unitWeight(kg/m)
 ****************************************************/

function MaterialsPage({ materialDB, addItemToProject, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");

  // 板材輸入
  const [L, setL] = React.useState("");
  const [W, setW] = React.useState("");
  const [pcs, setPcs] = React.useState("");

  // 型鋼輸入
  const [lenVal, setLenVal] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類選項
  const categories = React.useMemo(() => {
    const s = new Set();
    materialDB.forEach(r => s.add(r.category));
    return [...s];
  }, [materialDB]);

  // 取得規格
  const specs = React.useMemo(() => {
    return materialDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, materialDB]);

  // 選到的資料列
  const selectedRow = React.useMemo(() => {
    return materialDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, materialDB]);

  // 自動判斷是否為板材（包含「板」）
  const isPlate = React.useMemo(() => {
    if (!category) return false;
    return category.includes("板");  // ★ 依你的指定
  }, [category]);

  // 計算重量 & 小計
  let weight = 0;
  let subtotal = 0;
  if (selectedRow) {
    const unitWeight = parseFloat(selectedRow.weight || 0);
    const unitPrice = parseFloat(selectedRow.price || 0);

    if (isPlate) {
      const Lm = parseFloat(L || 0);
      const Wm = parseFloat(W || 0);
      const P = parseFloat(pcs || 0);
      weight = Lm * Wm * unitWeight * P;
    } else {
      const len = parseFloat(lenVal || 0);
      const q = parseFloat(qty || 0);
      weight = len * q * unitWeight;
    }

    subtotal = weight * unitPrice;
  }

  function addToList() {
    if (!category || !spec) {
      alert("請選擇分類與規格");
      return;
    }

    if (isPlate && (!L || !W || !pcs)) {
      alert("板材請輸入 L / W / 片數");
      return;
    }

    if (!isPlate && (!lenVal || !qty)) {
      alert("型鋼請輸入長度 / 支數");
      return;
    }

    const item = {
      type: "材料",
      category,
      spec,
      isPlate,
      L, W, pcs,
      lenVal, qty,
      weight: parseFloat(weight.toFixed(2)),
      price: selectedRow ? selectedRow.price : 0,
      subtotal: Math.round(subtotal)
    };

    // 寫入工程資料
    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    // 清空欄位
    setL(""); setW(""); setPcs("");
    setLenVal(""); setQty("");
  }

  // 材料專屬明細表
  const materialItems = projectData.allItems.filter(i => i.type === "材料");

  const totalWeight = materialItems.reduce((sum, i) => sum + (i.weight || 0), 0);

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">材料成本（自動辨識板材 / 型鋼）</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* 規格 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">規格：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">請選擇規格</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* 自動顯示：板材 or 型鋼欄位 */}
      {spec && (
        <div className="mb-3">
          <div className="text-blue-600 font-bold">
            自動判斷模式：{isPlate ? "板材（m × m）" : "型鋼（m × 支數）"}
          </div>
        </div>
      )}

      {/* 板材輸入 */}
      {isPlate && spec && (
        <div className="grid grid-cols-3 gap-4 mb-4">
          <div>
            <label className="font-bold">長度 L (m)：</label>
            <input value={L} onChange={e => setL(e.target.value)} className="border px-2 py-1 w-full rounded" />
          </div>
          <div>
            <label className="font-bold">寬度 W (m)：</label>
            <input value={W} onChange={e => setW(e.target.value)} className="border px-2 py-1 w-full rounded" />
          </div>
          <div>
            <label className="font-bold">片數 pcs：</label>
            <input value={pcs} onChange={e => setPcs(e.target.value)} className="border px-2 py-1 w-full rounded" />
          </div>
        </div>
      )}

      {/* 型鋼輸入 */}
      {!isPlate && spec && (
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label className="font-bold">長度 (m)：</label>
            <input value={lenVal} onChange={e => setLenVal(e.target.value)} className="border px-2 py-1 w-full rounded" />
          </div>
          <div>
            <label className="font-bold">支數：</label>
            <input value={qty} onChange={e => setQty(e.target.value)} className="border px-2 py-1 w-full rounded" />
          </div>
        </div>
      )}

      {/* 結果顯示 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          <div>重量：<b>{weight.toFixed(2)}</b> kg</div>
          <div>小計：<b>{subtotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</b> 元</div>
        </div>
      )}

      {/* 加入明細表 */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入成本明細表
      </button>

      {/* 材料明細表 */}
      <h3 className="text-lg font-bold mt-6 mb-2">材料成本明細</h3>
      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">分類</th>
            <th className="border px-2 py-1">規格</th>
            <th className="border px-2 py-1">重量(kg)</th>
            <th className="border px-2 py-1">小計(元)</th>
          </tr>
        </thead>
        <tbody>
          {materialItems.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.weight.toFixed(2)}</td>
              <td className="border px-2 py-1">
                {i.subtotal.toLocaleString()}
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      {/* 總重量 */}
      <div className="font-bold text-right">
        材料總重量：{totalWeight.toFixed(2)} kg
      </div>
    </div>
  );
}
/****************************************************
 * PART 5 — PurchasePage（市購品）
 * - 選分類 → 規格
 * - 顯示單位 / 單價
 * - 數量 × 單價 → 小計
 * - 加入成本明細表
 ****************************************************/

function PurchasePage({ purchaseDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 分類選項
  const categories = React.useMemo(() => {
    const s = new Set();
    purchaseDB.forEach(r => s.add(r.category));
    return [...s];
  }, [purchaseDB]);

  // 規格選項
  const specs = React.useMemo(() => {
    return purchaseDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, purchaseDB]);

  // 選到資料
  const selectedRow = React.useMemo(() => {
    return purchaseDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, purchaseDB]);

  const price = selectedRow ? parseFloat(selectedRow.price || 0) : 0;
  const subtotal = Math.round(price * parseFloat(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("請選擇分類與品項");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "市購品",
      category,
      spec,
      qty: Number(qty),
      price,
      subtotal
    };

    // 加入工程資料
    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "市購品");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">市購品</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* 規格 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">品項：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇品項</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* 單價 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{price.toLocaleString()}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            value={qty}
            type="number"
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：
          <b>{subtotal.toLocaleString()}</b> 元
        </div>
      )}

      {/* 加入明細 */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入成本明細表
      </button>

      {/* 明細表 */}
      <h3 className="mt-6 mb-2 text-lg font-bold">市購品明細</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">分類</th>
            <th className="border px-2 py-1">品項</th>
            <th className="border px-2 py-1">數量</th>
            <th className="border px-2 py-1">小計</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 6 — FabricationPage（製作成本）
 * - 選分類 → 項目
 * - 顯示單位 / 單價
 * - 數量 × 單價 → 小計
 * - 加入成本明細表
 ****************************************************/

function FabricationPage({ fabricationDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類
  const categories = React.useMemo(() => {
    const set = new Set();
    fabricationDB.forEach(r => set.add(r.category));
    return [...set];
  }, [fabricationDB]);

  // 依分類得到項目（spec）
  const specs = React.useMemo(() => {
    return fabricationDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, fabricationDB]);

  // 選到項目
  const selectedRow = React.useMemo(() => {
    return fabricationDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, fabricationDB]);

  const unitPrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(unitPrice * Number(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("請選擇分類與項目");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "製作成本",
      category,
      spec,
      qty: Number(qty),
      price: unitPrice,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "製作成本");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">製作成本</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* 項目 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">項目：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">請選擇項目</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* 單價顯示 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{unitPrice.toLocaleString()}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 ml-2 w-32 rounded"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：<b>{subtotal.toLocaleString()}</b> 元
        </div>
      )}

      {/* 加入明細 */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入成本明細表
      </button>

      {/* 明細表 */}
      <h3 className="mt-6 mb-2 text-lg font-bold">製作成本明細</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">分類</th>
            <th className="border px-2 py-1">項目</th>
            <th className="border px-2 py-1">數量</th>
            <th className="border px-2 py-1">小計</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 7 — TransportPage（運輸費用）
 * - 選分類 → 項目
 * - 顯示地區、單位、單價
 * - 數量 × 單價 → 小計
 * - 加入成本明細表
 ****************************************************/

function TransportPage({ transportDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類
  const categories = React.useMemo(() => {
    const s = new Set();
    transportDB.forEach(r => s.add(r.category));
    return [...s];
  }, [transportDB]);

  // 規格
  const specs = React.useMemo(() => {
    return transportDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, transportDB]);

  // 選到的資料
  const selectedRow = React.useMemo(() => {
    return transportDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, transportDB]);

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(price * Number(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("請選擇分類與項目");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "運輸費用",
      category,
      spec,
      region: selectedRow?.region || "",
      qty: Number(qty),
      price,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "運輸費用");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">運輸費用</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">車種 / 分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">請選擇</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* 項目 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">項目：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">請選擇項目</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* 顯示地區、單價 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>地區：{selectedRow.region || "—"}</div>
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{price.toLocaleString()}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 ml-2 rounded w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：<b>{subtotal.toLocaleString()}</b> 元
        </div>
      )}

      {/* 加入明細 */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入成本明細表
      </button>

      {/* 明細表 */}
      <h3 className="mt-6 mb-2 text-lg font-bold">運輸費用明細</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">分類</th>
            <th className="border px-2 py-1">項目</th>
            <th className="border px-2 py-1">地區</th>
            <th className="border px-2 py-1">數量</th>
            <th className="border px-2 py-1">小計</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.region}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 8 — InstallPage（現場安裝）
 * - 選分類 → 規格
 * - 顯示單位 / 單價
 * - 數量 × 單價 → 小計
 * - 加入成本明細表
 ****************************************************/

function InstallPage({ installDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類清單
  const categories = React.useMemo(() => {
    const s = new Set();
    installDB.forEach(r => s.add(r.category));
    return [...s];
  }, [installDB]);

  // 取得規格清單
  const specs = React.useMemo(() => {
    return installDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, installDB]);

  // 選中的資料列
  const selectedRow = React.useMemo(() => {
    return installDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, installDB]);

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(price * Number(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("請選擇分類與項目");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "現場安裝",
      category,
      spec,
      qty: Number(qty),
      price,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "現場安裝");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">現場安裝</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">請選擇</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* 規格 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">規格：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇規格</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* 單價顯示 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{price.toLocaleString()}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：
          <b>{subtotal.toLocaleString()}</b> 元
        </div>
      )}

      {/* 加入明細 */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入成本明細表
      </button>

      {/* 安裝明細表 */}
      <h3 className="mt-6 mb-2 text-lg font-bold">現場安裝明細</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">分類</th>
            <th className="border px-2 py-1">規格</th>
            <th className="border px-2 py-1">數量</th>
            <th className="border px-2 py-1">小計</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 9 — SummaryPage（總表）
 * 五大成本加總 + 人工調整 + 管銷 + 毛利 + 圓餅圖
 * 列印 + 匯出 Excel
 ****************************************************/

function SummaryPage({ projectData, setProjectData }) {
  const chartRef = React.useRef(null);
  const chartInstance = React.useRef(null);

  // 五大類統計
  const sumByType = type =>
    projectData.allItems
      .filter(i => i.type === type)
      .reduce((a, b) => a + (b.subtotal || 0), 0);

  const materialSum = sumByType("材料");
  const purchaseSum = sumByType("市購品");
  const fabSum = sumByType("製作成本");
  const transSum = sumByType("運輸費用");
  const installSum = sumByType("現場安裝");

  const fiveTotal = materialSum + purchaseSum + fabSum + transSum + installSum;

  const manualAdjust = projectData.manualAdjust || 0;

  const finalCost = fiveTotal + manualAdjust;

  const [adminRate, setAdminRate] = React.useState(15);
  const [profitRate, setProfitRate] = React.useState(35);

  const adminFee = Math.round(finalCost * (adminRate / 100));
  const suggestPrice = Math.round(
    (finalCost + adminFee) / (1 - profitRate / 100)
  );

  // 建立圓餅圖
  React.useEffect(() => {
    const ctx = chartRef.current.getContext("2d");

    if (chartInstance.current) chartInstance.current.destroy();

    chartInstance.current = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["材料", "市購品", "製作", "運輸", "安裝"],
        datasets: [
          {
            data: [materialSum, purchaseSum, fabSum, transSum, installSum],
            backgroundColor: [
              "#4B9CD3",
              "#71C285",
              "#F7B267",
              "#E76F51",
              "#6C5CE7"
            ]
          }
        ]
      },
      options: {
        plugins: {
          datalabels: {
            formatter: (value, ctx) => {
              const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              const pct = ((value / total) * 100).toFixed(1);
              return `${pct}%`;
            },
            color: "#fff",
            font: { weight: "bold", size: 14 }
          },
          legend: { position: "bottom" }
        }
      }
    });
  }, [materialSum, purchaseSum, fabSum, transSum, installSum]);

  // 匯出 Excel（使用 SheetJS）
  function exportExcel() {
    const wb = XLSX.utils.book_new();

    function addSheet(name, rows) {
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, name);
    }

    const addRows = type =>
      projectData.allItems
        .filter(i => i.type === type)
        .map(i => ({
          分類: i.category,
          規格: i.spec,
          數量: i.qty,
          單價: i.price,
          小計: i.subtotal
        }));

    addSheet("材料", addRows("材料"));
    addSheet("市購品", addRows("市購品"));
    addSheet("製作成本", addRows("製作成本"));
    addSheet("運輸費用", addRows("運輸費用"));
    addSheet("現場安裝", addRows("現場安裝"));

    addSheet("總表", [
      { 項目: "五大成本合計", 金額: fiveTotal },
      { 項目: "人工調整", 金額: manualAdjust },
      { 項目: "最終成本", 金額: finalCost },
      { 項目: "管銷(%)", 金額: adminRate },
      { 項目: "管銷費", 金額: adminFee },
      { 項目: "毛利率(%)", 金額: profitRate },
      { 項目: "建議售價", 金額: suggestPrice }
    ]);

    XLSX.writeFile(wb, "成本彙整表.xlsx");
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">總表 Summary</h2>

      {/* 圓餅圖 */}
      <div className="flex justify-center my-4">
        <canvas ref={chartRef} width="260" height="260"></canvas>
      </div>

      {/* 五大成本列表 */}
      <table className="w-full border mb-6">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">項目</th>
            <th className="border px-2 py-1">金額</th>
            <th className="border px-2 py-1">人工調整</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td className="border px-2 py-1">材料成本</td>
            <td className="border px-2 py-1">{materialSum.toLocaleString()}</td>
            <td rowSpan="5" className="border px-2 py-1 align-top">
              <input
                type="number"
                value={manualAdjust}
                onChange={e =>
                  setProjectData({
                    ...projectData,
                    manualAdjust: Number(e.target.value)
                  })
                }
                className="border p-1 w-32"
              />
            </td>
          </tr>

          <tr>
            <td className="border px-2 py-1">市購品</td>
            <td className="border px-2 py-1">{purchaseSum.toLocaleString()}</td>
          </tr>

          <tr>
            <td className="border px-2 py-1">製作成本</td>
            <td className="border px-2 py-1">{fabSum.toLocaleString()}</td>
          </tr>

          <tr>
            <td className="border px-2 py-1">運輸費用</td>
            <td className="border px-2 py-1">{transSum.toLocaleString()}</td>
          </tr>

          <tr>
            <td className="border px-2 py-1">現場安裝</td>
            <td className="border px-2 py-1">{installSum.toLocaleString()}</td>
          </tr>
        </tbody>
      </table>

      {/* 成本合計 */}
      <div className="text-lg font-bold mb-2">
        五大成本合計：{fiveTotal.toLocaleString()} 元
      </div>

      <div className="text-lg font-bold mb-2">
        最終成本（含人工調整）：{finalCost.toLocaleString()} 元
      </div>

      {/* 管銷 */}
      <div className="mb-4">
        <label className="font-bold">管銷(%)：</label>
        <input
          value={adminRate}
          onChange={e => setAdminRate(Number(e.target.value))}
          type="number"
          className="border p-1 w-20 ml-2"
        />
        <span className="ml-4">管銷費：<b>{adminFee.toLocaleString()}</b> 元</span>
      </div>

      {/* 毛利率 */}
      <div className="mb-4">
        <label className="font-bold">毛利率(%)：</label>
        <input
          value={profitRate}
          onChange={e => setProfitRate(Number(e.target.value))}
          type="number"
          className="border p-1 w-20 ml-2"
        />
        <span className="ml-4">建議售價：<b>{suggestPrice.toLocaleString()}</b> 元</span>
      </div>

      {/* 按鈕 */}
      <div className="flex gap-4 mt-6">
        <button
          onClick={() => window.print()}
          className="px-4 py-2 bg-gray-700 text-white rounded"
        >
          列印
        </button>

        <button
          onClick={exportExcel}
          className="px-4 py-2 bg-green-600 text-white rounded"
        >
          匯出 Excel
        </button>
      </div>
    </div>
  );
}
/****************************************************
 * PART 10 — App（主控制）
 * - 多工程管理
 * - Google Sheet 同步
 * - 分頁切換
 * - 渲染五大成本頁 + SummaryPage
 ****************************************************/
function App() {
  const [projects, setProjects] = React.useState(loadProjects());
  const [currentProject, setCurrentProject] = React.useState(
    Object.keys(projects)[0] || ""
  );

  // 頁面切換
  const [page, setPage] = React.useState("材料");

  // 五大資料庫
  const [materialDB, setMaterialDB] = React.useState([]);
  const [purchaseDB, setPurchaseDB] = React.useState([]);
  const [fabricationDB, setFabricationDB] = React.useState([]);
  const [transportDB, setTransportDB] = React.useState([]);
  const [installDB, setInstallDB] = React.useState([]);

  // Google Sheet + localStorage 同步（模式 C）
  async function fetchCSV(url) {
    const text = await fetch(url).then(r => r.text());
    const rows = text.split("\n").map(r => r.trim());
    const version = `${rows.length}-${rows[0]}-${rows[rows.length - 1]}`;
    return { rows, version };
  }

  async function loadDB(name, url, setter) {
    const local = localStorage.getItem("db_" + name);
    const localV = localStorage.getItem("dbv_" + name);

    const { rows, version } = await fetchCSV(url);

    if (local && localV === version) {
      setter(JSON.parse(local));
    } else {
      const parsed = rows
        .slice(1)
        .map(r => r.split(","))
        .filter(r => r.length >= 3)
        .map(r => ({
          category: r[0],
          spec: r[1],
          unit: r[2],
          price: Number(r[3]),
          density: Number(r[4] || 0),
          region: r[5] || ""
        }));

      setter(parsed);
      localStorage.setItem("db_" + name, JSON.stringify(parsed));
      localStorage.setItem("dbv_" + name, version);
      localStorage.setItem("dbts_" + name, new Date().toISOString());
    }
  }

// 初始化，載入五大資料庫
React.useEffect(() => {
  loadDB("material", CSV_URLS.material, setMaterialDB);
  loadDB("purchase", CSV_URLS.purchase, setPurchaseDB);
  loadDB("fabrication", CSV_URLS.fabrication, setFabricationDB);
  loadDB("transport", CSV_URLS.transport, setTransportDB);
  loadDB("install", CSV_URLS.install, setInstallDB);
}, []);

  // 取得目前工程資料
  const projectData = projects[currentProject] || {
    allItems: [],
    manualAdjust: 0
  };

  // 更新目前工程資料
  function updateProjectData(newData) {
    const updated = {
      ...projects,
      [currentProject]: newData
    };
    setProjects(updated);
    saveProjects(updated);
  }

  return (
    <div className="p-4 max-w-5xl mx-auto">

      {/* 工程管理 */}
      <ProjectManager
        currentProject={currentProject}
        setCurrentProject={setCurrentProject}
        projects={projects}
        setProjects={setProjects}
      />

      {/* 分頁功能 */}
      <div className="flex gap-2 mb-4">
        {["材料", "市購品", "製作成本", "運輸費用", "現場安裝", "總表"].map(tab => (
          <button
            key={tab}
            onClick={() => setPage(tab)}
            className={
              "px-3 py-1 rounded border " +
              (page === tab
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {tab}
          </button>
        ))}
      </div>

      {/* 頁面內容 */}
      {page === "材料" && (
        <MaterialsPage
          materialDB={materialDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "市購品" && (
        <PurchasePage
          purchaseDB={purchaseDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "製作成本" && (
        <FabricationPage
          fabricationDB={fabricationDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "運輸費用" && (
        <TransportPage
          transportDB={transportDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "現場安裝" && (
        <InstallPage
          installDB={installDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "總表" && (
        <SummaryPage
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}
    </div>
  );
}
/****************************************************
 * 渲染 App
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>  <!-- ←←← 這個結束 script 是整站能否正常渲染的關鍵 -->
</body>
</html>
