<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ç¨‹äº”å¤§æˆæœ¬è©¦ç®—ç³»çµ±ï¼ˆå¤šå·¥ç¨‹ç‰ˆï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #f3f4f6; }
    .no-print { display: block; }

    @media print {
      .no-print { display: none !important; }
    }

    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal-box {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 900px;
      border-radius: 12px;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- Google Sheet CSV å·¥å…· -->
  <script>
    const fetchCSV = async (url) => {
      const r = await fetch(url);
      const t = await r.text();
      return t.trim().split("\n").map(line =>
        line.split(",").map(c => c.replace(/^"|"$/g, ""))
      );
    };
  </script>

  <!-- React ä¸»ç¨‹å¼ -->
  <script type="text/babel">
/* ============================================================
    LocalStorage åŸºæœ¬å·¥å…·
============================================================ */
const loadDB = (key, def) => {
  const d = localStorage.getItem(key);
  return d ? JSON.parse(d) : def;
};

const saveDB = (key, val) =>
  localStorage.setItem(key, JSON.stringify(val));

/* ============================================================
    é¡¯ç¤ºæ™‚é–“æ ¼å¼åŒ–ï¼ˆé¡¯ç¤ºåŒæ­¥æ™‚é–“ï¼‰
============================================================ */
const formatSyncTime = (msStr) => {
  if (!msStr) return "å°šæœªåŒæ­¥";
  const t = Number(msStr);
  if (!t) return "å°šæœªåŒæ­¥";
  const d = new Date(t);
  const Y = d.getFullYear();
  const M = String(d.getMonth() + 1).padStart(2, "0");
  const D = String(d.getDate()).padStart(2, "0");
  const h = String(d.getHours()).padStart(2, "0");
  const m = String(d.getMinutes()).padStart(2, "0");
  return `${Y}-${M}-${D} ${h}:${m}`;
};

/* ============================================================
    Google Sheet å¿«å–è¨­å®š
============================================================ */
const SHEET_CACHE_MAX_AGE = 1000 * 60 * 10; // 10 åˆ†é˜

const isSheetCacheExpired = (key) => {
  const ts = Number(localStorage.getItem(key) || 0);
  if (!ts) return true;
  return Date.now() - ts > SHEET_CACHE_MAX_AGE;
};

/* ============================================================
    å…±ç”¨ Modalï¼ˆå½ˆçª—ï¼‰
============================================================ */
const Modal = ({ title, onClose, children }) => (
  <div className="modal-bg">
    <div className="modal-box relative">
      <button
        className="absolute right-3 top-3 text-xl font-bold"
        onClick={onClose}
      >
        âœ–
      </button>
      <h2 className="text-2xl font-bold mb-4">{title}</h2>
      {children}
    </div>
  </div>
);
/* ============================================================
   â˜…â˜…â˜… å¤šå·¥ç¨‹æ ¸å¿ƒè³‡æ–™çµæ§‹ï¼ˆprojectsï¼‰
   æ¯å€‹å·¥ç¨‹æœƒæœ‰ï¼š
   - nameï¼ˆå·¥ç¨‹åç¨±ï¼‰
   - allItemsï¼ˆäº”å¤§æˆæœ¬æ˜ç´°ï¼‰
   - manualAdjustï¼ˆäº”é …æ‰‹å‹•èª¿æ•´é‡‘é¡ï¼‰
============================================================ */

const DEFAULT_PROJECT = () => ({
  name: "æœªå‘½åå·¥ç¨‹",
  allItems: [],
  manualAdjust: {
    material: 0,
    purchase: 0,
    fabricate: 0,
    transport: 0,
    install: 0,
  },
});

// å–å¾—æ‰€æœ‰å·¥ç¨‹ï¼ˆå¾ localStorageï¼‰
const loadProjects = () => {
  try {
    const raw = JSON.parse(localStorage.getItem("PROJECT_LIST"));
    if (raw && Array.isArray(raw) && raw.length > 0) return raw;
  } catch {}
  return [DEFAULT_PROJECT()];
};

// å„²å­˜å…¨éƒ¨å·¥ç¨‹
const saveProjects = (projects) => {
  localStorage.setItem("PROJECT_LIST", JSON.stringify(projects));
};
/* ============================================================
   ğŸ—‚ å·¥ç¨‹åˆ‡æ› UIï¼ˆä¸Šæ–¹æŒ‰éˆ•åˆ— ProjectSwitcherï¼‰
   - é¡¯ç¤ºæ‰€æœ‰å·¥ç¨‹æŒ‰éˆ•
   - é»æŒ‰å¯åˆ‡æ›å·¥ç¨‹
   - å¯æ–°å¢å·¥ç¨‹
============================================================ */

const ProjectSwitcher = ({ projects, currentIndex, setCurrentIndex, addProject }) => {
  return (
    <div className="flex gap-2 mb-4 no-print">

      {projects.map((p, idx) => (
        <button
          key={idx}
          className={`px-3 py-1 rounded border text-sm ${
            currentIndex === idx ? "bg-blue-600 text-white" : "bg-white"
          }`}
          onClick={() => setCurrentIndex(idx)}
        >
          {p.name || `å·¥ç¨‹ ${idx + 1}`}
        </button>
      ))}

      {/* â• æ–°å¢å·¥ç¨‹ */}
      <button
        className="px-3 py-1 rounded border bg-green-600 text-white text-sm"
        onClick={addProject}
      >
        â• æ–°å·¥ç¨‹
      </button>

    </div>
  );
};
/* ============================================================
   ğŸ· å·¥ç¨‹åç¨± Headerï¼ˆå¯ç·¨è¼¯ï¼‰
============================================================ */
const ProjectHeader = ({ project, renameProject }) => {
  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">

      <label className="font-bold mr-2">å·¥ç¨‹åç¨±ï¼š</label>

      <input
        className="border p-2 rounded w-64"
        value={project.name}
        onChange={(e) => renameProject(e.target.value)}
        placeholder="è¼¸å…¥å·¥ç¨‹åç¨±..."
      />
    </div>
  );
};
/* ============================================================
   ğŸ“Œ ä¸»ç¨‹å¼ App() â€”â€” å¤šå·¥ç¨‹ + äº”å¤§æˆæœ¬è³‡æ–™ç®¡ç†
============================================================ */
const App = () => {

  /* ============================================================
     â‘  æ‰€æœ‰å·¥ç¨‹ï¼ˆå¤šå·¥ç¨‹ç¸½è³‡æ–™ï¼‰
  ============================================================ */
  const [projects, setProjects] = React.useState(loadProjects());

  /* ç›®å‰å·¥ç¨‹çš„ index */
  const [curIndex, setCurIndex] = React.useState(0);

  /* å–å¾—ç›®å‰å·¥ç¨‹ç‰©ä»¶ */
  const cur = projects[curIndex];

  /* ============================================================
     â‘¡ å·¥ç¨‹åˆ‡æ›
  ============================================================ */
  const switchProject = (idx) => {
    setCurIndex(idx);
  };

  /* ============================================================
     â‘¢ æ–°å¢å·¥ç¨‹
  ============================================================ */
  const addProject = () => {
    const name = `å·¥ç¨‹ ${projects.length + 1}`;

    const next = [
      ...projects,
      {
        name,
        materialDB: [],
        purchaseDB: [],
        fabricateDB: [],
        transportDB: [],
        installDB: [],
        allItems: [],
        manualAdjust: {
          material: 0,
          purchase: 0,
          fabricate: 0,
          transport: 0,
          install: 0,
        },
      },
    ];

    setProjects(next);
    saveProjects(next);
    setCurIndex(next.length - 1); // ç›´æ¥åˆ‡åˆ°æ–°å·¥ç¨‹
  };

  /* ============================================================
     â‘£ åˆªé™¤å·¥ç¨‹
  ============================================================ */
  const deleteProject = (idx) => {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å·¥ç¨‹å—ï¼Ÿ")) return;

    let next = projects.filter((_, i) => i !== idx);
    if (next.length === 0) next = [DEFAULT_PROJECT()];

    setProjects(next);
    saveProjects(next);
    setCurIndex(0);
  };

  /* ============================================================
     â‘¤ æ›´æ–°å·¥ç¨‹åç¨±
  ============================================================ */
  const renameProject = (newName) => {
    const next = [...projects];
    next[curIndex].name = newName;
    setProjects(next);
    saveProjects(next);
  };

  /* ============================================================
     â‘¥ æ›´æ–°å–®ä¸€å·¥ç¨‹å…§çš„äº”å¤§è³‡æ–™åº« / æ˜ç´°
  ============================================================ */

  // å­˜å–æ–¹ä¾¿ç”¨çš„å°å·¥å…·
  const updateCurProject = (patch) => {
    const next = [...projects];
    next[curIndex] = { ...next[curIndex], ...patch };
    setProjects(next);
    saveProjects(next);
  };

  // äº”å¤§è³‡æ–™åº«ï¼ˆæ›´æ–°æ™‚æœƒå¯«å›å·¥ç¨‹è³‡æ–™ï¼‰
  const setMaterialDB  = (v) => updateCurProject({ materialDB: v });
  const setPurchaseDB  = (v) => updateCurProject({ purchaseDB: v });
  const setFabricateDB = (v) => updateCurProject({ fabricateDB: v });
  const setTransportDB = (v) => updateCurProject({ transportDB: v });
  const setInstallDB   = (v) => updateCurProject({ installDB: v });

  // äº”å¤§æ˜ç´° allItems
  const addItem = (item) =>
    updateCurProject({ allItems: [...cur.allItems, item] });

  const deleteItem = (id) =>
    updateCurProject({
      allItems: cur.allItems.filter((x) => x.id !== id),
    });

  const updateItem = (id, patch) =>
    updateCurProject({
      allItems: cur.allItems.map((x) =>
        x.id === id ? { ...x, ...patch } : x
      ),
    });

  const clearAllItems = () => {
    if (!confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ˜ç´°ï¼Ÿ")) return;
    updateCurProject({ allItems: [] });
  };

  /* ============================================================
     â‘¦ æ‰‹å‹•èª¿æ•´é‡‘é¡ï¼ˆäº”å¤§æˆæœ¬ï¼‰
  ============================================================ */
  const setManualAdjust = (patch) =>
    updateCurProject({
      manualAdjust: { ...cur.manualAdjust, ...patch },
    });

  /* ============================================================
     â‘§ ç•«é¢ç”¨ Tab
  ============================================================ */
  const tabs = ["ææ–™", "å¸‚è³¼å“", "è£½ä½œæˆæœ¬", "é‹è¼¸è²»ç”¨", "ç¾å ´å®‰è£", "ç¸½è¡¨"];
  const [tab, setTab] = React.useState("ææ–™");

  /* ============================================================
     â‘¨ é‡æ–°åŒæ­¥è³‡æ–™åº«ï¼ˆGoogle Sheetï¼‰
     é€™è£¡åªæ˜¯è§¸ç™¼äº‹ä»¶ï¼Œå¾Œé¢ç¬¬ 7 æ®µæœƒåŠ å…¥çœŸæ­£é‚è¼¯
  ============================================================ */
  const [sheetTick, setSheetTick] = React.useState(0);
  const forceSyncAll = () => setSheetTick((v) => v + 1);

  /* ============================================================
     â‘© åŒ¯å‡º JSONï¼ˆå‚™ä»½ï¼‰
  ============================================================ */
  const handleExportJSON = () => {
    const blob = new Blob(
      [JSON.stringify(projects, null, 2)],
      { type: "application/json" }
    );
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "äº”å¤§æˆæœ¬_å…¨éƒ¨å·¥ç¨‹å‚™ä»½.json";
    a.click();
  };


/* ============================================================
   ğŸ“¦ 1ï¸âƒ£ ææ–™è©¦ç®— MaterialCalcï¼ˆå«ä¿®æ”¹ï¼åˆªé™¤ï¼‰
============================================================ */
const MaterialCalc = ({ db, addItem, items, deleteItem, updateItem }) => {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  const categories = [...new Set(db.map((x) => x.category))];
  const specs = db.filter((x) => x.category === category);

  const selected = specs.find((x) => x.spec === spec);
  const subtotal = selected ? selected.price * Number(qty || 0) : 0;

  const add = () => {
    if (!selected || !qty) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

    addItem({
      id: Date.now(),
      type: "ææ–™",
      category,
      spec,
      qty: Number(qty),
      unit: selected.unit,
      unitPrice: selected.price,
      subtotal,
    });

    setSpec("");
    setQty("");
  };

  const matItems = items.filter((x) => x.type === "ææ–™");

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">

      <h2 className="text-xl font-bold mb-3">ğŸ§± ææ–™è©¦ç®—</h2>

      {/* é¸åˆ†é¡ */}
      <div className="mb-3">
        <label>åˆ†é¡ï¼š</label>
        <select
          className="border p-2 rounded ml-2"
          value={category}
          onChange={(e) => {
            setCategory(e.target.value);
            setSpec("");
          }}
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map((c) => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* è¦æ ¼ */}
      {category && (
        <div className="mb-3">
          <label>è¦æ ¼ï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={spec}
            onChange={(e) => setSpec(e.target.value)}
          >
            <option value="">è«‹é¸æ“‡</option>
            {specs.map((s) => (
              <option key={s.spec}>{s.spec}</option>
            ))}
          </select>
        </div>
      )}

      {/* æ•¸é‡ */}
      {spec && (
        <div className="mb-3">
          <label>æ•¸é‡ï¼š</label>
          <input
            className="border p-2 rounded ml-2 w-24"
            value={qty}
            onChange={(e) => setQty(e.target.value)}
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      <div className="text-xl font-bold text-right mt-3">
        å°è¨ˆï¼š<span className="text-blue-600">{subtotal.toFixed(0)}</span> å…ƒ
      </div>

      {subtotal > 0 && (
        <button
          className="mt-4 bg-emerald-600 text-white px-4 py-2 rounded"
          onClick={add}
        >
          â• åŠ å…¥ç¸½è¡¨
        </button>
      )}

      {/* æ˜ç´° */}
      {matItems.length > 0 && (
        <div className="mt-6">
          <h3 className="font-bold text-lg mb-2">ğŸ“‹ ææ–™æ˜ç´°</h3>

          <table className="w-full text-sm border">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-2">åˆ†é¡</th>
                <th className="p-2">è¦æ ¼</th>
                <th className="p-2">æ•¸é‡</th>
                <th className="p-2">å–®ä½</th>
                <th className="p-2">å–®åƒ¹</th>
                <th className="p-2">å°è¨ˆ</th>
                <th className="p-2">æ“ä½œ</th>
              </tr>
            </thead>

            <tbody>
              {matItems.map((it) => (
                <tr key={it.id} className="border-t">
                  <td className="p-2">{it.category}</td>
                  <td className="p-2">{it.spec}</td>

                  {/* æ•¸é‡å¯æ”¹ */}
                  <td className="p-2">
                    <input
                      className="border p-1 w-20"
                      value={it.qty}
                      onChange={(e) =>
                        updateItem(it.id, {
                          qty: Number(e.target.value),
                          subtotal: Number(e.target.value) * it.unitPrice,
                        })
                      }
                    />
                  </td>

                  <td className="p-2">{it.unit}</td>
                  <td className="p-2">{it.unitPrice}</td>
                  <td className="p-2">{it.subtotal}</td>

                  <td className="p-2">
                    <button
                      className="text-red-600"
                      onClick={() => deleteItem(it.id)}
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};


/* ============================================================
   ğŸ›’ 2ï¸âƒ£ å¸‚è³¼å“è©¦ç®— PurchaseCalc
============================================================ */
const PurchaseCalc = ({ db, addItem, items, deleteItem, updateItem }) => {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  const categories = [...new Set(db.map((x) => x.category))];
  const specs = db.filter((x) => x.category === category);

  const selected = specs.find((x) => x.spec === spec);
  const subtotal = selected ? selected.price * Number(qty || 0) : 0;

  const add = () => {
    if (!selected || !qty) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

    addItem({
      id: Date.now(),
      type: "å¸‚è³¼å“",
      category,
      spec,
      qty: Number(qty),
      unit: selected.unit,
      unitPrice: selected.price,
      subtotal,
    });

    setSpec("");
    setQty("");
  };

  const purItems = items.filter((x) => x.type === "å¸‚è³¼å“");

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">

      <h2 className="text-xl font-bold mb-3">ğŸ›’ å¸‚è³¼å“è©¦ç®—</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label>åˆ†é¡ï¼š</label>
        <select
          className="border p-2 rounded ml-2"
          value={category}
          onChange={(e) => {
            setCategory(e.target.value);
            setSpec("");
          }}
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map((c) => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* è¦æ ¼ */}
      {category && (
        <div className="mb-3">
          <label>è¦æ ¼ï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={spec}
            onChange={(e) => setSpec(e.target.value)}
          >
            <option value="">è«‹é¸æ“‡</option>
            {specs.map((s) => (
              <option key={s.spec}>{s.spec}</option>
            ))}
          </select>
        </div>
      )}

      {/* æ•¸é‡ */}
      {spec && (
        <div className="mb-3">
          <label>æ•¸é‡ï¼š</label>
          <input
            className="border p-2 rounded ml-2 w-24"
            value={qty}
            onChange={(e) => setQty(e.target.value)}
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      <div className="text-xl font-bold text-right mt-3">
        å°è¨ˆï¼š<span className="text-blue-600">{subtotal.toFixed(0)}</span> å…ƒ
      </div>

      {subtotal > 0 && (
        <button
          className="mt-4 bg-emerald-600 text-white px-4 py-2 rounded"
          onClick={add}
        >
          â• åŠ å…¥ç¸½è¡¨
        </button>
      )}

      {/* æ˜ç´° */}
      {purItems.length > 0 && (
        <div className="mt-6">
          <h3 className="font-bold text-lg mb-2">ğŸ“‹ å¸‚è³¼å“æ˜ç´°</h3>

          <table className="w-full border text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-2">åˆ†é¡</th>
                <th className="p-2">è¦æ ¼</th>
                <th className="p-2">æ•¸é‡</th>
                <th className="p-2">å–®ä½</th>
                <th className="p-2">å–®åƒ¹</th>
                <th className="p-2">å°è¨ˆ</th>
                <th className="p-2">æ“ä½œ</th>
              </tr>
            </thead>

            <tbody>
              {purItems.map((it) => (
                <tr key={it.id} className="border-t">
                  <td className="p-2">{it.category}</td>
                  <td className="p-2">{it.spec}</td>

                  <td className="p-2">
                    <input
                      className="border p-1 w-20"
                      value={it.qty}
                      onChange={(e) =>
                        updateItem(it.id, {
                          qty: Number(e.target.value),
                          subtotal: Number(e.target.value) * it.unitPrice,
                        })
                      }
                    />
                  </td>

                  <td className="p-2">{it.unit}</td>
                  <td className="p-2">{it.unitPrice}</td>
                  <td className="p-2">{it.subtotal}</td>

                  <td className="p-2">
                    <button
                      className="text-red-600"
                      onClick={() => deleteItem(it.id)}
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};


/* ============================================================
   ğŸ”§ 3ï¸âƒ£ è£½ä½œæˆæœ¬è©¦ç®—
============================================================ */
const FabricationCalc = ({ db, addItem, items, deleteItem, updateItem }) => {
  const [category, setCategory] = React.useState("");
  const [mode, setMode] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  const categories = [...new Set(db.map((x) => x.category))];
  const modes = db.filter((x) => x.category === category);
  const specs = db.filter((x) => x.category === category && x.mode === mode);

  const selected = specs.find((x) => x.spec === spec);
  const subtotal = selected ? selected.price * Number(qty || 0) : 0;

  const add = () => {
    if (!selected || !qty) return alert("è«‹å¡«å®Œæ•´è³‡æ–™");

    addItem({
      id: Date.now(),
      type: "è£½ä½œæˆæœ¬",
      category,
      mode,
      spec,
      qty: Number(qty),
      unit: selected.unit || "å¼",
      unitPrice: selected.price,
      subtotal,
    });

    setMode("");
    setSpec("");
    setQty("");
  };

  const fabItems = items.filter((x) => x.type === "è£½ä½œæˆæœ¬");

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">

      <h2 className="text-xl font-bold mb-3">ğŸ”§ è£½ä½œæˆæœ¬è©¦ç®—</h2>

      {/* é¸åˆ†é¡ */}
      <div className="mb-3">
        <label>åˆ†é¡ï¼š</label>
        <select
          className="border p-2 rounded ml-2"
          value={category}
          onChange={(e) => {
            setCategory(e.target.value);
            setMode("");
            setSpec("");
          }}
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map((c) => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* æ–¹å¼ */}
      {category && (
        <div className="mb-3">
          <label>æ–¹å¼ï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={mode}
            onChange={(e) => {
              setMode(e.target.value);
              setSpec("");
            }}
          >
            <option value="">è«‹é¸æ“‡</option>
            {modes.map((m) => (
              <option key={m.mode}>{m.mode}</option>
            ))}
          </select>
        </div>
      )}

      {/* è¦æ ¼ */}
      {mode && (
        <div className="mb-3">
          <label>è¦æ ¼ï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={spec}
            onChange={(e) => setSpec(e.target.value)}
          >
            <option value="">è«‹é¸æ“‡</option>
            {specs.map((s) => (
              <option key={s.spec}>{s.spec}</option>
            ))}
          </select>
        </div>
      )}

      {/* æ•¸é‡ */}
      {spec && (
        <div className="mb-3">
          <label>æ•¸é‡ï¼š</label>
          <input
            className="border p-2 rounded ml-2 w-24"
            value={qty}
            onChange={(e) => setQty(e.target.value)}
          />
        </div>
      )}

      <div className="text-xl font-bold text-right mt-3">
        å°è¨ˆï¼š<span className="text-blue-600">{subtotal}</span> å…ƒ
      </div>

      {subtotal > 0 && (
        <button
          className="mt-4 bg-emerald-600 text-white px-4 py-2 rounded"
          onClick={add}
        >
          â• åŠ å…¥ç¸½è¡¨
        </button>
      )}

      {/* æ˜ç´° */}
      {fabItems.length > 0 && (
        <div className="mt-6">
          <h3 className="font-bold text-lg mb-2">ğŸ“‹ è£½ä½œæˆæœ¬æ˜ç´°</h3>

          <table className="w-full border text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-2">åˆ†é¡</th>
                <th className="p-2">æ–¹å¼</th>
                <th className="p-2">è¦æ ¼</th>
                <th className="p-2">æ•¸é‡</th>
                <th className="p-2">å–®åƒ¹</th>
                <th className="p-2">å°è¨ˆ</th>
                <th className="p-2">æ“ä½œ</th>
              </tr>
            </thead>

            <tbody>
              {fabItems.map((it) => (
                <tr key={it.id} className="border-t">
                  <td className="p-2">{it.category}</td>
                  <td className="p-2">{it.mode}</td>
                  <td className="p-2">{it.spec}</td>

                  <td className="p-2">
                    <input
                      className="border w-20 p-1"
                      value={it.qty}
                      onChange={(e) =>
                        updateItem(it.id, {
                          qty: Number(e.target.value),
                          subtotal: Number(e.target.value) * it.unitPrice,
                        })
                      }
                    />
                  </td>

                  <td className="p-2">{it.unitPrice}</td>
                  <td className="p-2">{it.subtotal}</td>

                  <td className="p-2">
                    <button
                      className="text-red-600"
                      onClick={() => deleteItem(it.id)}
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};


/* ============================================================
   ğŸšš 4ï¸âƒ£ é‹è¼¸è²»ç”¨è©¦ç®— TransportCalc
============================================================ */
const TransportCalc = ({ db, addItem, items, deleteItem, updateItem }) => {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [region, setRegion] = React.useState("");
  const [trips, setTrips] = React.useState("");

  const categories = [...new Set(db.map((x) => x.category))];
  const specs = db.filter((x) => x.category === category);
  const regions = db.filter((x) => x.category === category && x.spec === spec);

  const selected = regions.find((x) => x.region === region);
  const subtotal = selected ? selected.price * Number(trips || 0) : 0;

  const add = () => {
    if (!selected || !trips) return alert("è«‹å¡«å®Œæ•´è³‡æ–™");

    addItem({
      id: Date.now(),
      type: "é‹è¼¸è²»ç”¨",
      category,
      spec,
      region,
      trips: Number(trips),
      unitPrice: selected.price,
      subtotal,
    });

    setTrips("");
  };

  const transItems = items.filter((x) => x.type === "é‹è¼¸è²»ç”¨");

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">

      <h2 className="text-xl font-bold mb-3">ğŸšš é‹è¼¸è²»ç”¨è©¦ç®—</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label>åˆ†é¡ï¼š</label>
        <select
          className="border p-2 rounded ml-2"
          value={category}
          onChange={(e) => {
            setCategory(e.target.value);
            setSpec("");
            setRegion("");
          }}
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map((c) => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* è¦æ ¼ */}
      {category && (
        <div className="mb-3">
          <label>è¦æ ¼ï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={spec}
            onChange={(e) => {
              setSpec(e.target.value);
              setRegion("");
            }}
          >
            <option value="">è«‹é¸æ“‡</option>
            {specs.map((s) => (
              <option key={s.spec}>{s.spec}</option>
            ))}
          </select>
        </div>
      )}

      {/* å€åŸŸ */}
      {spec && (
        <div className="mb-3">
          <label>å€åŸŸï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={region}
            onChange={(e) => setRegion(e.target.value)}
          >
            <option value="">è«‹é¸æ“‡</option>
            {regions.map((r) => (
              <option key={r.region}>{r.region}</option>
            ))}
          </select>
        </div>
      )}

      {/* è»Šæ¬¡ */}
      {region && (
        <div className="mb-3">
          <label>è»Šæ¬¡ï¼š</label>
          <input
            className="border p-2 rounded ml-2 w-24"
            value={trips}
            onChange={(e) => setTrips(e.target.value)}
          />
        </div>
      )}

      <div className="text-xl font-bold text-right mt-3">
        å°è¨ˆï¼š<span className="text-blue-600">{subtotal}</span> å…ƒ
      </div>

      {subtotal > 0 && (
        <button
          className="mt-4 bg-emerald-600 text-white px-4 py-2 rounded"
          onClick={add}
        >
          â• åŠ å…¥ç¸½è¡¨
        </button>
      )}

      {/* æ˜ç´° */}
      {transItems.length > 0 && (
        <div className="mt-6">
          <h3 className="font-bold text-lg mb-2">ğŸ“‹ é‹è¼¸è²»ç”¨æ˜ç´°</h3>

          <table className="w-full border text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-2">åˆ†é¡</th>
                <th className="p-2">è¦æ ¼</th>
                <th className="p-2">å€åŸŸ</th>
                <th className="p-2">è»Šæ¬¡</th>
                <th className="p-2">å–®åƒ¹</th>
                <th className="p-2">å°è¨ˆ</th>
                <th className="p-2">æ“ä½œ</th>
              </tr>
            </thead>

            <tbody>
              {transItems.map((it) => (
                <tr key={it.id} className="border-t">
                  <td className="p-2">{it.category}</td>
                  <td className="p-2">{it.spec}</td>
                  <td className="p-2">{it.region}</td>

                  <td className="p-2">
                    <input
                      className="border w-20 p-1 text-right"
                      value={it.trips}
                      onChange={(e) =>
                        updateItem(it.id, {
                          trips: Number(e.target.value),
                          subtotal: Number(e.target.value) * it.unitPrice,
                        })
                      }
                    />
                  </td>

                  <td className="p-2">{it.unitPrice}</td>
                  <td className="p-2">{it.subtotal}</td>

                  <td className="p-2">
                    <button
                      className="text-red-600"
                      onClick={() => deleteItem(it.id)}
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};


/* ============================================================
   ğŸ›  5ï¸âƒ£ ç¾å ´å®‰è£è²»ç”¨ InstallCalc
============================================================ */
const InstallCalc = ({ db, addItem, items, deleteItem, updateItem }) => {
  const [category, setCategory] = React.useState("");
  const [mode, setMode] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  const categories = [...new Set(db.map((x) => x.category))];
  const modes = db.filter((x) => x.category === category);
  const specs = db.filter((x) => x.category === category && x.mode === mode);

  const selected = specs.find((x) => x.spec === spec);
  const subtotal = selected ? selected.price * Number(qty || 0) : 0;

  const add = () => {
    if (!selected || !qty) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

    addItem({
      id: Date.now(),
      type: "ç¾å ´å®‰è£",
      category,
      mode,
      spec,
      qty: Number(qty),
      unit: selected.unit || "é …",
      unitPrice: selected.price,
      subtotal,
    });

    setQty("");
  };

  const insItems = items.filter((x) => x.type === "ç¾å ´å®‰è£");

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">

      <h2 className="text-xl font-bold mb-3">ğŸ›  ç¾å ´å®‰è£è²»ç”¨è©¦ç®—</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label>åˆ†é¡ï¼š</label>
        <select
          className="border p-2 ml-2 rounded"
          value={category}
          onChange={(e) => {
            setCategory(e.target.value);
            setMode("");
            setSpec("");
          }}
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map((c) => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* æ–¹å¼ */}
      {category && (
        <div className="mb-3">
          <label>æ–¹å¼ï¼š</label>
          <select
            className="border p-2 ml-2 rounded"
            value={mode}
            onChange={(e) => {
              setMode(e.target.value);
              setSpec("");
            }}
          >
            <option value="">è«‹é¸æ“‡</option>
            {modes.map((m) => (
              <option key={m.mode}>{m.mode}</option>
            ))}
          </select>
        </div>
      )}

      {/* è¦æ ¼ */}
      {mode && (
        <div className="mb-3">
          <label>è¦æ ¼ï¼š</label>
          <select
            className="border p-2 ml-2 rounded"
            value={spec}
            onChange={(e) => setSpec(e.target.value)}
          >
            <option value="">è«‹é¸æ“‡</option>
            {specs.map((s) => (
              <option key={s.spec}>{s.spec}</option>
            ))}
          </select>
        </div>
      )}

      {/* æ•¸é‡ */}
      {spec && (
        <div className="mb-3">
          <label>æ•¸é‡ï¼š</label>
          <input
            className="border p-2 ml-2 rounded w-24"
            value={qty}
            onChange={(e) => setQty(e.target.value)}
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      <div className="text-xl font-bold text-right mt-3">
        å°è¨ˆï¼š<span className="text-blue-600">{subtotal}</span> å…ƒ
      </div>

      {subtotal > 0 && (
        <button
          className="mt-4 bg-emerald-600 text-white px-4 py-2 rounded"
          onClick={add}
        >
          â• åŠ å…¥ç¸½è¡¨
        </button>
      )}

      {/* æ˜ç´° */}
      {insItems.length > 0 && (
        <div className="mt-6">
          <h3 className="font-bold text-lg mb-2">ğŸ“‹ ç¾å ´å®‰è£æ˜ç´°</h3>

          <table className="w-full border text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-2">åˆ†é¡</th>
                <th className="p-2">æ–¹å¼</th>
                <th className="p-2">è¦æ ¼</th>
                <th className="p-2">æ•¸é‡</th>
                <th className="p-2">å–®åƒ¹</th>
                <th className="p-2">å°è¨ˆ</th>
                <th className="p-2">æ“ä½œ</th>
              </tr>
            </thead>

            <tbody>
              {insItems.map((it) => (
                <tr key={it.id} className="border-t">
                  <td className="p-2">{it.category}</td>
                  <td className="p-2">{it.mode}</td>
                  <td className="p-2">{it.spec}</td>

                  <td className="p-2">
                    <input
                      className="border p-1 w-20 text-right"
                      value={it.qty}
                      onChange={(e) =>
                        updateItem(it.id, {
                          qty: Number(e.target.value),
                          subtotal: Number(e.target.value) * it.unitPrice,
                        })
                      }
                    />
                  </td>

                  <td className="p-2">{it.unitPrice}</td>
                  <td className="p-2">{it.subtotal}</td>

                  <td className="p-2">
                    <button
                      className="text-red-600"
                      onClick={() => deleteItem(it.id)}
                    >
                      åˆªé™¤
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};
/* ============================================================
   ğŸ“Š ç¸½è¡¨ SummaryPageï¼ˆåœ“é¤…åœ–ï¼‹äººå·¥èª¿æ•´ï¼‹äº”å¤§æˆæœ¬åŠ ç¸½ï¼‰
============================================================ */
const SummaryPage = ({ allItems, project, manualAdjust, setManualAdjust }) => {

  // äº”å¤§æˆæœ¬åˆ†é¡
  const groups = {
    ææ–™: allItems.filter((x) => x.type === "ææ–™"),
    å¸‚è³¼å“: allItems.filter((x) => x.type === "å¸‚è³¼å“"),
    è£½ä½œæˆæœ¬: allItems.filter((x) => x.type === "è£½ä½œæˆæœ¬"),
    é‹è¼¸è²»ç”¨: allItems.filter((x) => x.type === "é‹è¼¸è²»ç”¨"),
    ç¾å ´å®‰è£: allItems.filter((x) => x.type === "ç¾å ´å®‰è£"),
  };

  // å°è¨ˆï¼ˆåŒ…å«äººå·¥èª¿æ•´ï¼‰
  const sum = (arr, adj = 0) =>
    arr.reduce((s, x) => s + Number(x.subtotal || 0), 0) + Number(adj || 0);

  const total = 
    sum(groups.ææ–™, manualAdjust.material) +
    sum(groups.å¸‚è³¼å“, manualAdjust.purchase) +
    sum(groups.è£½ä½œæˆæœ¬, manualAdjust.fabricate) +
    sum(groups.é‹è¼¸è²»ç”¨, manualAdjust.transport) +
    sum(groups.ç¾å ´å®‰è£, manualAdjust.install);

  // åœ“é¤…åœ–è³‡æ–™
  React.useEffect(() => {
    const ctx = document.getElementById("chart-pie");

    if (!ctx) return;

    new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["ææ–™", "å¸‚è³¼å“", "è£½ä½œ", "é‹è¼¸", "å®‰è£"],
        datasets: [
          {
            data: [
              sum(groups.ææ–™, manualAdjust.material),
              sum(groups.å¸‚è³¼å“, manualAdjust.purchase),
              sum(groups.è£½ä½œæˆæœ¬, manualAdjust.fabricate),
              sum(groups.é‹è¼¸è²»ç”¨, manualAdjust.transport),
              sum(groups.ç¾å ´å®‰è£, manualAdjust.install),
            ],
            backgroundColor: [
              "#60A5FA",
              "#34D399",
              "#FBBF24",
              "#F87171",
              "#A78BFA",
            ],
          },
        ],
      },
      options: {
        plugins: {
          datalabels: {
            color: "#fff",
            formatter: (v) => (v > 0 ? v.toLocaleString() : ""),
          },
        },
      },
      plugins: [ChartDataLabels],
    });
  }, [allItems, manualAdjust]);

  /* -----------------------------
        Render å€
  ----------------------------- */
  return (
    <div className="bg-white p-4 rounded-xl shadow">

      <h2 className="text-2xl font-bold mb-4">
        ğŸ“Š æˆæœ¬ç¸½è¡¨ï¼ˆ{project || "æœªå‘½åå·¥ç¨‹"}ï¼‰
      </h2>

      {/* åœ“é¤…åœ– */}
      <div className="flex justify-center mb-6">
        <canvas id="chart-pie"></canvas>
      </div>

      {/* äº”å¤§æˆæœ¬æ˜ç´° */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">

        {/* å„é¡æˆæœ¬å€å¡Š */}
        {[
          ["ææ–™", groups.ææ–™, "material"],
          ["å¸‚è³¼å“", groups.å¸‚è³¼å“, "purchase"],
          ["è£½ä½œæˆæœ¬", groups.è£½ä½œæˆæœ¬, "fabricate"],
          ["é‹è¼¸è²»ç”¨", groups.é‹è¼¸è²»ç”¨, "transport"],
          ["ç¾å ´å®‰è£", groups.ç¾å ´å®‰è£, "install"],
        ].map(([label, arr, key]) => (
          <div key={label} className="border p-3 rounded-lg">
            <h3 className="font-bold text-lg mb-2">{label}</h3>

            <p className="text-gray-600 mb-1">
              å°è¨ˆï¼š{arr.reduce((s, x) => s + Number(x.subtotal || 0), 0).toLocaleString()} å…ƒ
            </p>

            {/* äººå·¥èª¿æ•´æ¬„ä½ */}
            <div className="flex items-center gap-2 mb-1">
              <label className="text-sm text-gray-700">äººå·¥èª¿æ•´ï¼š</label>
              <input
                className="border p-1 w-24 text-right rounded"
                value={manualAdjust[key]}
                onChange={(e) =>
                  setManualAdjust((prev) => ({
                    ...prev,
                    [key]: Number(e.target.value),
                  }))
                }
              />
            </div>

            <p className="font-bold">
              åˆè¨ˆï¼š{sum(arr, manualAdjust[key]).toLocaleString()} å…ƒ
            </p>
          </div>
        ))}

      </div>

      {/* ç¸½è¨ˆ */}
      <div className="text-right text-2xl font-bold mt-6">
        ğŸ§® ç¸½é‡‘é¡ï¼š{total.toLocaleString()} å…ƒ
      </div>
    </div>
  );
};
/* ============================================================
   ğŸ–¥ï¸ App() ä¸»ç•«é¢ï¼ˆTab åˆ‡æ› + äº”å¤§æˆæœ¬é é¢ + ç¸½è¡¨ï¼‰
============================================================ */
const App = () => {
  const [project, setProject] = React.useState("");     // ç•¶å‰å·¥ç¨‹åç¨±
  const [projectList, setProjectList] = React.useState(loadProjectList()); // å·¥ç¨‹æ¸…å–®
  const [allItems, setAllItems] = React.useState([]);   // ç•¶å‰å·¥ç¨‹çš„å…¨éƒ¨æ˜ç´°

  // äº”å¤§æˆæœ¬çš„æ‰‹å‹•èª¿æ•´ï¼ˆç¸½è¡¨ä½¿ç”¨ï¼‰
  const [manualAdjust, setManualAdjust] = React.useState({
    material: 0,
    purchase: 0,
    fabricate: 0,
    transport: 0,
    install: 0,
  });

  /* ---------------------------------------------
     Tab åˆ‡æ›
  --------------------------------------------- */
  const tabs = ["ææ–™", "å¸‚è³¼å“", "è£½ä½œæˆæœ¬", "é‹è¼¸è²»ç”¨", "ç¾å ´å®‰è£", "ç¸½è¡¨"];
  const [tab, setTab] = React.useState("ææ–™");

  /* ---------------------------------------------
     å·¥ç¨‹åˆ‡æ›ï¼šè®€å–è©²å·¥ç¨‹çš„æ˜ç´°
  --------------------------------------------- */
  React.useEffect(() => {
    if (!project) return;

    const key = `items_${project}`;
    const saved = localStorage.getItem(key);

    if (saved) {
      setAllItems(JSON.parse(saved));
    } else {
      setAllItems([]);
    }
  }, [project]);

  /* ---------------------------------------------
     åªè¦ allItems è®Š â†’ å¯«å›è©²å·¥ç¨‹
  --------------------------------------------- */
  React.useEffect(() => {
    if (!project) return;
    localStorage.setItem(`items_${project}`, JSON.stringify(allItems));
  }, [allItems, project]);

  /* CRUDï¼šæ–°å¢ã€åˆªé™¤ã€æ›´æ–° */
  const addItem = (item) => {
    setAllItems((prev) => [...prev, item]);
  };

  const deleteItem = (id) => {
    setAllItems((prev) => prev.filter((x) => x.id !== id));
  };

  const updateItem = (id, newData) => {
    setAllItems((prev) =>
      prev.map((x) => (x.id === id ? { ...x, ...newData } : x))
    );
  };

  const clearAllItems = () => {
    if (!confirm("ç¢ºå®šè¦æ¸…é™¤è©²å·¥ç¨‹çš„æ‰€æœ‰æ˜ç´°ï¼Ÿ")) return;
    setAllItems([]);
  };

  /* ---------------------------------------------
     ç•«é¢ Render
  --------------------------------------------- */
  return (
    <div className="max-w-6xl mx-auto">

      {/* â—†â—† å·¥ç¨‹åˆ‡æ›å€ â—†â—† */}
      <ProjectSelector
        project={project}
        setProject={setProject}
        projectList={projectList}
        setProjectList={setProjectList}
      />

      {/* â—†â—† å·¥ç¨‹åç¨±è¼¸å…¥æ¬„ â—†â—† */}
      <div className="bg-white p-4 rounded-xl shadow mb-4">
        <label className="font-bold mr-2">å·¥ç¨‹åç¨±ï¼š</label>
        <input
          className="border p-2 rounded w-64"
          placeholder="è¼¸å…¥å·¥ç¨‹åç¨±..."
          value={project}
          onChange={(e) => setProject(e.target.value)}
        />
      </div>

      {/* â—†â—† ä¸Šæ–¹åˆ†é¡é¸å–® â—†â—† */}
      <div className="flex gap-2 mb-4 no-print">
        {tabs.map((t) => (
          <button
            key={t}
            onClick={() => setTab(t)}
            className={`px-4 py-2 rounded border ${
              tab === t ? "bg-blue-600 text-white" : "bg-white"
            }`}
          >
            {t}
          </button>
        ))}

        {/* æ¸…é™¤æ˜ç´° */}
        <button
          className="ml-auto px-3 py-2 border rounded border-red-500 text-red-600 bg-white"
          onClick={clearAllItems}
        >
          ğŸ—‘ æ¸…é™¤æ˜ç´°
        </button>
      </div>

      {/* â—†â—† å„é é¢å…§å®¹ â—†â—† */}
      {tab === "ææ–™" && (
        <MaterialCalc
          allItems={allItems}
          addItem={addItem}
          deleteItem={deleteItem}
          updateItem={updateItem}
        />
      )}

      {tab === "å¸‚è³¼å“" && (
        <PurchaseCalc
          allItems={allItems}
          addItem={addItem}
          deleteItem={deleteItem}
          updateItem={updateItem}
        />
      )}

      {tab === "è£½ä½œæˆæœ¬" && (
        <FabricationCalc
          allItems={allItems}
          addItem={addItem}
          deleteItem={deleteItem}
          updateItem={updateItem}
        />
      )}

      {tab === "é‹è¼¸è²»ç”¨" && (
        <TransportCalc
          allItems={allItems}
          addItem={addItem}
          deleteItem={deleteItem}
          updateItem={updateItem}
        />
      )}

      {tab === "ç¾å ´å®‰è£" && (
        <InstallCalc
          allItems={allItems}
          addItem={addItem}
          deleteItem={deleteItem}
          updateItem={updateItem}
        />
      )}

      {tab === "ç¸½è¡¨" && (
        <SummaryPage
          allItems={allItems}
          project={project}
          manualAdjust={manualAdjust}
          setManualAdjust={setManualAdjust}
        />
      )}
    </div>
  );
};
/* ============================================================
   ğŸš€ React å•Ÿå‹•ï¼ˆæ¸²æŸ“ Appï¼‰
============================================================ */

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

