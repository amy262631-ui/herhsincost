<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹æˆæœ¬è©¦ç®—ç³»çµ± - React Standalone (æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconv-lite@0.6.3/lib/index.js"></script>
    <style>
        /* ç¢ºä¿ Chart.js å®¹å™¨æœ‰å›ºå®šé«˜åº¦ */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        /* ç¢ºä¿æ•´å€‹æ‡‰ç”¨ç¨‹å¼ä¸»é«”ä½”æ»¿è¢å¹•é«˜åº¦ */
        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* å°ˆé–€ç”¨æ–¼åˆ—å°çš„æ¨£å¼ */
        @media print {
            body > :not(.print-content) {
                display: none !important;
            }
            .print-content {
                display: block !important;
                /* ç¢ºä¿åˆ—å°å…§å®¹ä½”æ»¿é é¢ */
                width: 100% !important; 
                margin: 0 !important;
                padding: 0 !important;
            }
            /* éš±è—åˆ—å°æ™‚ä¸éœ€è¦çš„å…ƒç´  */
            .print-hidden {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // å–å¾— React ç›¸é—œå‡½å¼
const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // 2ï¸âƒ£ äº”å¤§ Google Sheet è³‡æ–™åº« CSV é€£çµ (å·²ä½¿ç”¨æ‚¨æä¾›çš„é€£çµ)
        const BASE_CSV_URLS = {
            materials: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",
            purchased: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",
            production: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",
            transportation: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",
            installation: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv",
        };

        const DATA_KEYS = Object.keys(BASE_CSV_URLS);
        const CATEGORIES = {
            materials: 'ğŸ§± ææ–™æˆæœ¬',
            purchased: 'ğŸ›’ å¸‚è³¼å“',
            production: 'ğŸ­ è£½ä½œæˆæœ¬',
            transportation: 'ğŸšš é‹è¼¸è²»ç”¨',
            installation: 'ğŸ”§ ç¾å ´å®‰è£',
            summary: 'ç¸½æˆæœ¬',
        };
        const ALL_ADJUST_KEYS = ['materials', 'purchased', 'production', 'transportation', 'installation'];


        // é è¨­å·¥ç¨‹çµæ§‹
        const DEFAULT_PROJECTS = {
            "ä¸»å·¥ç¨‹": { 
                allItems: [], 
                manualAdjust: {
                    materials: 0,
                    purchased: 0,
                    production: 0,
                    transportation: 0,
                    installation: 0,
                }, 
                adminFeeRate: 0.15, // ç®¡éŠ·é è¨­ 15%
                profitRate: 0.35 // æ¯›åˆ©ç‡é è¨­ 35%
            }
        };
        const INITIAL_PROJECT_NAME = "ä¸»å·¥ç¨‹";

        // --- Utility Functions ---
        
        // ä¿®æ­£å¾Œçš„ CSV è½‰ JSON å‡½æ•¸ (è™•ç†ä¸­æ–‡ç·¨ç¢¼å’Œåˆ†éš”ç¬¦)
        const csvToJson = (csv, key) => {
            // è™•ç† Windows/Mac æ›è¡Œç¬¦ï¼Œä¸¦ç§»é™¤ç©ºç™½è¡Œ
            const lines = csv.split(/[\r\n]+/).filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            // å˜—è©¦è§£ææ¨™é ­ (ç¬¬ä¸€è¡Œ)
            // ä½¿ç”¨æ›´å¯¬é¬†çš„åŒ¹é…ï¼Œé¿å…é›™å¼•è™Ÿå…§éƒ¨çš„é€—è™Ÿé€ æˆå•é¡Œ
            const headerLine = lines[0];
            const header = headerLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                                     .map(h => h.trim().replace(/^"|"$/g, ''));
            
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i];
                // ä½¿ç”¨åŒæ¨£çš„æ­£è¦è¡¨é”å¼è§£æå…§å®¹
                const currentCols = currentLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                                              .map(col => col.trim().replace(/^"|"$/g, ''));
                                              
                if (currentCols.length < header.length) continue; // ç¢ºä¿æ¬„ä½æ•¸ç¬¦åˆæ¨™é ­
                
                const item = {};
                for (let j = 0; j < header.length; j++) {
                    item[header[j]] = currentCols[j];
                }

                const processedItem = {};
                Object.keys(item).forEach(k => {
                    const value = item[k];
                    if (value === undefined || value === null || value === '') return;

                    let processedValue = value;
                    if (['Price', 'Density', 'Unit Cost', 'Cost'].includes(k) || (key === 'materials' && k.endsWith(' Cost'))) {
                        processedValue = parseFloat(value) || 0;
                    }

                    processedItem[k] = processedValue;
                });

                if (Object.keys(processedItem).length > 0) {
                    data.push(processedItem);
                }
            }

            return data;
        };

        // è¨ˆç®— Google Sheet Version
        const calculateVersion = (csv) => {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return 'v0';
            
            const rowCount = lines.length;
            const firstLine = lines[0].trim();
            const lastLine = lines[lines.length - 1].trim();

            return `${rowCount}-${firstLine.length}-${lastLine.length}`;
        };

        // è‡ªå‹•ä¿å­˜åˆ° localStorage
        const saveToLocalStorage = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
            }
        };

        // å¾ localStorage è®€å–
        const loadFromLocalStorage = (key, defaultValue) => {
            try {
                const storedValue = localStorage.getItem(key);
                if (key === 'allProjects' && storedValue) {
                    const storedProjects = JSON.parse(storedValue);
                    const mergedProjects = {};
                    Object.keys(storedProjects).forEach(projName => {
                        mergedProjects[projName] = {
                            ...DEFAULT_PROJECTS[INITIAL_PROJECT_NAME],
                            ...storedProjects[projName],
                            // ç¢ºä¿ manualAdjust æ˜¯ç‰©ä»¶ä¸”åŒ…å«æ‰€æœ‰ç´°é …
                            manualAdjust: {
                                ...DEFAULT_PROJECTS[INITIAL_PROJECT_NAME].manualAdjust,
                                ...(storedProjects[projName].manualAdjust || {})
                            }
                        };
                    });
                    return mergedProjects;
                }
                
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                return defaultValue;
            }
        };

        // æˆæœ¬è¨ˆç®—é‚è¼¯ (æ­¤è™•çœç•¥ï¼Œä¿æŒä¸è®Š)

        const calculateCostDetail = (item, sheetData) => {
            const isForcedPrice = typeof item.forcedPrice === 'number' && item.forcedPrice > 0;

            const selectedData = sheetData.find(d => 
                d.Category === item.Category && 
                ((item.typeKey === 'materials' && d.Item === item.Item) || 
                 (item.typeKey === 'purchased' && d.Item === item.Item) ||
                 (item.typeKey === 'production' && d.Item === item.Item) ||
                 (item.typeKey === 'transportation' && d.Item === item.Item) ||
                 (item.typeKey === 'installation' && d.Mode === item.Mode && d.Spec === item.Spec)
                )
            );

            let cost = 0;
            let totalQuantity = 0;
            let calculatedWeight = 0;

            if (selectedData) {
                if (item.typeKey === 'materials') {
                    cost = selectedData.Price || 0;
                    
                    if (item.Mode === 'æ¿æ') {
                        const area = (item.L || 0) * (item.W || 0);
                        // ä¿®æ­£ï¼šå¦‚æœ Density ç‚º 0ï¼Œå‰‡é¿å… NaN
                        calculatedWeight = (selectedData.Density || 0) * (item.L || 0) * (item.W || 0) * (item.pcs || 0);
                        totalQuantity = area * (item.pcs || 0);
                    } else if (item.Mode === 'å‹é‹¼') {
                        calculatedWeight = (selectedData.Density || 0) * (item.len || 0) * (item.qty || 0);
                        totalQuantity = calculatedWeight;
                    } else {
                        totalQuantity = item.Quantity || 0;
                    }

                } else if (item.typeKey === 'purchased') {
                    cost = selectedData.Price || 0;
                    totalQuantity = item.Quantity || 0;
                } else if (item.typeKey === 'production' || item.typeKey === 'transportation') {
                    cost = selectedData['Unit Cost'] || 0;
                    totalQuantity = item.Quantity || 0;
                } else if (item.typeKey === 'installation') {
                    cost = selectedData.Cost || 0;
                    totalQuantity = item.Quantity || 0;
                }
            }

            const finalCost = isForcedPrice ? item.forcedPrice : cost;
            const subtotal = totalQuantity * finalCost;
            
            return { subtotal, calculatedWeight, price: finalCost };
        };


        // --- Custom Hooks ---

        // Google Sheet æ™ºèƒ½åŒæ­¥ Hook (é‡é»ä¿®æ­£ fetch è™•ç†ç·¨ç¢¼)
        const useDataSynchronization = () => {
            const [data, setData] = useState({});
            const [syncTime, setSyncTime] = useState(loadFromLocalStorage('syncTime', {}));
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                // æª¢æŸ¥ iconv-lite æ˜¯å¦è¼‰å…¥
                if (!window.iconv) {
                    console.error("iconv-lite å‡½å¼åº«æœªè¼‰å…¥ï¼Œç„¡æ³•è™•ç†ä¸­æ–‡ç·¨ç¢¼ï¼è«‹åœ¨ HTML ä¸­åŠ å…¥ <script src='https://cdn.jsdelivr.net/npm/iconv-lite@0.6.3/lib/index.js'></script>");
                    setIsLoading(false);
                    return;
                }
                
                const syncData = async () => {
                    setIsLoading(true);
                    const newData = {};
                    const newSyncTime = { ...syncTime };
                    let updated = false;

                    for (const key of DATA_KEYS) {
                        // åŠ ä¸Šéš¨æ©Ÿæ™‚é–“æˆ³ä»¥å¼·åˆ¶æ›´æ–°
                        const url = `${BASE_CSV_URLS[key]}&t=${Date.now()}`; 
                        const versionKey = `${key}_version`;
                        const dataKey = `${key}_data`;
                        
                        const cachedData = loadFromLocalStorage(dataKey, []);
                        const cachedVersion = localStorage.getItem(versionKey);

                        try {
                            const response = await fetch(url);
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            
                            // ğŸš¨ é—œéµä¿®æ­£ï¼šå°‡å›æ‡‰å…§å®¹è®€å–ç‚º ArrayBuffer (åŸå§‹ä½å…ƒçµ„)
                            const buffer = await response.arrayBuffer();
                            const unit8Arr = new Uint8Array(buffer);
                            
                            // å˜—è©¦ä»¥ä¸­æ–‡ Big5 (å¸¸è¦‹æ–¼ç¹é«”ä¸­æ–‡ CSV) è§£ç¢¼
                            let csv = '';
                            try {
                                csv = iconv.decode(unit8Arr, 'big5');
                                // æª¢æŸ¥æ˜¯å¦ä»æœ‰äº‚ç¢¼ï¼Œå¦‚æœäº‚ç¢¼åš´é‡ï¼Œå¯èƒ½éœ€è¦å˜—è©¦ gbk
                                if (csv.includes('Ã¦')) { // ç°¡å–®æª¢æŸ¥ Big5 è§£ç¢¼å¾Œæ˜¯å¦ä»æœ‰å¸¸è¦‹äº‚ç¢¼å­—å…ƒ
                                    csv = iconv.decode(unit8Arr, 'gbk');
                                }
                            } catch (e) {
                                // å¦‚æœ iconv è§£ç¢¼å¤±æ•—ï¼Œå˜—è©¦é è¨­çš„ UTF-8 (ä½†ä¸æ‡‰å‡ºç¾äº‚ç¢¼å•é¡Œ)
                                console.warn(`[ç·¨ç¢¼è­¦å‘Š] iconv-lite è§£ç¢¼å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ UTF-8ã€‚`);
                                csv = new TextDecoder('utf-8').decode(unit8Arr);
                            }

                            const currentVersion = calculateVersion(csv);
                            
                            if (currentVersion === cachedVersion && cachedData.length > 0) {
                                newData[key] = cachedData;
                            } else {
                                // ğŸš¨ é—œéµä¿®æ­£ï¼šå°‡è§£ç¢¼å¾Œçš„ CSV å‚³å…¥ä¿®æ­£å¾Œçš„è§£æå‡½æ•¸
                                const parsedData = csvToJson(csv, key); 
                                newData[key] = parsedData;
                                
                                localStorage.setItem(dataKey, JSON.stringify(parsedData));
                                localStorage.setItem(versionKey, currentVersion);
                                newSyncTime[key] = new Date().toLocaleString();
                                updated = true;
                                if (parsedData.length === 0) {
                                    console.warn(`[æ•¸æ“šè­¦å‘Š] ${CATEGORIES[key]} è¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹ç‚ºç©º (0 ç­†è³‡æ–™)ã€‚è«‹æª¢æŸ¥ Sheet å…§å®¹ã€‚`);
                                } else {
                                     console.log(`[åŒæ­¥æˆåŠŸ] ${CATEGORIES[key]} è¼‰å…¥ ${parsedData.length} ç­†è³‡æ–™ã€‚`);
                                }
                            }
                        } catch (error) {
                            console.error(`[è¼‰å…¥å¤±æ•—] ${CATEGORIES[key]} è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ŒåŸå› :`, error);
                            // è‹¥è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨å¿«å–è³‡æ–™
                            const cachedData = loadFromLocalStorage(`${key}_data`, []); // é‡æ–°å¾ localStorage è¼‰å…¥ï¼Œé˜²æ­¢å¿«å–ç‰ˆæœ¬åˆ¤æ–·éŒ¯èª¤
                            if (cachedData.length > 0) {
                                newData[key] = cachedData;
                                console.warn(`[ä½¿ç”¨å¿«å–] è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å¿«å–è³‡æ–™ (${cachedData.length} ç­†)ã€‚`);
                            } else {
                                newData[key] = [];
                                console.error(`[åš´é‡è­¦å‘Š] ç„¡æ³•å¾ API æˆ–å¿«å–ç²å– ${CATEGORIES[key]} è³‡æ–™ã€‚`);
                            }
                        }
                    }

                    setData(newData);
                    if (updated) {
                        setSyncTime(newSyncTime);
                        saveToLocalStorage('syncTime', newSyncTime);
                    }
                    setIsLoading(false);
                };

                syncData();
            }, []);

            return { data, syncTime, isLoading };
        };

        // --- å…¶é¤˜ç¨‹å¼ç¢¼æœªè®Šå‹• (èˆ‡ä¹‹å‰æä¾›çš„ç‰ˆæœ¬ç›¸åŒ) ---
        
        // å¤šå·¥ç¨‹ç®¡ç† Hook (æœªè®Šå‹•)
        const useProjectManagement = () => {
            const [projects, setProjects] = useState(() => loadFromLocalStorage('allProjects', DEFAULT_PROJECTS));
            const [currentProjectName, setCurrentProjectName] = useState(() => {
                const lastProject = localStorage.getItem('currentProjectName');
                return projects[lastProject] ? lastProject : INITIAL_PROJECT_NAME;
            });

            useEffect(() => {
                if (!projects[currentProjectName]) {
                    const newName = Object.keys(projects)[0] || INITIAL_PROJECT_NAME;
                    setCurrentProjectName(newName);
                    localStorage.setItem('currentProjectName', newName);
                }
            }, [projects, currentProjectName]);

            useEffect(() => {
                saveToLocalStorage('allProjects', projects);
            }, [projects]);
            
            useEffect(() => {
                localStorage.setItem('currentProjectName', currentProjectName);
            }, [currentProjectName]);


            // è¨­ç½®ç•¶å‰å·¥ç¨‹çš„è³‡æ–™
            const updateCurrentProject = useCallback((updateFn) => {
                setProjects(prevProjects => {
                    const currentProject = prevProjects[currentProjectName];
                    if (!currentProject) return prevProjects;

                    const newProject = updateFn(currentProject);

                    return {
                        ...prevProjects,
                        [currentProjectName]: newProject
                    };
                });
            }, [currentProjectName]);

            // è¨­ç½®ç‰¹å®šé¡åˆ¥çš„æ‰‹å‹•èª¿æ•´å€¼
            const updateManualAdjust = useCallback((typeKey, value) => {
                updateCurrentProject(proj => ({
                    ...proj,
                    manualAdjust: {
                        ...proj.manualAdjust,
                        [typeKey]: value
                    }
                }));
            }, [updateCurrentProject]);


            // æ–°å¢/åˆªé™¤/åˆ‡æ›å·¥ç¨‹
            const addProject = useCallback((name) => {
                if (!name || projects[name]) return false;
                
                const newProjects = {
                    ...projects,
                    [name]: { ...DEFAULT_PROJECTS[INITIAL_PROJECT_NAME] }
                };
                setProjects(newProjects);
                setCurrentProjectName(name);
                return true;
            }, [projects]);

            const deleteProject = useCallback((name) => {
                if (Object.keys(projects).length === 1) return alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å·¥ç¨‹ï¼");
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å·¥ç¨‹ï¼š${name} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) return;

                const newProjects = { ...projects };
                delete newProjects[name];
                setProjects(newProjects);

                if (currentProjectName === name) {
                    const firstProjectName = Object.keys(newProjects)[0];
                    setCurrentProjectName(firstProjectName);
                }
            }, [projects, currentProjectName]);
            
            const switchProject = useCallback((name) => {
                if (projects[name]) {
                    setCurrentProjectName(name);
                }
            }, [projects]);
            
            const currentProject = projects[currentProjectName] || { ...DEFAULT_PROJECTS[INITIAL_PROJECT_NAME] };
            
            return {
                projects,
                currentProjectName,
                currentProject,
                updateCurrentProject,
                updateManualAdjust, 
                addProject,
                deleteProject,
                switchProject
            };
        };


        // --- Component Definitions ---

        // å·¥ç¨‹åˆ‡æ›åŠç®¡ç† UI (æœªè®Šå‹•)
        const ProjectSelector = ({ projects, currentProjectName, switchProject, addProject, deleteProject }) => {
            const [newProjectName, setNewProjectName] = useState('');
            const [showAdd, setShowAdd] = useState(false);

            const handleAddProject = () => {
                if (!newProjectName.trim()) {
                    alert("å·¥ç¨‹åç¨±ä¸èƒ½ç‚ºç©ºï¼");
                    return;
                }
                if (addProject(newProjectName.trim())) {
                    setNewProjectName('');
                    setShowAdd(false);
                } else {
                    alert(`å·¥ç¨‹åç¨± ${newProjectName.trim()} å·²å­˜åœ¨ï¼`);
                }
            };
            
            return (
                <div className="p-4 bg-gray-100 border-b border-gray-300 print-hidden">
                    <h2 className="text-xl font-bold mb-3 flex items-center">
                        <span className="mr-2">ğŸ“ å·¥ç¨‹ç®¡ç†:</span>
                        <button 
                            onClick={() => setShowAdd(!showAdd)}
                            className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm transition duration-150"
                        >
                            {showAdd ? 'å–æ¶ˆ' : 'â• æ–°å¢å·¥ç¨‹'}
                        </button>
                    </h2>
                    
                    {showAdd && (
                        <div className="flex mb-3 space-x-2">
                            <input
                                type="text"
                                value={newProjectName}
                                onChange={(e) => setNewProjectName(e.target.value)}
                                placeholder="è¼¸å…¥æ–°å·¥ç¨‹åç¨±"
                                className="border p-2 flex-grow rounded"
                            />
                            <button
                                onClick={handleAddProject}
                                className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                            >
                                ç¢ºå®šæ–°å¢
                            </button>
                        </div>
                    )}

                    <div className="flex flex-wrap gap-2">
                        {Object.keys(projects).map(name => (
                            <div key={name} className="flex items-center">
                                <button
                                    onClick={() => switchProject(name)}
                                    className={`py-2 px-4 rounded transition duration-150 text-sm ${
                                        name === currentProjectName 
                                            ? 'bg-indigo-600 text-white font-semibold shadow-md' 
                                            : 'bg-white text-gray-700 border border-gray-300 hover:bg-indigo-100'
                                    }`}
                                >
                                    {name}
                                </button>
                                {Object.keys(projects).length > 1 && (
                                    <button
                                        onClick={() => deleteProject(name)}
                                        className="ml-1 text-red-500 hover:text-red-700 text-lg font-bold p-1 leading-none"
                                        title="åˆªé™¤å·¥ç¨‹"
                                    >
                                        &times;
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ç·¨è¼¯/åˆªé™¤æ¨¡æ…‹æ¡† (æœªè®Šå‹•)
        const EditItemModal = ({ item, sheetData, onClose, onSave }) => {
            const [quantity, setQuantity] = useState(item.Quantity || item.pcs || item.qty || item.len || item.L || 0);
            const [forcedPrice, setForcedPrice] = useState(item.forcedPrice || 0);
            
            const originalPrice = useMemo(() => {
                const { price } = calculateCostDetail({ ...item, Quantity: 1, pcs: 1, qty: 1, len: 1, L: 1, forcedPrice: 0 }, sheetData);
                return price;
            }, [item, sheetData]);
            
            const handleSave = () => {
                const update = {
                    Quantity: quantity,
                    forcedPrice: parseFloat(forcedPrice) || undefined,
                };

                if (item.typeKey === 'materials') {
                    if (item.Mode === 'æ¿æ') {
                        update.L = item.L;
                        update.W = item.W;
                        update.pcs = parseInt(quantity);
                        delete update.Quantity;
                    } else if (item.Mode === 'å‹é‹¼') {
                        update.len = item.len;
                        update.qty = parseInt(quantity);
                        delete update.Quantity;
                    } else {
                        update.Quantity = parseFloat(quantity);
                    }
                } else {
                    update.Quantity = parseFloat(quantity);
                }

                onSave(item.id, update);
                onClose();
            };

            const quantityLabel = useMemo(() => {
                if (item.typeKey === 'materials') {
                    if (item.Mode === 'æ¿æ') return 'ç‰‡æ•¸ (pcs)';
                    if (item.Mode === 'å‹é‹¼') return 'æ”¯æ•¸ (qty)';
                }
                return 'æ•¸é‡';
            }, [item]);
            
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-96">
                        <h3 className="text-xl font-bold mb-4">ç·¨è¼¯æ˜ç´°é …ç›®</h3>
                        <p className="mb-4 text-sm text-gray-700">é …ç›®: {item.Item || item.Category} {item.Mode ? `(${item.Mode} ${item.Spec || ''})` : ''}</p>
                        
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-bold mb-2">{quantityLabel}</label>
                            <input
                                type="number"
                                value={quantity}
                                onChange={(e) => setQuantity(parseFloat(e.target.value) || 0)}
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                min="0" step="any"
                            />
                        </div>

                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-bold mb-2">å–®åƒ¹ (å¼·åˆ¶æ›´å‹•)</label>
                            <p className="text-xs text-red-500 mb-1">åŸå§‹å–®åƒ¹: {originalPrice.toFixed(2)}</p>
                            <input
                                type="number"
                                value={forcedPrice}
                                onChange={(e) => setForcedPrice(e.target.value)}
                                placeholder="è¼¸å…¥æ–°çš„å–®åƒ¹ (0 è¡¨ç¤ºä½¿ç”¨åŸå§‹å–®åƒ¹)"
                                className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                min="0" step="0.01"
                            />
                        </div>

                        <div className="flex justify-end space-x-4">
                            <button onClick={onClose} className="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-150">
                                å–æ¶ˆ
                            </button>
                            <button onClick={handleSave} className="bg-indigo-600 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded transition duration-150">
                                ä¿å­˜è®Šæ›´
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // äº”å¤§è©¦ç®—é é¢åŸºåº•çµ„ä»¶ (åŒ…å«æ‰‹å‹•èª¿æ•´æ¬„ä½) (æœªè®Šå‹•)
        const BaseSheet = ({ typeKey, data, currentProject, updateCurrentProject, updateManualAdjust }) => {
            const [editingItem, setEditingItem] = useState(null);
            
            const { allItems } = currentProject;
            const sheetItems = allItems.filter(item => item.typeKey === typeKey);
            const sheetData = data[typeKey] || [];
            
            const categories = useMemo(() => {
                const cats = [...new Set(sheetData.map(item => item.Category).filter(c => c))];
                return cats.sort();
            }, [sheetData]);

            const handleChangeItem = (index, field, value) => {
                updateCurrentProject(proj => {
                    const newAllItems = [...proj.allItems];
                    const itemIndex = newAllItems.findIndex(item => item.id === sheetItems[index].id);
                    if (itemIndex > -1) {
                        newAllItems[itemIndex] = { ...newAllItems[itemIndex], [field]: value };
                    }
                    return { ...proj, allItems: newAllItems };
                });
            };
            
            const handleSaveEdit = (id, updates) => {
                 updateCurrentProject(proj => {
                    const newAllItems = proj.allItems.map(item => 
                        item.id === id ? { ...item, ...updates } : item
                    );
                    return { ...proj, allItems: newAllItems };
                });
            };

            const handleDeleteItem = (id) => {
                if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ")) return;
                updateCurrentProject(proj => ({
                    ...proj,
                    allItems: proj.allItems.filter(item => item.id !== id)
                }));
            };

            const handleAddItem = (newItem) => {
                updateCurrentProject(proj => ({
                    ...proj,
                    allItems: [...proj.allItems, { id: Date.now(), typeKey, ...newItem }]
                }));
            };

            const renderInputs = (item, index) => {
                if (typeKey === 'materials') {
                    const isSheet = item.Mode === 'æ¿æ';
                    const isSteel = item.Mode === 'å‹é‹¼';

                    if (isSheet) {
                        return (
                            <>
                                <input type="number" placeholder="L (m)" value={item.L || ''} onChange={(e) => handleChangeItem(index, 'L', parseFloat(e.target.value) || 0)} className="w-16 p-1 border rounded text-right" min="0" step="0.01" />
                                <input type="number" placeholder="W (m)" value={item.W || ''} onChange={(e) => handleChangeItem(index, 'W', parseFloat(e.target.value) || 0)} className="w-16 p-1 border rounded text-right" min="0" step="0.01" />
                                <input type="number" placeholder="pcs" value={item.pcs || ''} onChange={(e) => handleChangeItem(index, 'pcs', parseInt(e.target.value) || 0)} className="w-16 p-1 border rounded text-right" min="1" />
                            </>
                        );
                    } else if (isSteel) {
                        return (
                            <>
                                <input type="number" placeholder="len (m)" value={item.len || ''} onChange={(e) => handleChangeItem(index, 'len', parseFloat(e.target.value) || 0)} className="w-16 p-1 border rounded text-right" min="0" step="0.01" />
                                <input type="number" placeholder="qty" value={item.qty || ''} onChange={(e) => handleChangeItem(index, 'qty', parseInt(e.target.value) || 0)} className="w-16 p-1 border rounded text-right" min="1" />
                            </>
                        );
                    }
                    return <input type="number" placeholder="æ•¸é‡" value={item.Quantity || ''} onChange={(e) => handleChangeItem(index, 'Quantity', parseFloat(e.target.value) || 0)} className="w-20 p-1 border rounded text-right" min="0" step="0.01" />;
                } 
                else if (typeKey === 'purchased' || typeKey === 'production' || typeKey === 'transportation') {
                    return <input type="number" placeholder="æ•¸é‡" value={item.Quantity || ''} onChange={(e) => handleChangeItem(index, 'Quantity', parseFloat(e.target.value) || 0)} className="w-20 p-1 border rounded text-right" min="0" step="0.01" />;
                } 
                else if (typeKey === 'installation') {
                    const modes = [...new Set(sheetData.filter(d => d.Category === item.Category).map(d => d.Mode).filter(m => m))];
                    const specs = [...new Set(sheetData.filter(d => d.Category === item.Category && d.Mode === item.Mode).map(d => d.Spec).filter(s => s))];
                    
                    return (
                        <>
                            <select value={item.Mode || ''} onChange={(e) => handleChangeItem(index, 'Mode', e.target.value)} className="p-1 border rounded w-24 text-sm">
                                <option value="">é¸æ“‡æ¨¡å¼</option>
                                {modes.map(mode => <option key={mode} value={mode}>{mode}</option>)}
                            </select>
                            <select value={item.Spec || ''} onChange={(e) => handleChangeItem(index, 'Spec', e.target.value)} className="p-1 border rounded w-24 text-sm">
                                <option value="">é¸æ“‡è¦æ ¼</option>
                                {specs.map(spec => <option key={spec} value={spec}>{spec}</option>)}
                            </select>
                            <input type="number" placeholder="æ•¸é‡" value={item.Quantity || ''} onChange={(e) => handleChangeItem(index, 'Quantity', parseFloat(e.target.value) || 0)} className="w-20 p-1 border rounded text-right" min="0" step="0.01" disabled />
                        </>
                    );
                }
                
                return null;
            };

            // ç¸½è¨ˆå’Œç¸½é‡é‡è¨ˆç®—
            const sheetTotals = useMemo(() => {
                let totalSubtotal = 0;
                let totalWeight = 0;
                sheetItems.forEach(item => {
                    const { subtotal, calculatedWeight } = calculateCostDetail(item, sheetData);
                    totalSubtotal += subtotal;
                    totalWeight += calculatedWeight;
                });
                return { totalSubtotal, totalWeight };
            }, [sheetItems, sheetData]);
            
            const { totalSubtotal, totalWeight } = sheetTotals;
            
            // è™•ç†æ‰‹å‹•èª¿æ•´è¼¸å…¥
            const manualAdjustValue = currentProject.manualAdjust[typeKey] || 0;
            const finalTotal = totalSubtotal + manualAdjustValue;

            const handleAdjustChange = (e) => {
                const value = parseFloat(e.target.value) || 0;
                updateManualAdjust(typeKey, value);
            };

            // æ¸²æŸ“é …ç›®é¸æ“‡å™¨ (æ–°å¢åŠŸèƒ½)
            const AddItemForm = () => {
                const [selectedCategory, setSelectedCategory] = useState('');
                const [selectedItem, setSelectedItem] = useState('');
                const [selectedMode, setSelectedMode] = useState('');
                const [selectedSpec, setSelectedSpec] = useState('');

                const filteredItems = useMemo(() => {
                    const items = sheetData.filter(d => d.Category === selectedCategory);
                    if (typeKey === 'installation') {
                        return items.filter(d => d.Mode === selectedMode);
                    }
                    return items;
                }, [selectedCategory, selectedMode, sheetData, typeKey]);

                const modes = useMemo(() => {
                    if (typeKey !== 'installation') return [];
                    return [...new Set(sheetData.filter(d => d.Category === selectedCategory).map(d => d.Mode).filter(m => m))];
                }, [selectedCategory, sheetData, typeKey]);
                
                const specs = useMemo(() => {
                    if (typeKey !== 'installation') return [];
                    return [...new Set(sheetData.filter(d => d.Category === selectedCategory && d.Mode === selectedMode).map(d => d.Spec).filter(s => s))];
                }, [selectedCategory, selectedMode, sheetData, typeKey]);
                
                const handleCategoryChange = (e) => {
                    setSelectedCategory(e.target.value);
                    setSelectedItem('');
                    setSelectedMode('');
                    setSelectedSpec('');
                };

                const handleModeChange = (e) => {
                    setSelectedMode(e.target.value);
                    setSelectedItem('');
                    setSelectedSpec('');
                };
                
                const handleAdd = () => {
                    if (typeKey === 'installation') {
                        if (!selectedCategory || !selectedMode || !selectedSpec) {
                            alert('è«‹é¸æ“‡å®Œæ•´çš„é¡åˆ¥ã€æ¨¡å¼å’Œè¦æ ¼ï¼');
                            return;
                        }
                        handleAddItem({ 
                            Category: selectedCategory, 
                            Mode: selectedMode, 
                            Spec: selectedSpec, 
                            Quantity: 1 
                        });
                        setSelectedCategory('');
                        setSelectedMode('');
                        setSelectedSpec('');
                        
                    } else if (!selectedCategory || !selectedItem) {
                        alert('è«‹é¸æ“‡å®Œæ•´çš„é¡åˆ¥å’Œå“é …ï¼');
                        return;
                    } else {
                        const selectedData = filteredItems.find(d => d.Item === selectedItem);
                        const initialQuantity = typeKey === 'materials' && selectedData && selectedData.Mode === 'æ¿æ' ? 1 : 1;
                        handleAddItem({ 
                            Category: selectedCategory, 
                            Item: selectedItem, 
                            Quantity: initialQuantity, 
                            Mode: selectedData ? selectedData.Mode : undefined,
                            L: selectedData && selectedData.Mode === 'æ¿æ' ? 1 : undefined,
                            W: selectedData && selectedData.Mode === 'æ¿æ' ? 1 : undefined,
                            pcs: selectedData && selectedData.Mode === 'æ¿æ' ? 1 : undefined,
                            len: selectedData && selectedData.Mode === 'å‹é‹¼' ? 1 : undefined,
                            qty: selectedData && selectedData.Mode === 'å‹é‹¼' ? 1 : undefined,
                        });
                        setSelectedCategory('');
                        setSelectedItem('');
                    }
                };

                return (
                    <div className="flex flex-wrap items-center gap-2 p-3 bg-white border-t border-gray-200 print-hidden">
                        <select value={selectedCategory} onChange={handleCategoryChange} className="p-2 border rounded">
                            <option value="">é¸æ“‡åˆ†é¡</option>
                            {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                        </select>
                        
                        {typeKey === 'installation' && (
                             <select value={selectedMode} onChange={handleModeChange} className="p-2 border rounded">
                                <option value="">é¸æ“‡æ¨¡å¼(Mode)</option>
                                {modes.map(mode => <option key={mode} value={mode}>{mode}</option>)}
                            </select>
                        )}

                        {(typeKey !== 'installation') && selectedCategory && (
                            <select value={selectedItem} onChange={(e) => setSelectedItem(e.target.value)} className="p-2 border rounded">
                                <option value="">é¸æ“‡å“é …</option>
                                {filteredItems.map(item => <option key={item.Item} value={item.Item}>{item.Item}</option>)}
                            </select>
                        )}
                        
                        {typeKey === 'installation' && selectedCategory && selectedMode && (
                            <select value={selectedSpec} onChange={(e) => setSelectedSpec(e.target.value)} className="p-2 border rounded">
                                <option value="">é¸æ“‡è¦æ ¼(Spec)</option>
                                {specs.map(spec => <option key={spec} value={spec}>{spec}</option>)}
                            </select>
                        )}

                        <button onClick={handleAdd} className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150" disabled={
                            typeKey === 'installation' ? (!selectedSpec) : (!selectedItem)
                        }>
                            æ–°å¢é …ç›®
                        </button>
                    </div>
                );
            };

            return (
                <div className="mb-6 border border-gray-200 rounded-lg shadow-md overflow-hidden">
                    <h3 className="bg-gray-800 text-white text-lg font-semibold p-3">{CATEGORIES[typeKey]}</h3>
                    
                    <div className="p-4 overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr className="bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th className="px-3 py-3">é¡åˆ¥</th>
                                    <th className="px-3 py-3">{typeKey === 'installation' ? 'æ¨¡å¼/å“é …' : 'å“é …'}</th>
                                    {typeKey === 'installation' && <th className="px-3 py-3">è¦æ ¼</th>}
                                    <th className="px-3 py-3 text-right">å–®åƒ¹</th>
                                    <th className="px-3 py-3">{typeKey === 'materials' ? 'é•·å¯¬/æ•¸é‡' : 'æ•¸é‡'}</th>
                                    {typeKey === 'materials' && <th className="px-3 py-3 text-right">é¢ç©/é‡é‡</th>}
                                    <th className="px-3 py-3 text-right">å°è¨ˆ (TWD)</th>
                                    <th className="px-3 py-3 text-center print-hidden">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200 text-sm">
                                {sheetItems.map((item, index) => {
                                    const { subtotal, calculatedWeight, price } = calculateCostDetail(item, sheetData);
                                    
                                    return (
                                        <tr key={item.id} className="hover:bg-gray-50">
                                            <td className="px-3 py-4 whitespace-nowrap">{item.Category}</td>
                                            <td className="px-3 py-4 whitespace-nowrap">{item.Item || item.Mode}</td>
                                            {typeKey === 'installation' && <td className="px-3 py-4 whitespace-nowrap">{item.Spec}</td>}
                                            <td className="px-3 py-4 whitespace-nowrap text-right">
                                                {price.toFixed(2)}
                                                {item.forcedPrice > 0 && <span className="text-red-500 ml-1 text-xs">(F)</span>}
                                            </td>
                                            <td className="px-3 py-4 whitespace-nowrap flex space-x-1">
                                                {renderInputs(item, index)}
                                            </td>
                                            {typeKey === 'materials' && (
                                                <td className="px-3 py-4 whitespace-nowrap text-right text-xs">
                                                    {item.Mode === 'æ¿æ' ? `Area: ${(item.L * item.W * item.pcs || 0).toFixed(2)} mÂ²` : ''}
                                                    {item.Mode === 'å‹é‹¼' ? `Length: ${(item.len * item.qty || 0).toFixed(2)} m` : ''}
                                                    {(item.Mode === 'æ¿æ' || item.Mode === 'å‹é‹¼') ? <><br/>{`Weight: ${calculatedWeight.toFixed(2)} kg`}</> : ''}
                                                    {item.Mode !== 'æ¿æ' && item.Mode !== 'å‹é‹¼' && `Qty: ${item.Quantity || 0}`}
                                                </td>
                                            )}
                                            <td className="px-3 py-4 whitespace-nowrap text-right font-semibold text-indigo-600">
                                                {subtotal.toFixed(2)}
                                            </td>
                                            <td className="px-3 py-4 whitespace-nowrap text-center space-x-2 print-hidden">
                                                <button 
                                                    onClick={() => setEditingItem(item)}
                                                    className="text-blue-600 hover:text-blue-800 font-medium text-sm"
                                                    title="ç·¨è¼¯æ•¸é‡æˆ–å¼·åˆ¶å–®åƒ¹"
                                                >
                                                    ç·¨è¼¯
                                                </button>
                                                <button 
                                                    onClick={() => handleDeleteItem(item.id)} 
                                                    className="text-red-600 hover:text-red-900 font-medium text-sm"
                                                    title="åˆªé™¤é …ç›®"
                                                >
                                                    åˆªé™¤
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                                {sheetItems.length === 0 && (
                                    <tr>
                                        <td colSpan={typeKey === 'installation' ? 8 : 7} className="px-6 py-4 text-center text-gray-500">
                                            æ­¤å·¥ç¨‹ç›®å‰æ²’æœ‰ {CATEGORIES[typeKey]} é …ç›®ã€‚
                                        </td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    
                    <AddItemForm />

                    {/* ç¸½è¨ˆå€å¡Šå¢åŠ æ‰‹å‹•èª¿æ•´ */}
                    <div className="bg-gray-100 p-3 text-right text-lg font-bold border-t border-gray-200 flex justify-end items-center space-x-4">
                        <div className="flex items-center space-x-2 print-hidden">
                             <span className="text-gray-800 text-base font-medium">æ‰‹å‹•èª¿æ•´ (Â±):</span>
                            <input
                                type="number"
                                value={manualAdjustValue}
                                onChange={handleAdjustChange}
                                className="w-24 text-right p-1 border rounded text-sm font-normal"
                                step="1"
                            />
                        </div>
                        <span className="text-gray-800">{CATEGORIES[typeKey]} ç¸½è¨ˆ (å«èª¿æ•´):</span>
                        <span className="text-red-600">
                            {finalTotal.toFixed(2)} TWD
                            {typeKey === 'materials' && (
                                <span className="text-sm text-gray-600 ml-3"> (ç¸½é‡: {totalWeight.toFixed(2)} kg)</span>
                            )}
                        </span>
                        
                         {/* åˆ—å°æ™‚é¡¯ç¤ºèª¿æ•´å€¼ */}
                         <span className="hidden print-content text-sm text-gray-600">
                             (èª¿æ•´å€¼: {manualAdjustValue.toFixed(2)} TWD)
                        </span>
                    </div>

                    {editingItem && (
                        <EditItemModal 
                            item={editingItem}
                            sheetData={sheetData}
                            onClose={() => setEditingItem(null)}
                            onSave={handleSaveEdit}
                        />
                    )}
                </div>
            );
        };
        
        // SummaryPage (ç¸½è¡¨ + åœ“é¤…åœ–) (æœªè®Šå‹•)
        const SummaryPage = ({ projects, currentProjectName, updateCurrentProject, sheetData, handleExportToExcel, handlePrint }) => {
            const currentProject = projects[currentProjectName];
            const allItems = currentProject.allItems;
            const chartRef = useRef(null);

            // è¨ˆç®—äº”å¤§é¡åˆ¥ç¸½å’Œ (åŒ…å«å„è‡ªçš„æ‰‹å‹•èª¿æ•´)
            const categoryTotals = useMemo(() => {
                const totals = { materials: 0, purchased: 0, production: 0, transportation: 0, installation: 0 };
                
                allItems.forEach(item => {
                    const sheetItems = sheetData[item.typeKey] || [];
                    const { subtotal } = calculateCostDetail(item, sheetItems);
                    totals[item.typeKey] += subtotal;
                });
                
                // åŠ ä¸Šå„é¡åˆ¥çš„æ‰‹å‹•èª¿æ•´
                ALL_ADJUST_KEYS.forEach(key => {
                    totals[key] += currentProject.manualAdjust[key] || 0;
                });

                return totals;
            }, [allItems, sheetData, currentProject.manualAdjust]);
            
            // è¨ˆç®—ç¸½å’Œ
            const totalSum = useMemo(() => {
                return Object.values(categoryTotals).reduce((sum, total) => sum + total, 0);
            }, [categoryTotals]);

            // åº•éƒ¨åŠ ç¸½å„ªåŒ–: ç®¡éŠ·/å ±åƒ¹è¨ˆç®—
            const baseCost = totalSum; // åŸºç¤æˆæœ¬ç¾åœ¨å·²ç¶“åŒ…å«æ‰€æœ‰çš„ç´°é …èª¿æ•´
            const adminFee = baseCost * currentProject.adminFeeRate;
            const finalCostWithAdmin = baseCost + adminFee;
            
            const suggestedQuote = currentProject.profitRate < 1 ? 
                finalCostWithAdmin / (1 - currentProject.profitRate) : 
                finalCostWithAdmin;
                

            // ç®¡éŠ·è²»ç”¨ä¿®æ”¹
            const handleAdminFeeChange = (e) => {
                const value = parseFloat(e.target.value) || 0;
                updateCurrentProject(proj => ({
                    ...proj,
                    adminFeeRate: value / 100
                }));
            };
            
            // å»ºè­°å ±åƒ¹æ¯›åˆ©ç‡ä¿®æ”¹
            const handleProfitRateChange = (e) => {
                const value = parseFloat(e.target.value) || 0;
                updateCurrentProject(proj => ({
                    ...proj,
                    profitRate: value / 100
                }));
            };


            // åœ“é¤…åœ–æ¸²æŸ“
            useEffect(() => {
                const ctx = document.getElementById('costPieChart');
                if (!ctx) return;
                
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const labels = ALL_ADJUST_KEYS.map(key => CATEGORIES[key]);
                const dataValues = ALL_ADJUST_KEYS.map(key => parseFloat(categoryTotals[key].toFixed(2)));
                
                const backgroundColors = [
                    '#4F46E5', '#06B6D4', '#F59E0B', '#10B981', '#EF4444', 
                ];
                
                const data = {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                };
                
                const config = {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: `å·¥ç¨‹æˆæœ¬åˆ†ä½ˆ - ${currentProjectName}`,
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.parsed;
                                        const percentage = ((value / totalSum) * 100).toFixed(1) + '%';
                                        return `${label} ${value.toLocaleString()} TWD (${percentage})`;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#fff',
                                formatter: (value, context) => {
                                    const percentage = ((value / totalSum) * 100).toFixed(1) + '%';
                                    return percentage;
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                };
                
                chartRef.current = new Chart(ctx, config);

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [categoryTotals, currentProjectName, totalSum]);


            return (
                <div className="p-6 bg-white rounded-lg shadow-2xl print-content">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6 border-b-4 border-indigo-600 pb-2 flex justify-between items-center">
                        <span>ğŸ’° æˆæœ¬ç¸½è¦½ - {currentProjectName}</span>
                        {/* æ‹†åˆ†æŒ‰éˆ• */}
                        <div className="space-x-2 print-hidden">
                            <button
                                onClick={() => handlePrint()}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-150 text-sm"
                            >
                                ğŸ–¨ï¸ åˆ—å°å ±è¡¨
                            </button>
                            <button
                                onClick={() => handleExportToExcel(currentProjectName, categoryTotals, currentProject, finalCostWithAdmin, suggestedQuote, sheetData)}
                                className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 text-sm"
                            >
                                ğŸ“‘ è¼¸å‡º Excel
                            </button>
                        </div>
                    </h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* ç¸½è¡¨ */}
                        <div className="print-content">
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">æˆæœ¬çµç®—æ˜ç´° (å«å„é …æ‰‹å‹•èª¿æ•´)</h3>
                            <div className="border border-gray-300 rounded-lg overflow-hidden">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡åˆ¥</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider print-hidden">æ‰‹å‹•èª¿æ•´å€¼</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡ (TWD)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {ALL_ADJUST_KEYS.map((key) => (
                                            <tr key={key}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{CATEGORIES[key]}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right print-hidden">
                                                    {currentProject.manualAdjust[key].toFixed(2).toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                                    {categoryTotals[key].toFixed(2).toLocaleString()}
                                                </td>
                                            </tr>
                                        ))}
                                        {/* åŸºç¤æˆæœ¬ç¸½è¨ˆ (åŒ…å«æ‰€æœ‰ç´°é …èª¿æ•´) */}
                                        <tr className="bg-indigo-50 font-bold">
                                            <td className="px-6 py-4 whitespace-nowrap text-base text-indigo-800">åŸºç¤æˆæœ¬ç¸½è¨ˆ</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-base text-indigo-800 text-right print-hidden">-</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-base text-indigo-800 text-right">
                                                {baseCost.toFixed(2).toLocaleString()}
                                            </td>
                                        </tr>
                                        {/* ç®¡éŠ·è²»ç”¨ */}
                                        <tr>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center print-hidden">
                                                ç®¡éŠ·è²»ç”¨
                                                <input
                                                    type="number"
                                                    value={(currentProject.adminFeeRate * 100).toFixed(0)}
                                                    onChange={handleAdminFeeChange}
                                                    className="w-16 text-right p-1 border rounded ml-2 text-sm"
                                                    step="1" min="0" max="100"
                                                />
                                                <span className="ml-1 text-xs">%</span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-right print-hidden">-</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-right">
                                                +{adminFee.toFixed(2).toLocaleString()}
                                            </td>
                                        </tr>
                                        {/* æœ€çµ‚ç¸½æˆæœ¬ */}
                                        <tr className="bg-red-100 font-extrabold">
                                            <td className="px-6 py-4 whitespace-nowrap text-xl text-red-800">æœ€çµ‚ç¸½æˆæœ¬ (å«ç®¡éŠ·)</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xl text-red-800 text-right print-hidden">-</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xl text-red-800 text-right">
                                                {finalCostWithAdmin.toFixed(2).toLocaleString()} TWD
                                            </td>
                                        </tr>
                                        {/* å»ºè­°å ±åƒ¹ */}
                                        <tr className="bg-indigo-600 text-white font-extrabold">
                                            <td className="px-6 py-4 whitespace-nowrap text-xl print-hidden">
                                                å»ºè­°å ±åƒ¹ (æ¯›åˆ©ç‡: 
                                                <input
                                                    type="number"
                                                    value={(currentProject.profitRate * 100).toFixed(0)}
                                                    onChange={handleProfitRateChange}
                                                    className="w-12 text-right p-1 border rounded ml-1 text-sm text-gray-800"
                                                    step="1" min="0" max="99"
                                                />
                                                %)
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xl text-white text-right print-hidden">-</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xl text-white text-right">
                                                {suggestedQuote.toFixed(2).toLocaleString()} TWD
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* åœ“é¤…åœ– */}
                        <div className="print-hidden"> 
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">æˆæœ¬åˆ†ä½ˆåœ“é¤…åœ–</h3>
                            <div className="chart-container bg-gray-50 p-4 rounded-lg shadow-inner">
                                <canvas id="costPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-8 pt-4 border-t border-gray-300 text-sm text-gray-600 print-hidden">
                        * æ‰€æœ‰æ•¸æ“šçš†ä»¥ **{currentProjectName}** å·¥ç¨‹çš„è³‡æ–™ç‚ºæº–ã€‚
                    </div>
                </div>
            );
        };
        
        // è¼¸å‡º Excel å‡½å¼ (æœªè®Šå‹•)
        const handleExportToExcel = (projectName, categoryTotals, projectData, finalCostWithAdmin, suggestedQuote, allData) => {
            if (!window.XLSX) {
                alert("XLSX å‡½å¼åº«æœªè¼‰å…¥ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
                return;
            }

            const wb = XLSX.utils.book_new();
            const baseCostSum = Object.values(categoryTotals).reduce((s, v) => s + v, 0);

            // 1. è¼¸å‡ºæˆæœ¬ç¸½è¦½é  (Summary Sheet)
            const summaryData = [
                ["å·¥ç¨‹åç¨±:", projectName],
                ["", ""],
                ["æˆæœ¬é …ç›®", "æ‰‹å‹•èª¿æ•´å€¼", "ç¸½é‡‘é¡ (TWD)"],
                ...ALL_ADJUST_KEYS.map(key => [
                    CATEGORIES[key], 
                    projectData.manualAdjust[key].toFixed(2), 
                    categoryTotals[key].toFixed(2)
                ]),
                ["", "", ""],
                ["åŸºç¤æˆæœ¬ç¸½è¨ˆ", "", baseCostSum.toFixed(2)],
                ["", "", ""],
                ["ç®¡éŠ·è²»ç”¨ (" + (projectData.adminFeeRate * 100).toFixed(0) + "%)", "", (finalCostWithAdmin - baseCostSum).toFixed(2)],
                ["æœ€çµ‚ç¸½æˆæœ¬ (å«ç®¡éŠ·)", "", finalCostWithAdmin.toFixed(2)],
                ["", "", ""],
                ["å»ºè­°å ±åƒ¹ (æ¯›åˆ©ç‡ " + (projectData.profitRate * 100).toFixed(0) + "%)", "", suggestedQuote.toFixed(2)],
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "æˆæœ¬ç¸½è¦½");

            // 2. è¼¸å‡ºæ¯å€‹æ˜ç´°é  (Detail Sheets)
            DATA_KEYS.forEach(typeKey => {
                const sheetItems = projectData.allItems.filter(item => item.typeKey === typeKey);
                const sheetData = allData[typeKey] || [];
                const sheetName = CATEGORIES[typeKey].split(' ')[1];

                const detailHeader = [
                    "é¡åˆ¥",
                    (typeKey === 'installation' ? 'æ¨¡å¼/å“é …' : 'å“é …'),
                    ...(typeKey === 'installation' ? ['è¦æ ¼'] : []),
                    "æ•¸é‡å–®ä½",
                    "æ•¸é‡",
                    "å–®åƒ¹ (TWD)",
                    "æ˜¯å¦å¼·åˆ¶å–®åƒ¹",
                    ...(typeKey === 'materials' ? ['é•·/å¯¬ (L/W)', 'pcs/qty', 'ç¸½é‡ (kg)'] : []),
                    "å°è¨ˆ (TWD)"
                ];

                const detailRows = sheetItems.map(item => {
                    const { subtotal, calculatedWeight, price } = calculateCostDetail(item, sheetData);
                    
                    let quantityValue = item.Quantity || 0;
                    let quantityUnit = "å–®ä½";
                    let sizeInfo = '';
                    let weightInfo = '';

                    if (typeKey === 'materials') {
                        if (item.Mode === 'æ¿æ') {
                            quantityUnit = 'mÂ²/pcs';
                            quantityValue = (item.L * item.W * item.pcs || 0).toFixed(2);
                            sizeInfo = `${item.L || 0} / ${item.W || 0}`;
                            weightInfo = calculatedWeight.toFixed(2);
                        } else if (item.Mode === 'å‹é‹¼') {
                            quantityUnit = 'm/qty';
                            quantityValue = (item.len * item.qty || 0).toFixed(2);
                            sizeInfo = `len: ${item.len || 0}`;
                            weightInfo = calculatedWeight.toFixed(2);
                        } else {
                            quantityUnit = 'å–®ä½';
                            sizeInfo = '';
                            weightInfo = '';
                        }
                    }

                    const baseRow = [
                        item.Category,
                        item.Item || item.Mode,
                        ...(typeKey === 'installation' ? [item.Spec || ''] : []),
                        quantityUnit,
                        quantityValue,
                        price.toFixed(2),
                        item.forcedPrice > 0 ? "æ˜¯" : "å¦",
                    ];

                    if (typeKey === 'materials') {
                        return [...baseRow, sizeInfo, item.pcs || item.qty || 0, weightInfo, subtotal.toFixed(2)];
                    }

                    return [...baseRow, subtotal.toFixed(2)];
                });
                
                // è¨ˆç®—ç´°é …ç¸½å’Œ (ä¸å«æ‰‹å‹•èª¿æ•´)
                const totalSubtotal = detailRows.reduce((sum, row) => {
                    const lastValue = row[row.length - 1];
                    return sum + (parseFloat(lastValue) || 0);
                }, 0);
                
                // ç²å–æ‰‹å‹•èª¿æ•´å€¼
                const manualAdjustValue = projectData.manualAdjust[typeKey] || 0;
                const finalCategoryTotal = totalSubtotal + manualAdjustValue;

                const finalRows = [
                    detailHeader,
                    ...detailRows,
                    ["", "", "", "", "", "", "", ""],
                    ...typeKey === 'materials' ? [
                         ["ç¸½é‡:", "", "", "", "", "", "", "", "", sheetItems.reduce((sum, item) => sum + calculateCostDetail(item, sheetData).calculatedWeight, 0), ""],
                    ] : [],
                    ["è©¦ç®—ç¸½è¨ˆ (ä¸å«èª¿æ•´):", "", "", "", "", "", "", "", totalSubtotal.toFixed(2)],
                    ["æ‰‹å‹•èª¿æ•´å€¼:", manualAdjustValue.toFixed(2), "", "", "", "", "", "", ""],
                    ["ç¸½è¨ˆ (å«èª¿æ•´):", "", "", "", "", "", "", "", finalCategoryTotal.toFixed(2)]
                ];

                const wsDetail = XLSX.utils.aoa_to_sheet(finalRows);
                XLSX.utils.book_append_sheet(wb, wsDetail, sheetName);
            });

            // è¼¸å‡ºæª”æ¡ˆ
            try {
                XLSX.writeFile(wb, `${projectName}_æˆæœ¬å ±è¡¨_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '')}.xlsx`);
            } catch (error) {
                console.error("Excel è¼¸å‡ºå¤±æ•—:", error);
                alert("Excel è¼¸å‡ºå¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–æª”æ¡ˆåç¨±ã€‚");
            }
        };

        // åˆ—å°å ±è¡¨å‡½å¼ (æœªè®Šå‹•)
        const handlePrint = () => {
             // éš±è—åœ–è¡¨
             const chartCanvas = document.getElementById('costPieChart');
             if (chartCanvas) {
                chartCanvas.style.display = 'none';
             }

            // ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿåˆ—å°åŠŸèƒ½
            window.print();
            
             // åˆ—å°å®Œæˆå¾Œæ¢å¾©åœ–è¡¨é¡¯ç¤º
             if (chartCanvas) {
                chartCanvas.style.display = 'block';
             }
        };


        // --- Main App Component ---

        const App = () => {
            const TABS_ORDER = [
                'materials', 'purchased', 'production', 'transportation', 'installation', 'summary'
            ];
            
            const [activeTab, setActiveTab] = useState('summary');
            const { data: sheetData, syncTime, isLoading } = useDataSynchronization();
            const { 
                projects, currentProjectName, currentProject, 
                updateCurrentProject, updateManualAdjust, addProject, deleteProject, switchProject 
            } = useProjectManagement();

            const renderContent = () => {
                if (isLoading) {
                    return <div className="text-center p-10 text-xl text-indigo-600">è¼‰å…¥ Google Sheet è³‡æ–™ä¸­...</div>;
                }
                
                if (activeTab === 'summary') {
                    return <SummaryPage 
                                projects={projects} 
                                currentProjectName={currentProjectName} 
                                updateCurrentProject={updateCurrentProject} 
                                sheetData={sheetData} 
                                handleExportToExcel={handleExportToExcel}
                                handlePrint={handlePrint} 
                            />;
                }
                
                const typeKey = activeTab;
                if (!DATA_KEYS.includes(typeKey)) return <div className="text-center p-10 text-xl text-red-500">åˆ†é éŒ¯èª¤</div>;

                return <BaseSheet 
                            typeKey={typeKey} 
                            data={sheetData} 
                            currentProject={currentProject} 
                            updateCurrentProject={updateCurrentProject}
                            updateManualAdjust={updateManualAdjust}
                        />;
            };
            
            const tabs = TABS_ORDER.map(key => ({
                key,
                label: key === 'summary' ? 'ğŸ“Š æˆæœ¬ç¸½è¦½' : CATEGORIES[key]
            }));
            
            return (
                <div className="min-h-screen bg-gray-50 flex flex-col">
                    <header className="print-hidden">
                        <ProjectSelector 
                            projects={projects} 
                            currentProjectName={currentProjectName} 
                            switchProject={switchProject} 
                            addProject={addProject} 
                            deleteProject={deleteProject} 
                        />
                        
                        {/* Tab Navigation */}
                        <nav className="bg-white shadow sticky top-0 z-10 border-b border-gray-200">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex justify-between h-16">
                                    <div className="flex">
                                        {tabs.map(tab => (
                                            <button
                                                key={tab.key}
                                                onClick={() => setActiveTab(tab.key)}
                                                className={`
                                                    inline-flex items-center px-1 pt-1 border-b-4 text-sm font-medium transition duration-150 ease-in-out
                                                    ${activeTab === tab.key 
                                                        ? 'border-indigo-500 text-indigo-600 font-bold' 
                                                        : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'
                                                    }
                                                `}
                                            >
                                                {tab.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </header>
                    
                    <main className="flex-grow max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 w-full">
                        {renderContent()}
                    </main>

                    {/* Footer / Sync Info & CSV URLs */}
                    <footer className="bg-gray-100 border-t border-gray-200 mt-auto p-4 text-xs text-gray-600 print-hidden">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <h3 className="font-bold text-sm text-gray-700 mb-2">Google Sheet è³‡æ–™åº«è³‡è¨Š:</h3>
                            <div className="flex flex-wrap mb-2">
                                <p className="font-semibold text-gray-700 mr-4">â„¹ï¸ è³‡æ–™åŒæ­¥ç‹€æ…‹ (æ¨¡å¼ C):</p>
                                <ul className="flex flex-wrap gap-x-4">
                                    {DATA_KEYS.map(key => (
                                        <li key={key}>
                                            <span className="font-medium text-gray-700">{CATEGORIES[key].split(' ')[1]}:</span> 
                                            {syncTime[key] ? ` æœ€å¾ŒåŒæ­¥æ–¼ ${syncTime[key]}` : ' å°šæœªåŒæ­¥'}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                            
                            <div className="mt-3">
                                <p className="font-semibold text-gray-700 mb-1">ğŸ”— è³‡æ–™åº« CSV é€£çµè·¯å¾‘ (URL):</p>
                                <ul className="space-y-1">
                                    {DATA_KEYS.map(key => (
                                        <li key={`url-${key}`} className="break-all">
                                            <span className="font-medium text-indigo-600">{CATEGORIES[key]}:</span> 
                                            <a href={BASE_CSV_URLS[key]} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline ml-1">
                                                {BASE_CSV_URLS[key]}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
