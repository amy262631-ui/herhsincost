<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å·¥ç¨‹äº”å¤§æˆæœ¬è©¦ç®—ç³»çµ±ï¼ˆC-2 ç‰ˆï¼‰</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React 18 -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<!-- Babel Standalone -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js + DataLabels æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  
  <!-- Excel åŒ¯å‡ºç”¨ SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { background-color: #f3f4f6; }
    .print-hidden { display: block; }
    @media print {
      .print-hidden { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- React Root -->
  <div id="root"></div>

  <!-- Main Application Script -->
  <script type="text/babel">
/****************************************************
 * PART 1 â€” å…¨åŸŸå¸¸æ•¸ã€å·¥å…·å‡½å¼ï¼ˆå«é‡‘é¡åƒåˆ†ä½è¡¨ç¤ºï¼‰
 ****************************************************/

// Google Sheet CSV URLs
const CSV_URLS = {
  material: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",
  purchase: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",
  fabrication: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",
  transport: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",
  install: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv"
};

// é‡‘é¡åƒåˆ†ä½æ ¼å¼åŒ–
function formatMoney(num) {
  if (isNaN(num)) return "0";
  return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// é‡é‡å°æ•¸å…©ä½
function formatWeight(num) {
  if (isNaN(num)) return "0.00";
  return Number(num).toFixed(2);
}

// CSV è§£æ
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim());
    return obj;
  });
}
function parseTransportRow(r) {
  return {
    category: r[0],     // è»Šç¨®
    spec: r[1],         // é …ç›®
    region: r[2],       // åœ°å€ï¼ˆå—/åŒ—/ä¸­ï¼‰
    unit: r[3],         // å–®ä½ï¼ˆå°ï¼‰
    price: Number(r[4] || 0)  // å–®åƒ¹ï¼ˆæ•¸å­—ï¼‰
  };
}

/****************************************************
 * PART X â€” å·¥ç¨‹è³‡æ–™å„²å­˜ / è®€å–
 ****************************************************/

// äº”å¤§æˆæœ¬çš„æ‰‹å‹•èª¿æ•´é è¨­å€¼ï¼ˆæ–°ç‰ˆï¼šç‰©ä»¶çµæ§‹ï¼‰
const defaultManualAdjust = {
  material: 0,
  purchase: 0,
  fabrication: 0,
  transport: 0,
  install: 0
};

// å„²å­˜å·¥ç¨‹è³‡æ–™åˆ° localStorage
function saveProjects(data) {
  localStorage.setItem("projects_v3", JSON.stringify(data));
}

// è¼‰å…¥å·¥ç¨‹è³‡æ–™
function loadProjects() {
  const raw = localStorage.getItem("projects_v3");
  if (!raw) return {};

  const parsed = JSON.parse(raw);

  // ğŸ”§ ä¿è­‰æ¯å€‹å·¥ç¨‹éƒ½åŒ…å«æ–°ç‰ˆ manualAdjust ç‰©ä»¶
  for (const key in parsed) {
    if (!parsed[key].manualAdjust || typeof parsed[key].manualAdjust !== "object") {
      parsed[key].manualAdjust = { ...defaultManualAdjust };
    }
    if (!parsed[key].allItems) parsed[key].allItems = [];
  }
  return parsed;
}

 /****************************************************
 * PART 2 â€” å¤šå·¥ç¨‹ç®¡ç† ProjectManagerï¼ˆç¬¬ 2 æ®µï¼‰
 ****************************************************/

// å¤šå·¥ç¨‹ç®¡ç†
function ProjectManager({ currentProject, setCurrentProject, projects, setProjects }) {

  // æ–°å¢å·¥ç¨‹
  function addProject() {
    const name = prompt("è«‹è¼¸å…¥å·¥ç¨‹åç¨±ï¼š");
    if (!name) return;

    if (projects[name]) {
      alert("å·¥ç¨‹åç¨±å·²å­˜åœ¨ï¼");
      return;
    }

    const updated = {
      ...projects,
      [name]: {
        allItems: [],
        manualAdjust: 0   // â˜… æ­£ç¢ºå¯«æ³•
      }
    };

    setProjects(updated);
    setCurrentProject(name);
    saveProjects(updated);
  }

  // åˆªé™¤å·¥ç¨‹
  function deleteProject(name) {
    if (!window.confirm(`ç¢ºå®šåˆªé™¤å·¥ç¨‹ã€Œ${name}ã€ï¼Ÿ`)) return;

    const updated = { ...projects };
    delete updated[name];

    const next = Object.keys(updated)[0] || "";
    setProjects(updated);
    setCurrentProject(next);
    saveProjects(updated);
  }

  return (
    <div className="bg-white p-4 rounded shadow mb-4 print-hidden">
      <h2 className="text-lg font-bold mb-3">å·¥ç¨‹ç®¡ç†</h2>

      <div className="flex flex-wrap gap-2">

        {Object.keys(projects).map(key => (
          <button
            key={key}
            onClick={() => setCurrentProject(key)}
            className={
              "px-3 py-1 rounded border " +
              (currentProject === key
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {key}
          </button>
        ))}

        <button
          onClick={addProject}
          className="px-3 py-1 rounded bg-green-600 text-white font-bold"
        >
          ï¼‹ æ–°å¢å·¥ç¨‹
        </button>

        {currentProject && (
          <button
            onClick={() => deleteProject(currentProject)}
            className="px-3 py-1 rounded bg-red-600 text-white"
          >
            åˆªé™¤ç›®å‰å·¥ç¨‹
          </button>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * PART 4 â€” MaterialsPageï¼ˆè‡ªå‹•é€£å‹• Google Sheetï¼‰
 * æ”¯æ´æ¿æ + å‹é‹¼æ¨¡å¼
 ****************************************************/
function MaterialsPage({ materialDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [length, setLength] = React.useState("");
  const [width, setWidth] = React.useState("");
  const [pcs, setPcs] = React.useState("");

  /* ===== åˆ†é¡é¸å–® ===== */
  const categories = React.useMemo(() => {
    const s = new Set();
    materialDB.forEach(r => s.add(r.category));
    return [...s];
  }, [materialDB]);

  /* ===== è¦æ ¼é¸å–® ===== */
  const specs = React.useMemo(() => {
    return materialDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, materialDB]);

  /* ===== æ‰¾å‡ºç•¶å‰é¸å®š row ===== */
  const selectedRow = React.useMemo(() => {
    return materialDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, materialDB]);

  const unitWeight = selectedRow ? Number(selectedRow.weight) : 0;
  const price = selectedRow ? Number(selectedRow.price) : 0;

  /* ===== åˆ¤æ–·æ˜¯å¦ç‚ºæ¿æ ===== */
  const isPlate = category.includes("æ¿");

  /* ===== è¨ˆç®—é‡é‡ ===== */
  const calcWeight = () => {
    const L = parseFloat(length) || 0;
    const W = parseFloat(width) || 0;
    const P = parseFloat(pcs) || 0;
    const U = Number(unitWeight);

    if (!selectedRow) return 0;

    if (isPlate) {
      return L * W * U * P;
    } else {
      return L * U * P;
    }
  };

  const weight = calcWeight();
  const subtotal = Math.round(weight * price);

  /* ===== æ–°å¢ ===== */
  function addMaterial() {
    if (!category || !spec) return alert("è«‹é¸æ“‡åˆ†é¡èˆ‡è¦æ ¼");
    if (!length || !pcs) return alert("è«‹è¼¸å…¥é•·åº¦èˆ‡æ”¯/ç‰‡æ•¸");

    if (isPlate && !width) return alert("æ¿æéœ€è¦è¼¸å…¥å¯¬åº¦");

    const newItem = {
      type: "ææ–™",
      category,
      spec,
      length: Number(length),
      width: isPlate ? Number(width) : null,
      pcs: Number(pcs),
      unitWeight,
      weight,
      price,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, newItem]
    });

    // æ¸…é™¤
    setSpec("");
    setLength("");
    setWidth("");
    setPcs("");
  }

  /* ===== åˆªé™¤ ===== */
  function deleteMaterial(indexInTable) {
    const materials = projectData.allItems.filter(i => i.type === "ææ–™");
    const itemToDelete = materials[indexInTable];

    const realIndex = projectData.allItems.indexOf(itemToDelete);
    if (realIndex === -1) return;

    const newArr = [...projectData.allItems];
    newArr.splice(realIndex, 1);

    setProjectData({ ...projectData, allItems: newArr });
  }

  /* ===== ææ–™åˆ—è¡¨ ===== */
  const materials = projectData.allItems.filter(i => i.type === "ææ–™");
  const totalWeight = materials.reduce((s, i) => s + (i.weight || 0), 0);

  return (
    <div className="p-4">
      <h2 className="text-xl font-bold mb-4">ææ–™æˆæœ¬æ˜ç´°</h2>

      {/* ===== è¼¸å…¥å€ï¼ˆæ©«å‘æ’åˆ—ï¼‰ ===== */}
      <div className="grid grid-cols-7 gap-3 mb-4">

        {/* åˆ†é¡ */}
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border p-2 rounded"
        >
          <option value="">åˆ†é¡</option>
          {categories.map(c => <option key={c}>{c}</option>)}
        </select>

        {/* è¦æ ¼ */}
        <select
          value={spec}
          onChange={e => setSpec(e.target.value)}
          className="border p-2 rounded"
          disabled={!category}
        >
          <option value="">è¦æ ¼</option>
          {specs.map(s => <option key={s}>{s}</option>)}
        </select>

        {/* é•·åº¦ */}
        <input
          className="border p-2 rounded"
          placeholder="é•·åº¦(m)"
          type="number"
          value={length}
          onChange={e => setLength(e.target.value)}
        />

        {/* å¯¬åº¦ï¼ˆåƒ…æ¿æï¼‰ */}
        {isPlate ? (
          <input
            className="border p-2 rounded"
            placeholder="å¯¬åº¦(m)"
            type="number"
            value={width}
            onChange={e => setWidth(e.target.value)}
          />
        ) : (
          <div className="p-2 text-gray-400 text-center">â€”</div>
        )}

        {/* æ”¯/ç‰‡ */}
        <input
          className="border p-2 rounded"
          placeholder="æ”¯/ç‰‡"
          type="number"
          value={pcs}
          onChange={e => setPcs(e.target.value)}
        />

        {/* å–®ä½é‡é‡ */}
        <div className="p-2 border rounded bg-gray-50 text-center">
          {unitWeight || "-"}
        </div>

        {/* å–®åƒ¹ */}
        <div className="p-2 border rounded bg-gray-50 text-center">
          {price || "-"}
        </div>
      </div>

      {/* æ–°å¢æŒ‰éˆ• */}
      <button
        onClick={addMaterial}
        className="px-4 py-2 bg-blue-600 text-white rounded"
      >
        ï¼‹ æ–°å¢ææ–™
      </button>

      {/* ===== è¡¨æ ¼ ===== */}
      <table className="w-full mt-6 border-collapse text-sm">
        <thead>
          <tr className="bg-gray-200">
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">é•·åº¦</th>
            <th className="border px-2 py-1">å¯¬åº¦</th>
            <th className="border px-2 py-1">æ”¯/ç‰‡</th>
            <th className="border px-2 py-1">å–®ä½é‡é‡</th>
            <th className="border px-2 py-1">é‡é‡(kg)</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">åˆªé™¤</th>
          </tr>
        </thead>

        <tbody>
          {materials.map((i, index) => (
            <tr key={index}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.length}</td>
              <td className="border px-2 py-1">{i.width ?? "-"}</td>
              <td className="border px-2 py-1">{i.pcs}</td>
              <td className="border px-2 py-1">{i.unitWeight}</td>
              <td className="border px-2 py-1">{i.weight.toFixed(2)}</td>
              <td className="border px-2 py-1">{i.price}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

              <td className="border px-2 py-1 text-center">
                <button
                  className="px-2 py-1 bg-red-600 text-white rounded"
                  onClick={() => deleteMaterial(index)}
                >
                  åˆªé™¤
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      {/* ç¸½é‡é‡ */}
      <div className="mt-4 font-bold">
        ææ–™ç¸½é‡é‡ï¼š{totalWeight.toFixed(2)} kg
      </div>
    </div>
  );
}
/****************************************************
 * PART 5 â€” PurchasePageï¼ˆå¸‚è³¼å“ï¼‰
 ****************************************************/
function PurchasePage({ purchaseDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  /* ===== ç·¨è¼¯æ¨¡å¼ç”¨ ===== */
  const [editIndex, setEditIndex] = React.useState(null);
  const [editCategory, setEditCategory] = React.useState("");
  const [editSpec, setEditSpec] = React.useState("");
  const [editQty, setEditQty] = React.useState("");
  const [editPrice, setEditPrice] = React.useState("");

  /* ===== é¸é … ===== */
  const categories = React.useMemo(() => {
    const s = new Set();
    purchaseDB.forEach(r => s.add(r.category));
    return [...s];
  }, [purchaseDB]);

  const specs = React.useMemo(
    () => purchaseDB.filter(r => r.category === category).map(r => r.spec),
    [category, purchaseDB]
  );

  const selectedRow = React.useMemo(
    () => purchaseDB.find(r => r.category === category && r.spec === spec),
    [category, spec, purchaseDB]
  );

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(price * Number(qty || 0));

  /* ===== æ–°å¢æ˜ç´° ===== */
  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡å“é …");
      return;
    }
    if (!qty) {
      alert("è«‹è¼¸å…¥æ•¸é‡");
      return;
    }

    const item = {
      type: "å¸‚è³¼å“",
      category,
      spec,
      qty: Number(qty),
      price,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, item]
    });

    setSpec("");
    setQty("");
  }

  /* ===== åˆªé™¤ ===== */
  function deletePurchase(deleteIndex) {
    let count = -1;
    let realIndex = -1;

    projectData.allItems.forEach((it, i) => {
      if (it.type === "å¸‚è³¼å“") {
        count++;
        if (count === deleteIndex) realIndex = i;
      }
    });

    if (realIndex < 0) return;

    const arr = [...projectData.allItems];
    arr.splice(realIndex, 1);

    setProjectData({ ...projectData, allItems: arr });
  }

  /* ===== ç·¨è¼¯é–‹å§‹ ===== */
  function startEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "å¸‚è³¼å“");
    const target = items[idx];

    setEditIndex(idx);
    setEditCategory(target.category);
    setEditSpec(target.spec);
    setEditQty(target.qty);
    setEditPrice(target.price);
  }

  /* ===== ç·¨è¼¯å„²å­˜ ===== */
  function saveEdit() {
    const row = purchaseDB.find(r => r.category === editCategory && r.spec === editSpec);
    let newPrice = row ? Number(row.price) : editPrice;

    if (editPrice !== "" && editPrice !== null) {
      newPrice = Number(editPrice);
    }

    const newSubtotal = Math.round(newPrice * Number(editQty));

    let count = -1;
    let realIndex = -1;

    projectData.allItems.forEach((it, i) => {
      if (it.type === "å¸‚è³¼å“") {
        count++;
        if (count === editIndex) realIndex = i;
      }
    });

    const newArr = [...projectData.allItems];
    newArr[realIndex] = {
      ...newArr[realIndex],
      category: editCategory,
      spec: editSpec,
      qty: Number(editQty),
      price: newPrice,
      subtotal: newSubtotal
    };

    setProjectData({ ...projectData, allItems: newArr });
    cancelEdit();
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditCategory("");
    setEditSpec("");
    setEditQty("");
    setEditPrice("");
  }

  /* ===== åªæŠ“å¸‚è³¼å“è³‡æ–™ ===== */
  const items = projectData.allItems.filter(i => i.type === "å¸‚è³¼å“");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">å¸‚è³¼å“</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* å“é …é¸æ“‡ */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">å“é …ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡å“é …</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* å–®ä½ / å–®åƒ¹ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>å–®ä½ï¼š{selectedRow.unit}</div>
          <div>å–®åƒ¹ï¼š<b>{price.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            value={qty}
            type="number"
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      {/* æ–°å¢ */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* ======== å¸‚è³¼å“æ˜ç´°è¡¨ ======== */}
      <h3 className="text-lg font-bold mt-6 mb-2">å¸‚è³¼å“æˆæœ¬æ˜ç´°</h3>

      <table className="table-auto w-full border mb-4">
        <thead>
          <tr className="bg-gray-100">
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, index) => (
            <tr key={index}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

              <td className="border px-2 py-1 text-center space-x-2">
                <button
                  className="px-2 py-1 bg-yellow-600 text-white rounded"
                  onClick={() => startEdit(index)}
                >
                  ç·¨è¼¯
                </button>
                <button
                  className="px-2 py-1 bg-red-600 text-white rounded"
                  onClick={() => deletePurchase(index)}
                >
                  åˆªé™¤
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      {/* ===== ç·¨è¼¯å€ ===== */}
      {editIndex !== null && (
        <div className="p-4 border rounded bg-yellow-50">
          <h3 className="text-lg font-bold mb-2">ç·¨è¼¯å¸‚è³¼å“</h3>

          <div className="mb-2">
            <label>åˆ†é¡ï¼š</label>
            <input
              className="border px-2 ml-2"
              value={editCategory}
              onChange={e => setEditCategory(e.target.value)}
            />
          </div>

          <div className="mb-2">
            <label>è¦æ ¼ï¼š</label>
            <input
              className="border px-2 ml-2"
              value={editSpec}
              onChange={e => setEditSpec(e.target.value)}
            />
          </div>

          <div className="mb-2">
            <label>æ•¸é‡ï¼š</label>
            <input
              className="border px-2 ml-2"
              value={editQty}
              type="number"
              onChange={e => setEditQty(e.target.value)}
            />
          </div>

          <div className="mb-2">
            <label>å–®åƒ¹ï¼š</label>
            <input
              className="border px-2 ml-2"
              value={editPrice}
              type="number"
              onChange={e => setEditPrice(e.target.value)}
            />
          </div>

          <div className="space-x-2 mt-2">
            <button
              className="px-3 py-1 bg-blue-600 text-white rounded"
              onClick={saveEdit}
            >
              å„²å­˜
            </button>
            <button
              className="px-3 py-1 bg-gray-500 text-white rounded"
              onClick={cancelEdit}
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      )}

    </div>
  );
}
/****************************************************
 * PART 6 â€” FabricationPageï¼ˆè£½ä½œæˆæœ¬ï¼‰
 * - é¸åˆ†é¡ â†’ é …ç›®
 * - é¡¯ç¤ºå–®ä½ / å–®åƒ¹
 * - æ•¸é‡ Ã— å–®åƒ¹ â†’ å°è¨ˆ
 * - åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
 ****************************************************/

function FabricationPage({ fabricationDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // å–å¾—åˆ†é¡
  const categories = React.useMemo(() => {
    const set = new Set();
    fabricationDB.forEach(r => set.add(r.category));
    return [...set];
  }, [fabricationDB]);

  // ä¾åˆ†é¡å¾—åˆ°é …ç›®ï¼ˆspecï¼‰
  const specs = React.useMemo(() => {
    return fabricationDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, fabricationDB]);

  // é¸åˆ°é …ç›®
  const selectedRow = React.useMemo(() => {
    return fabricationDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, fabricationDB]);

  const unitPrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(unitPrice * Number(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡é …ç›®");
      return;
    }
    if (!qty) {
      alert("è«‹è¼¸å…¥æ•¸é‡");
      return;
    }

    const item = {
      type: "è£½ä½œæˆæœ¬",
      category,
      spec,
      qty: Number(qty),
      price: unitPrice,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "è£½ä½œæˆæœ¬");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">è£½ä½œæˆæœ¬</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* é …ç›® */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">é …ç›®ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">è«‹é¸æ“‡é …ç›®</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* å–®åƒ¹é¡¯ç¤º */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>å–®ä½ï¼š{selectedRow.unit}</div>
          <div>å–®åƒ¹ï¼š<b>{unitPrice.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 ml-2 w-32 rounded"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      {/* åŠ å…¥æ˜ç´° */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* æ˜ç´°è¡¨ */}
      <h3 className="mt-6 mb-2 text-lg font-bold">è£½ä½œæˆæœ¬æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">é …ç›®</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 7 â€” TransportPageï¼ˆé‹è¼¸è²»ç”¨ï¼‰
 * - é¸åˆ†é¡ â†’ é …ç›®
 * - é¡¯ç¤ºåœ°å€ã€å–®ä½ã€å–®åƒ¹
 * - æ•¸é‡ Ã— å–®åƒ¹ â†’ å°è¨ˆ
 * - åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
 ****************************************************/

function TransportPage({ transportDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // å–å¾—åˆ†é¡
  const categories = React.useMemo(() => {
    const s = new Set();
    transportDB.forEach(r => s.add(r.category));
    return [...s];
  }, [transportDB]);

  // è¦æ ¼
  const specs = React.useMemo(() => {
    return transportDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, transportDB]);

  // é¸åˆ°çš„è³‡æ–™
  const selectedRow = React.useMemo(() => {
    return transportDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, transportDB]);

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(price * Number(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡é …ç›®");
      return;
    }
    if (!qty) {
      alert("è«‹è¼¸å…¥æ•¸é‡");
      return;
    }

    const item = {
      type: "é‹è¼¸è²»ç”¨",
      category,
      spec,
      region: selectedRow?.region || "",
      qty: Number(qty),
      price,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "é‹è¼¸è²»ç”¨");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">é‹è¼¸è²»ç”¨</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">è»Šç¨® / åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* é …ç›® */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">é …ç›®ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">è«‹é¸æ“‡é …ç›®</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* é¡¯ç¤ºåœ°å€ã€å–®åƒ¹ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>åœ°å€ï¼š{selectedRow.region || "â€”"}</div>
          <div>å–®ä½ï¼š{selectedRow.unit}</div>
          <div>å–®åƒ¹ï¼š<b>{price.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 ml-2 rounded w-32"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      {/* åŠ å…¥æ˜ç´° */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* æ˜ç´°è¡¨ */}
      <h3 className="mt-6 mb-2 text-lg font-bold">é‹è¼¸è²»ç”¨æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">é …ç›®</th>
            <th className="border px-2 py-1">åœ°å€</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.region}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 8 â€” InstallPageï¼ˆç¾å ´å®‰è£ï¼‰
 * - é¸åˆ†é¡ â†’ è¦æ ¼
 * - é¡¯ç¤ºå–®ä½ / å–®åƒ¹
 * - æ•¸é‡ Ã— å–®åƒ¹ â†’ å°è¨ˆ
 * - åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
 ****************************************************/

function InstallPage({ installDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // å–å¾—åˆ†é¡æ¸…å–®
  const categories = React.useMemo(() => {
    const s = new Set();
    installDB.forEach(r => s.add(r.category));
    return [...s];
  }, [installDB]);

  // å–å¾—è¦æ ¼æ¸…å–®
  const specs = React.useMemo(() => {
    return installDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, installDB]);

  // é¸ä¸­çš„è³‡æ–™åˆ—
  const selectedRow = React.useMemo(() => {
    return installDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, installDB]);

  const price = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(price * Number(qty || 0));

  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡é …ç›®");
      return;
    }
    if (!qty) {
      alert("è«‹è¼¸å…¥æ•¸é‡");
      return;
    }

    const item = {
      type: "ç¾å ´å®‰è£",
      category,
      spec,
      qty: Number(qty),
      price,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  const items = projectData.allItems.filter(i => i.type === "ç¾å ´å®‰è£");

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">ç¾å ´å®‰è£</h2>

      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* è¦æ ¼ */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">è¦æ ¼ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡è¦æ ¼</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* å–®åƒ¹é¡¯ç¤º */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          <div>å–®ä½ï¼š{selectedRow.unit}</div>
          <div>å–®åƒ¹ï¼š<b>{price.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š
          <b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      {/* åŠ å…¥æ˜ç´° */}
      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* å®‰è£æ˜ç´°è¡¨ */}
      <h3 className="mt-6 mb-2 text-lg font-bold">ç¾å ´å®‰è£æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>
              <td className="border px-2 py-1">{i.spec}</td>
              <td className="border px-2 py-1">{i.qty}</td>
              <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>

    </div>
  );
}
/****************************************************
 * PART 9 â€” SummaryPageï¼ˆç¸½è¡¨ï¼‰
 ****************************************************/
function SummaryPage({ projectData, currentProject, updateProjectData }) {
  const chartRef = React.useRef(null);

  /*************** äº”å¤§é¡æˆæœ¬å°è¨ˆ ***************/
  const sumByType = type =>
    projectData.allItems
      .filter(i => i.type === type)
      .reduce((a, b) => a + (b.subtotal || 0), 0);

  const materialSum = sumByType("ææ–™");
  const purchaseSum = sumByType("å¸‚è³¼å“");
  const fabSum = sumByType("è£½ä½œæˆæœ¬");
  const transSum = sumByType("é‹è¼¸è²»ç”¨");
  const installSum = sumByType("ç¾å ´å®‰è£");

  const fiveTotal = materialSum + purchaseSum + fabSum + transSum + installSum;

  /*************** äººå·¥èª¿æ•´æ¬„ä½ ***************/
  const manualAdjustDetail = projectData.manualAdjustDetail || {
    material: 0,
    purchase: 0,
    fabrication: 0,
    transport: 0,
    install: 0
  };

  const manualTotal = Object.values(manualAdjustDetail).reduce(
    (a, b) => a + Number(b || 0),
    0
  );

  const finalCost = fiveTotal + manualTotal;

  /*************** ç®¡éŠ· / æ¯›åˆ© / å”®åƒ¹ ***************/
  const [adminRate, setAdminRate] = React.useState(15);
  const [profitRate, setProfitRate] = React.useState(35);

  const adminFee = Math.round(finalCost * (adminRate / 100));
  const suggestPrice = Math.round(
    (finalCost + adminFee) / (1 - profitRate / 100)
  );

  /*************** æ›´æ–°äººå·¥èª¿æ•´æ•¸å€¼ï¼ˆå…è¨±ä»»æ„ä½æ•¸ï¼‰ ***************/
  function updateManualAdjust(field, value) {
    const num = value === "" ? "" : Number(value);

    const newDetail = {
      ...manualAdjustDetail,
      [field]: num
    };

    updateProjectData({
      ...projectData,
      manualAdjustDetail: newDetail
    });
  }

  /*************** åœ“é¤…åœ– ***************/
  React.useEffect(() => {
    const ctx = document.getElementById("summaryChart");
    if (!ctx) return;

    if (window.summaryChart && typeof window.summaryChart.destroy === "function") {
      window.summaryChart.destroy();
    }

    const data = [materialSum, purchaseSum, fabSum, transSum, installSum];
    const labels = ["ææ–™", "å¸‚è³¼å“", "è£½ä½œ", "é‹è¼¸", "å®‰è£"];

    window.summaryChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [
          {
            data,
            backgroundColor: ["#4fa3d1", "#ffcc66", "#66cc99", "#ff6666", "#9999ff"]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            color: "#000",
            font: { weight: "bold", size: 16 },
            formatter: (value, ctx) => {
              const total = data.reduce((a, b) => a + b, 0);
              return total === 0 ? "0%" : ((value / total) * 100).toFixed(1) + "%";
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }, [materialSum, purchaseSum, fabSum, transSum, installSum]);

  /*************** åŒ¯å‡º Excel ***************/
  function exportExcel() {
    const wb = XLSX.utils.book_new();

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");

    const projectName = currentProject || "æœªå‘½åå·¥ç¨‹";
    const fileName = `${yyyy}${mm}${dd}-${projectName}-æˆæœ¬åˆ†æ.xlsx`;

    const rows = [];

    rows.push(["ææ–™æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "é•·m", "å¯¬m", "æ•¸é‡", "é‡é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "ææ–™")
      .forEach(i =>
        rows.push([
          i.category,
          i.spec,
          i.length || "",
          i.width || "",
          i.qty,
          i.weight || "",
          i.price,
          i.subtotal
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", "", "", materialSum]);
    rows.push([]);

    rows.push(["å¸‚è³¼å“æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "å¸‚è³¼å“")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", purchaseSum]);
    rows.push([]);

    rows.push(["è£½ä½œæˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "è£½ä½œæˆæœ¬")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", fabSum]);
    rows.push([]);

    rows.push(["é‹è¼¸æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "é‹è¼¸è²»ç”¨")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", transSum]);
    rows.push([]);

    rows.push(["ç¾å ´å®‰è£æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "ç¾å ´å®‰è£")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", installSum]);
    rows.push([]);

    rows.push(["", "é …ç›®", "é‡‘é¡"]);
    rows.push(["", "äº”å¤§æˆæœ¬åˆè¨ˆ", fiveTotal]);
    rows.push(["", "äººå·¥èª¿æ•´åˆè¨ˆ", manualTotal]);
    rows.push(["", "æœ€çµ‚æˆæœ¬", finalCost]);
    rows.push(["", "ç®¡éŠ·(%)", adminRate]);
    rows.push(["", "ç®¡éŠ·è²»", adminFee]);
    rows.push(["", "æ¯›åˆ©ç‡(%)", profitRate]);
    rows.push(["", "å»ºè­°å”®åƒ¹", suggestPrice]);

    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "æˆæœ¬åˆ†æ");

    XLSX.writeFile(wb, fileName);
  }

  /*************** RETURNï¼šé é¢ UI ***************/
  return (
    <div className="p-4 max-w-5xl mx-auto">
      <h2 className="text-2xl font-bold mb-4">æˆæœ¬ç¸½è¡¨</h2>

      {/* åœ“é¤…åœ– */}
      <div className="w-full h-80 mb-6">
        <canvas id="summaryChart"></canvas>
      </div>

{/* äº”å¤§æˆæœ¬èˆ‡äººå·¥èª¿æ•´ï¼šåˆä½µç‰ˆ */}
<div className="bg-white p-4 rounded shadow mb-4">
  <h3 className="font-bold text-lg mb-2">äº”å¤§æˆæœ¬ + äººå·¥èª¿æ•´</h3>

  <div className="grid grid-cols-2 gap-3">
    {/* ææ–™ */}
    <div>
      <p>ææ–™æˆæœ¬ï¼š{materialSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.material}
          onChange={e => updateManualAdjust("material", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* å¸‚è³¼å“ */}
    <div>
      <p>å¸‚è³¼å“æˆæœ¬ï¼š{purchaseSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.purchase}
          onChange={e => updateManualAdjust("purchase", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* è£½ä½œ */}
    <div>
      <p>è£½ä½œæˆæœ¬ï¼š{fabSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.fabrication}
          onChange={e => updateManualAdjust("fabrication", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* é‹è¼¸ */}
    <div>
      <p>é‹è¼¸è²»ç”¨ï¼š{transSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.transport}
          onChange={e => updateManualAdjust("transport", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* å®‰è£ */}
    <div>
      <p>ç¾å ´å®‰è£æˆæœ¬ï¼š{installSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.install}
          onChange={e => updateManualAdjust("install", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>
  </div>

  {/* å°è¨ˆå€ */}
  <div className="mt-4">
    <p className="font-bold">äººå·¥èª¿æ•´å°è¨ˆï¼š{manualTotal}</p>
    <p className="font-bold text-lg">æœ€çµ‚æˆæœ¬ï¼š{finalCost}</p>
  </div>
</div>

{/* ç®¡éŠ·ã€æ¯›åˆ©ç‡ã€å»ºè­°å”®åƒ¹ */}
<div className="bg-white p-4 rounded shadow mb-4">
  <div className="grid grid-cols-2 gap-2 mt-2">

    <label>ç®¡éŠ·(%)
      <input
        type="number"
        value={adminRate}
        onChange={(e) => setAdminRate(Number(e.target.value))}
        className="border p-1 w-full"
      />
    </label>

    <p>ç®¡éŠ·è²»ï¼š{adminFee}</p>

    <label>æ¯›åˆ©ç‡(%)
      <input
        type="number"
        value={profitRate}
        onChange={(e) => setProfitRate(Number(e.target.value))}
        className="border p-1 w-full"
      />
    </label>

    <p className="font-bold text-lg">å»ºè­°å”®åƒ¹ï¼š{suggestPrice}</p>

  </div>
</div>

      {/* åŒ¯å‡º Excel */}
      <button
        onClick={exportExcel}
        className="bg-green-600 text-white px-4 py-2 rounded shadow"
      >
        åŒ¯å‡º Excel
      </button>
    </div>
  );
}
/****************************************************
 * PART 10 â€” Appï¼ˆä¸»æ§åˆ¶ï¼‰
 * - å¤šå·¥ç¨‹ç®¡ç†
 * - Google Sheet åŒæ­¥
 * - åˆ†é åˆ‡æ›
 * - æ¸²æŸ“äº”å¤§æˆæœ¬é  + SummaryPage
 ****************************************************/
function App() {
  const [projects, setProjects] = React.useState(loadProjects());
  const [currentProject, setCurrentProject] = React.useState(
    Object.keys(projects)[0] || ""
  );

  // é é¢åˆ‡æ›
  const [page, setPage] = React.useState("ææ–™");

  // äº”å¤§è³‡æ–™åº«
  const [materialDB, setMaterialDB] = React.useState([]);
  const [purchaseDB, setPurchaseDB] = React.useState([]);
  const [fabricationDB, setFabricationDB] = React.useState([]);
  const [transportDB, setTransportDB] = React.useState([]);
  const [installDB, setInstallDB] = React.useState([]);

  // Google Sheet + localStorage åŒæ­¥ï¼ˆæ¨¡å¼ Cï¼‰
  async function fetchCSV(url) {
    const text = await fetch(url).then(r => r.text());
    const rows = text.split("\n").map(r => r.trim());
    const version = `${rows.length}-${rows[0]}-${rows[rows.length - 1]}`;
    return { rows, version };
  }

  async function loadDB(name, url, setter) {
    const local = localStorage.getItem("db_" + name);
    const localV = localStorage.getItem("dbv_" + name);

    const { rows, version } = await fetchCSV(url);

    if (local && localV === version) {
      setter(JSON.parse(local));
    } else {
      const parsed = rows
  .slice(1)
  .map(r => r.split(","))
  .filter(r => r.length >= 2)
  .map(r => {

    // â‘  ææ–™ï¼ˆæœ‰é‡é‡ï¼‰
    if (name === "material") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        weight: Number(r[3] || 0),
        price: Number(r[4] || 0)
      };
    }

    // â‘¡ å¸‚è³¼å“ï¼ˆç„¡é‡é‡ï¼‰
    if (name === "purchase") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        price: Number(r[3] || 0)
      };
    }

    // â‘¢ è£½ä½œæˆæœ¬ï¼ˆç„¡é‡é‡ï¼‰
    if (name === "fabrication") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        price: Number(r[3] || 0)
      };
    }

    // â‘£ é‹è¼¸è²»ç”¨ï¼ˆæ¬„ä½é †åºä¸åŒï¼‰
    if (name === "transport") {
      return {
        category: r[0],   // é«˜ç©ºä½œæ¥­è»Š
        spec: r[1],       // 21M
        region: r[2],     // å—/åŒ—/ä¸­
        price: Number(r[3] || 0),
        unit: r[4] || "å°"
      };
    }

    // â‘¤ ç¾å ´å®‰è£ï¼ˆç„¡é‡é‡ï¼‰
    if (name === "install") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        price: Number(r[3] || 0)
      };
    }

  });


setter(parsed);
localStorage.setItem("db_" + name, JSON.stringify(parsed));
localStorage.setItem("dbv_" + name, version);
localStorage.setItem("dbts_" + name, new Date().toISOString());
    }
  }

// åˆå§‹åŒ–ï¼Œè¼‰å…¥äº”å¤§è³‡æ–™åº«
React.useEffect(() => {
  loadDB("material", CSV_URLS.material, setMaterialDB);
  loadDB("purchase", CSV_URLS.purchase, setPurchaseDB);
  loadDB("fabrication", CSV_URLS.fabrication, setFabricationDB);
  loadDB("transport", CSV_URLS.transport, setTransportDB);
  loadDB("install", CSV_URLS.install, setInstallDB);
}, []);

  // å–å¾—ç›®å‰å·¥ç¨‹è³‡æ–™
  const projectData = projects[currentProject] || {
    projectName: "",     // â† åŠ é€™ä¸€è¡Œ
    allItems: [],
    manualAdjust: 0
  };

  // æ›´æ–°ç›®å‰å·¥ç¨‹è³‡æ–™
  function updateProjectData(newData) {
    const updated = {
      ...projects,
      [currentProject]: newData
    };
    setProjects(updated);
    saveProjects(updated);
  }

  return (
    <div className="p-4 max-w-5xl mx-auto">


      {/* å·¥ç¨‹ç®¡ç† */}
      <ProjectManager
        currentProject={currentProject}
        setCurrentProject={setCurrentProject}
        projects={projects}
        setProjects={setProjects}
      />

      {/* åˆ†é åŠŸèƒ½ */}
      <div className="flex gap-2 mb-4">
        {["ææ–™", "å¸‚è³¼å“", "è£½ä½œæˆæœ¬", "é‹è¼¸è²»ç”¨", "ç¾å ´å®‰è£", "ç¸½è¡¨"].map(tab => (
          <button
            key={tab}
            onClick={() => setPage(tab)}
            className={
              "px-3 py-1 rounded border " +
              (page === tab
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {tab}
          </button>
        ))}
      </div>

      {/* é é¢å…§å®¹ */}
      {page === "ææ–™" && (
        <MaterialsPage
          materialDB={materialDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "å¸‚è³¼å“" && (
        <PurchasePage
          purchaseDB={purchaseDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "è£½ä½œæˆæœ¬" && (
        <FabricationPage
          fabricationDB={fabricationDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "é‹è¼¸è²»ç”¨" && (
        <TransportPage
          transportDB={transportDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "ç¾å ´å®‰è£" && (
        <InstallPage
          installDB={installDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

     {page === "ç¸½è¡¨" && (
  <SummaryPage
    projectData={projectData}
    currentProject={currentProject}
    updateProjectData={updateProjectData}
  />
)}
    </div>
  );
}
/****************************************************
 * æ¸²æŸ“ App
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>  <!-- â†â†â† é€™å€‹çµæŸ script æ˜¯æ•´ç«™èƒ½å¦æ­£å¸¸æ¸²æŸ“çš„é—œéµ -->
  
</body>
</html>
