<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥ç¨‹äº”å¤§æˆæœ¬è©¦ç®—ç³»çµ±ï¼ˆå¤šå·¥ç¨‹ Mode-Cï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <style>
    body { background:#f1f3f5; }
    .card {
      background:white;
      border-radius:12px;
      padding:20px;
      box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-bottom:24px;
    }
    .tab-btn {
      padding:10px 20px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .tab-active {
      background:#2563eb;
      color:white;
    }
    .tab-inactive {
      background:#e2e8f0;
      color:#475569;
    }
  </style>
</head>

<body class="p-6">

<div id="root"></div>

<script type="text/babel">

/* ------------------------------------------------------
   React Hooks
-------------------------------------------------------*/
const { useState, useEffect, useMemo } = React;

/* ------------------------------------------------------
   äº”å¤§æˆæœ¬ â€” ä¸‹æ‹‰é¸é …è³‡æ–™ï¼ˆåœ¨æ­¤å¯è‡ªè¡Œæ–°å¢é …ç›®ï¼‰
-------------------------------------------------------*/
const MATERIAL_OPTIONS = {
  "éµæ¿": [
    { spec:"éµæ¿-4t", price:22, weight: 12 },
    { spec:"éµæ¿-9t", price:25, weight: 70 },
  ],
  "è§’éµ": [
    { spec:"L50x50x5", price:32, weight: 6 },
    { spec:"L90x90x7", price:28, weight: 19 },
  ],
  "ä¸ç­‰é‚Šè§’éµ": [
    { spec:"L150x90x9", price:30, weight: 32 },
  ]
};

const PURCHASE_OPTIONS = {
  "é›»å‹•è¨­å‚™": [
    { spec:"1TX25mï¼ˆå«ä¸Šä¸‹ç·šæ§ï¼‰", unit:"å°", price:50000 },
  ],
  "é¦¬é”": [
    { spec:"2HP", unit:"å°", price:5000 },
  ]
};

const FABRICATE_OPTIONS = {
  "å» å…§è£½ä½œ": [
    { spec:"å·¥æ•¸", price:5000 },
  ],
  "å§”å¤–è£½ä½œ": [
    { spec:"å·¥æ•¸", price:3500 },
    { spec:"å…¬æ–¤è¨ˆåƒ¹", price:25 },
  ]
};

const TRANSPORT_OPTIONS = {
  "åŠè»Š": [
    { spec:"åŠè»Š-10T", price:9000 },
    { spec:"åŠè»Š-12T", price:12000 },
    { spec:"åŠè»Š-25T", price:25000 },
  ],
  "é«˜ç©ºä½œæ¥­è»Š": [
    { spec:"é«˜ç©ºä½œæ¥­è»Š", price:5000 },
  ]
};

const INSTALL_OPTIONS = {
  "ç¾å ´å®‰è£": [
    { spec:"ç¾å ´å®‰è£", price:7000 },
  ],
  "å§”å¤–å®‰è£": [
    { spec:"å§”å¤–å®‰è£", price:8000 },
  ]
};

/* ------------------------------------------------------
   å…±ç”¨ï¼šå»ºç«‹é …ç›®è³‡æ–™æ ¼å¼
-------------------------------------------------------*/
function createItem(type, category, spec, qty, price, weight = 0) {
  return {
    id: Date.now() + Math.random(),
    type,       // material / purchase / fabricate / transport / install
    category,
    spec,
    qty: Number(qty),
    price: Number(price),
    weight: Number(weight),
    subtotal: Number(qty) * Number(price),
  };
}

/* ------------------------------------------------------
   LocalStorage æ–¹æ³•
-------------------------------------------------------*/
function loadData() {
  try {
    return JSON.parse(localStorage.getItem("costData") || "{}");
  } catch {
    return {};
  }
}

function saveData(data) {
  localStorage.setItem("COST_DATA", JSON.stringify(data));
}

// è®€å–å…¨éƒ¨è³‡æ–™ï¼ˆç¬¬ä¸€æ¬¡æ²’æœ‰ â†’ å»ºç«‹é è¨­çµæ§‹ï¼‰
function loadData() {
  const raw = localStorage.getItem("COST_DATA");
  if (!raw) {
    return {
      "ææ–™æˆæœ¬": [],
      "å¸‚è³¼å“": [],
      "è£½ä½œæˆæœ¬": [],
      "é‹è¼¸è²»ç”¨": [],
      "ç¾å ´å®‰è£": [],
    };
  }
  return JSON.parse(raw);
}

// è®“èˆŠç¨‹å¼ loadProjects() = loadData()
function loadProjects() {
  return loadData();
}

/* ------------------------------------------------------
   æ•´é«” Appï¼ˆç¬¬äºŒæ®µæœƒé–‹å§‹æ¸²æŸ“ UIï¼‰
-------------------------------------------------------*/
/* ------------------------------------------------------
   App ä¸»ä»‹é¢
-------------------------------------------------------*/
function App() {

  /* --------------------------------------------------
     å…­å¤§åˆ†é 
  ---------------------------------------------------*/
  const pages = ["ææ–™æˆæœ¬", "å¸‚è³¼å“", "è£½ä½œæˆæœ¬", "é‹è¼¸è²»ç”¨", "ç¾å ´å®‰è£", "ç¸½è¡¨"];
  const [page, setPage] = useState("ææ–™æˆæœ¬");

  /* --------------------------------------------------
     ä¸»è³‡æ–™çµæ§‹ï¼ˆå­˜æ–¼ localStorageï¼‰
  ---------------------------------------------------*/
  const [data, setData] = useState(() => loadData());

  // è‹¥è©²é¡åˆ¥æ²’æœ‰è³‡æ–™ â†’ è‡ªå‹•å»ºç«‹ç©ºé™£åˆ—
  useEffect(() => {
    const init = {};
    pages.forEach(p => {
      if (!data[p]) init[p] = [];
      else init[p] = data[p];
    });
    setData(init);
    saveData(init);
  }, []);

  /* --------------------------------------------------
     æ‰‹å‹•èª¿æ•´ï¼ˆæ¯é  + / -ï¼‰
  ---------------------------------------------------*/
  const [adjust, setAdjust] = useState({
    "ææ–™æˆæœ¬": 0,
    "å¸‚è³¼å“": 0,
    "è£½ä½œæˆæœ¬": 0,
    "é‹è¼¸è²»ç”¨": 0,
    "ç¾å ´å®‰è£": 0,
  });

  /* --------------------------------------------------
     åˆ©ç®¡ç‡ / æ¯›åˆ©ç‡
  ---------------------------------------------------*/
  const [rates, setRates] = useState({
    manage: 15, // åˆ©ç®¡ç‡
    profit: 35, // å»ºè­°æ¯›åˆ©ç‡
  });

  /* --------------------------------------------------
     æ–°å¢è³‡æ–™
  ---------------------------------------------------*/
  const addItem = (category, selected, qty, typeName) => {
    if (!selected || !qty || qty <= 0) {
      alert("è«‹é¸æ“‡è¦æ ¼ä¸¦è¼¸å…¥æ­£ç¢ºæ•¸é‡");
      return;
    }

    const item = createItem(
      typeName,
      category,
      selected.spec,
      qty,
      selected.price,
      selected.weight ?? 0
    );

    const newData = {
      ...data,
      [typeName]: [...data[typeName], item],
    };

    setData(newData);
    saveData(newData);
  };

  /* --------------------------------------------------
     åˆªé™¤
  ---------------------------------------------------*/
  const removeItem = (typeName, id) => {
    const newData = {
      ...data,
      [typeName]: data[typeName].filter(x => x.id !== id),
    };
    setData(newData);
    saveData(newData);
  };

  /* --------------------------------------------------
     ç·¨è¼¯ï¼ˆæ•¸é‡ / å–®åƒ¹ï¼‰
  ---------------------------------------------------*/
  const editItem = (typeName, id, qty, price) => {
    const newData = {
      ...data,
      [typeName]: data[typeName].map(x =>
        x.id === id
          ? { ...x, qty:Number(qty), price:Number(price), subtotal:Number(qty)*Number(price) }
          : x
      ),
    };
    setData(newData);
    saveData(newData);
  };

  /* --------------------------------------------------
     è¨ˆç®—å„æˆæœ¬å°è¨ˆ
  ---------------------------------------------------*/
  const subtotal = typeName =>
    data[typeName].reduce((s, x) => s + x.subtotal, 0) + Number(adjust[typeName] || 0);

  const totalCost =
    subtotal("ææ–™æˆæœ¬") +
    subtotal("å¸‚è³¼å“") +
    subtotal("è£½ä½œæˆæœ¬") +
    subtotal("é‹è¼¸è²»ç”¨") +
    subtotal("ç¾å ´å®‰è£");

  const finalManageCost = Math.round(totalCost * (1 + rates.manage / 100));
  const finalSuggest = Math.round(finalManageCost * (1 + rates.profit / 100));

  /* --------------------------------------------------
     å…±ç”¨ï¼šæ¸²æŸ“æ˜ç´°è¡¨æ ¼
  ---------------------------------------------------*/
  function renderTable(typeName) {
    return (
      <table className="w-full text-sm mt-4 border">
        <thead className="bg-gray-100">
          <tr>
            <th className="p-2 border">åˆ†é¡</th>
            <th className="p-2 border">è¦æ ¼</th>
            <th className="p-2 border">æ•¸é‡</th>
            <th className="p-2 border">å–®åƒ¹</th>
            <th className="p-2 border">å°è¨ˆ</th>
            <th className="p-2 border">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {data[typeName].map(row => (
            <tr key={row.id}>
              <td className="p-2 border">{row.category}</td>
              <td className="p-2 border">{row.spec}</td>

              <td className="p-2 border">
                <input
                  type="number"
                  className="border p-1 w-20"
                  defaultValue={row.qty}
                  onBlur={e => editItem(typeName, row.id, e.target.value, row.price)}
                />
              </td>

              <td className="p-2 border">
                <input
                  type="number"
                  className="border p-1 w-20"
                  defaultValue={row.price}
                  onBlur={e => editItem(typeName, row.id, row.qty, e.target.value)}
                />
              </td>

              <td className="p-2 border">{row.subtotal.toLocaleString()}</td>

              <td className="p-2 border text-center">
                <button
                  className="px-3 py-1 bg-red-600 text-white rounded"
                  onClick={() => removeItem(typeName, row.id)}
                >åˆªé™¤</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    );
  }

  /* --------------------------------------------------
     æ¯ä¸€é¡æˆæœ¬çš„ UIï¼ˆä¸‹æ‹‰ + æ•¸é‡ + æ–°å¢ï¼‰
  ---------------------------------------------------*/
  function renderCostPage(options, typeName) {
    const [category, setCategory] = useState("");
    const [spec, setSpec] = useState("");
    const [qty, setQty] = useState("");

    const selected =
      category && spec
        ? options[category].find(x => x.spec === spec)
        : null;

    return (
      <div className="card">

        {/* åˆ†é¡ */}
        <div className="mb-3">
          <label className="font-bold">åˆ†é¡ï¼š</label>
          <select
            className="border p-2 rounded ml-2"
            value={category}
            onChange={e => {
              setCategory(e.target.value);
              setSpec("");
            }}
          >
            <option value="">è«‹é¸æ“‡</option>
            {Object.keys(options).map(k => (
              <option key={k}>{k}</option>
            ))}
          </select>
        </div>

        {/* è¦æ ¼ */}
        {category && (
          <div className="mb-3">
            <label className="font-bold">è¦æ ¼ï¼š</label>
            <select
              className="border p-2 rounded ml-2"
              value={spec}
              onChange={e => setSpec(e.target.value)}
            >
              <option value="">è«‹é¸æ“‡</option>
              {options[category].map(o => (
                <option key={o.spec}>{o.spec}</option>
              ))}
            </select>
          </div>
        )}

        {/* æ•¸é‡ */}
        {spec && (
          <div className="mb-4">
            <label className="font-bold">æ•¸é‡ï¼š</label>
            <input
              type="number"
              min="1"
              className="border p-2 rounded ml-2 w-32"
              value={qty}
              onChange={e => setQty(e.target.value)}
            />
          </div>
        )}

        <button
          className="px-4 py-2 bg-emerald-600 text-white rounded"
          onClick={() => addItem(category, selected, qty, typeName)}
        >
          â• æ–°å¢é …ç›®
        </button>

        {/* æ‰‹å‹•èª¿æ•´ */}
        <div className="mt-6">
          <label className="font-bold">æ‰‹å‹•èª¿æ•´ï¼ˆÂ±ï¼‰ï¼š</label>
          <input
            type="number"
            className="border p-2 rounded ml-2 w-32"
            value={adjust[typeName]}
            onChange={e =>
              setAdjust({ ...adjust, [typeName]: Math.round(Number(e.target.value)) })
            }
          />
        </div>

        {/* æ˜ç´°è¡¨æ ¼ */}
        {renderTable(typeName)}

        {/* å°è¨ˆ */}
        <div className="text-right mt-4 font-bold text-lg text-blue-600">
          å°è¨ˆï¼š{subtotal(typeName).toLocaleString()} å…ƒ
        </div>

      </div>
    );
  }

  /* --------------------------------------------------
     æ¸²æŸ“ç¸½è¡¨é 
  ---------------------------------------------------*/
  function renderSummary() {

    const material = subtotal("ææ–™æˆæœ¬");
    const purchase = subtotal("å¸‚è³¼å“");
    const fabricate = subtotal("è£½ä½œæˆæœ¬");
    const transport = subtotal("é‹è¼¸è²»ç”¨");
    const install = subtotal("ç¾å ´å®‰è£");

    const pieData = [material, purchase, fabricate, transport, install];

    useEffect(() => {
      const ctx = document.getElementById("pieChart");
      if (!ctx) return;

      if (window.myPieChart) window.myPieChart.destroy();

      window.myPieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["ææ–™", "å¸‚è³¼å“", "è£½ä½œ", "é‹è¼¸", "å®‰è£"],
          datasets: [{
            data: pieData,
            backgroundColor: [
              "#3b82f6",
              "#10b981",
              "#f59e0b",
              "#ef4444",
              "#8b5cf6",
            ]
          }]
        },
        plugins:[ChartDataLabels],
        options:{
          plugins:{
            datalabels:{
              color:"#fff",
              formatter:(v,ctx)=>{
                const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                return ((v/total)*100).toFixed(1) + "%";
              }
            }
          }
        }
      });

    }, [material, purchase, fabricate, transport, install]);


    return (
      <div className="card">

        <h2 className="text-2xl font-bold mb-4">ğŸ“˜ æˆæœ¬ç¸½è¡¨</h2>

        <table className="w-full border text-sm mb-6">
          <thead className="bg-gray-100">
            <tr>
              <th className="p-2 border">é …ç›®</th>
              <th className="p-2 border">é‡‘é¡ï¼ˆå«èª¿æ•´ï¼‰</th>
            </tr>
          </thead>
          <tbody>
            <tr><td className="p-2 border">ææ–™æˆæœ¬</td><td className="p-2 border">{material.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">å¸‚è³¼å“</td><td className="p-2 border">{purchase.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">è£½ä½œæˆæœ¬</td><td className="p-2 border">{fabricate.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">é‹è¼¸è²»ç”¨</td><td className="p-2 border">{transport.toLocaleString()}</td></tr>
            <tr><td className="p-2 border">ç¾å ´å®‰è£</td><td className="p-2 border">{install.toLocaleString()}</td></tr>

            <tr className="bg-gray-200 font-bold">
              <td className="p-2 border">ç¸½æˆæœ¬</td>
              <td className="p-2 border">{totalCost.toLocaleString()} å…ƒ</td>
            </tr>
          </tbody>
        </table>

        {/* åˆ©ç‡è¨­å®š */}
        <div className="flex gap-6 mb-6">
          <div>
            <label className="font-bold">åˆ©ç®¡ç‡ï¼ˆ%ï¼‰ï¼š</label>
            <input
              type="number"
              className="border p-2 ml-2 w-24"
              value={rates.manage}
              onChange={e => setRates({ ...rates, manage:Number(e.target.value) })}
            />
          </div>

          <div>
            <label className="font-bold">å»ºè­°æ¯›åˆ©ç‡ï¼ˆ%ï¼‰ï¼š</label>
            <input
              type="number"
              className="border p-2 ml-2 w-24"
              value={rates.profit}
              onChange={e => setRates({ ...rates, profit:Number(e.target.value) })}
            />
          </div>
        </div>

        <div className="text-xl font-bold text-indigo-600 mb-4">
          åŠ åˆ©ç®¡å¾Œæˆæœ¬ï¼š{finalManageCost.toLocaleString()} å…ƒ
        </div>

        <div className="text-2xl font-bold text-emerald-600 mb-4">
          å»ºè­°å ±åƒ¹ï¼š{finalSuggest.toLocaleString()} å…ƒ
        </div>

        {/* åœ“é¤…åœ– */}
        <div className="flex gap-6">
          <canvas id="pieChart" width="240" height="240"></canvas>

          {/* è‰²å¡ */}
          <div className="flex flex-col justify-center text-sm">
            <div className="flex items-center mb-2"><div style="width:16px;height:16px;background:#3b82f6" class="mr-2"></div>ææ–™æˆæœ¬</div>
            <div className="flex items-center mb-2"><div style="width:16px;height:16px;background:#10b981" class="mr-2"></div>å¸‚è³¼å“</div>
            <div className="flex items-center mb-2"><div style="width:16px;height:16px;background:#f59e0b" class="mr-2"></div>è£½ä½œæˆæœ¬</div>
            <div className="flex items-center mb-2"><div style="width:16px;height:16px;background:#ef4444" class="mr-2"></div>é‹è¼¸è²»ç”¨</div>
            <div className="flex items-center mb-2"><div style="width:16px;height:16px;background:#8b5cf6" class="mr-2"></div>ç¾å ´å®‰è£</div>
          </div>
        </div>

      </div>
    );
  }

  /* --------------------------------------------------
     Excel åŒ¯å‡º
  ---------------------------------------------------*/
  function exportExcel() {
    let rows = [["åˆ†é¡","è¦æ ¼","æ•¸é‡","å–®åƒ¹","å°è¨ˆ"]];

    pages.slice(0,5).forEach(type => {
      rows.push([type]);
      data[type].forEach(row => {
        rows.push([
          row.category,
          row.spec,
          row.qty,
          row.price,
          row.subtotal
        ]);
      });
      rows.push(["èª¿æ•´", adjust[type]]);
      rows.push([]);
    });

    rows.push(["ç¸½æˆæœ¬", totalCost]);

    let csvContent = "data:text/csv;charset=utf-8,\uFEFF"
      + rows.map(e => e.join(",")).join("\n");

    const a = document.createElement("a");
    a.href = encodeURI(csvContent);
    a.download = "æˆæœ¬ç¸½è¡¨.csv";
    a.click();
  }

  /* --------------------------------------------------
     ä¸»ç•«é¢ Render
  ---------------------------------------------------*/
  return (
    <div>

      {/* æ¨™ç±¤åˆ— */}
      <div className="flex gap-2 mb-6">
        {pages.map(p => (
          <button
            key={p}
            className={
              "tab-btn " + (page === p ? "tab-active" : "tab-inactive")
            }
            onClick={() => setPage(p)}
          >
            {p}
          </button>
        ))}
      </div>

      {/* åˆ†é å…§å®¹ */}
      {page === "ææ–™æˆæœ¬"   && renderCostPage(MATERIAL_OPTIONS, "ææ–™æˆæœ¬")}
      {page === "å¸‚è³¼å“"     && renderCostPage(PURCHASE_OPTIONS, "å¸‚è³¼å“")}
      {page === "è£½ä½œæˆæœ¬"   && renderCostPage(FABRICATE_OPTIONS, "è£½ä½œæˆæœ¬")}
      {page === "é‹è¼¸è²»ç”¨"   && renderCostPage(TRANSPORT_OPTIONS, "é‹è¼¸è²»ç”¨")}
      {page === "ç¾å ´å®‰è£"   && renderCostPage(INSTALL_OPTIONS, "ç¾å ´å®‰è£")}
      {page === "ç¸½è¡¨"       && renderSummary()}

      {/* åŒ¯å‡º */}
      <div className="text-center mt-8">
        <button
          className="px-6 py-3 bg-indigo-600 text-white rounded-lg text-lg shadow"
          onClick={exportExcel}
        >
          â¬‡ åŒ¯å‡º Excel æˆæœ¬ç¸½è¡¨
        </button>
      </div>

    </div>
  );
}

/* ------------------------------------------------------
   ReactDOM Render
-------------------------------------------------------*/
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>

