<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å·¥ç¨‹äº”å¤§æˆæœ¬è©¦ç®—ç³»çµ±ï¼ˆC-2 ç‰ˆï¼‰</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React 18 -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<!-- Babel Standalone -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js + DataLabels æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  
  <!-- Excel åŒ¯å‡ºç”¨ SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { background-color: #f3f4f6; }
    .print-hidden { display: block; }
    @media print {
      .print-hidden { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- React Root -->
  <div id="root"></div>

  <!-- Main Application Script -->
  <script type="text/babel">
/****************************************************
 * PART 1 â€” å…¨åŸŸå¸¸æ•¸ã€å·¥å…·å‡½å¼ï¼ˆå«é‡‘é¡åƒåˆ†ä½è¡¨ç¤ºï¼‰
 ****************************************************/

// Google Sheet CSV URLs
const CSV_URLS = {
  material: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",
  purchase: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",
  fabrication: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",
  transport: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",
  install: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv"
};

// é‡‘é¡åƒåˆ†ä½æ ¼å¼åŒ–
function formatMoney(num) {
  if (isNaN(num)) return "0";
  return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// é‡é‡å°æ•¸å…©ä½
function formatWeight(num) {
  if (isNaN(num)) return "0.00";
  return Number(num).toFixed(2);
}

// CSV è§£æ
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim());
    return obj;
  });
}
function parseTransportRow(r) {
  return {
    category: r[0],     // è»Šç¨®
    spec: r[1],         // é …ç›®
    region: r[2],       // åœ°å€ï¼ˆå—/åŒ—/ä¸­ï¼‰
    unit: r[3],         // å–®ä½ï¼ˆå°ï¼‰
    price: Number(r[4] || 0)  // å–®åƒ¹ï¼ˆæ•¸å­—ï¼‰
  };
}

/****************************************************
 * PART X â€” å·¥ç¨‹è³‡æ–™å„²å­˜ / è®€å–
 ****************************************************/

// äº”å¤§æˆæœ¬çš„æ‰‹å‹•èª¿æ•´é è¨­å€¼ï¼ˆæ–°ç‰ˆï¼šç‰©ä»¶çµæ§‹ï¼‰
const defaultManualAdjust = {
  material: 0,
  purchase: 0,
  fabrication: 0,
  transport: 0,
  install: 0
};

// ğŸš€ å¼·åŒ–ç‰ˆï¼šæ°¸ä¸å£æ‰çš„ saveProjects()
function saveProjects(data) {
  try {
    if (!data || typeof data !== "object") return;
    localStorage.setItem("projects_v3", JSON.stringify(data));
  } catch (err) {
    console.error("saveProjects() å¯«å…¥éŒ¯èª¤ï¼š", err);
  }
}

// ğŸš€ å¼·åŒ–ç‰ˆï¼šæ°¸ä¸ç™½å±çš„ loadProjects()
function loadProjects() {
  try {
    const raw = localStorage.getItem("projects_v3");

    // ç¬¬ä¸€æ¬¡ä½¿ç”¨ â†’ å›å‚³ç©ºç‰©ä»¶
    if (!raw) return {};

    const parsed = JSON.parse(raw);

    // å£æ‰è³‡æ–™ â†’ è‡ªå‹•é‡ç½®
    if (!parsed || typeof parsed !== "object") return {};

    // ä¿®è£œæ¯ä¸€å€‹å·¥ç¨‹è³‡æ–™
    for (const key in parsed) {
      const proj = parsed[key];

      // å·¥ç¨‹ä¸å­˜åœ¨ æˆ– çµæ§‹éŒ¯èª¤ â†’ é‡å»º
      if (!proj || typeof proj !== "object") {
        parsed[key] = {
          allItems: [],
          manualAdjustDetail: { ...defaultManualAdjust }
        };
        continue;
      }

      // allItems ä¿è­‰ç‚ºé™£åˆ—
      if (!Array.isArray(proj.allItems)) {
        proj.allItems = [];
      }

      // æ–°ç‰ˆäººå·¥èª¿æ•´æ¬„ä½
      if (!proj.manualAdjustDetail || typeof proj.manualAdjustDetail !== "object") {
        proj.manualAdjustDetail = { ...defaultManualAdjust };
      }
    }

    return parsed;
  } catch (err) {
    console.error("loadProjects() ç™¼ç”ŸéŒ¯èª¤ï¼ŒlocalStorage å¯èƒ½ææ¯€ï¼š", err);
    return {}; // ä¿è­· App ä¸æ›æ‰
  }
}
 /****************************************************
 * PART 2 â€” å¤šå·¥ç¨‹ç®¡ç† ProjectManagerï¼ˆç¬¬ 2 æ®µï¼‰
 ****************************************************/

// å¤šå·¥ç¨‹ç®¡ç†
function ProjectManager({ currentProject, setCurrentProject, projects, setProjects }) {

  // æ–°å¢å·¥ç¨‹
  function addProject() {
    const name = prompt("è«‹è¼¸å…¥å·¥ç¨‹åç¨±ï¼š");
    if (!name) return;

    if (projects[name]) {
      alert("å·¥ç¨‹åç¨±å·²å­˜åœ¨ï¼");
      return;
    }

    const updated = {
      ...projects,
      [name]: {
        allItems: [],
        manualAdjust: 0   // â˜… æ­£ç¢ºå¯«æ³•
      }
    };

    setProjects(updated);
    setCurrentProject(name);
    saveProjects(updated);
  }

  // åˆªé™¤å·¥ç¨‹
  function deleteProject(name) {
    if (!window.confirm(`ç¢ºå®šåˆªé™¤å·¥ç¨‹ã€Œ${name}ã€ï¼Ÿ`)) return;

    const updated = { ...projects };
    delete updated[name];

    const next = Object.keys(updated)[0] || "";
    setProjects(updated);
    setCurrentProject(next);
    saveProjects(updated);
  }

  return (
    <div className="bg-white p-4 rounded shadow mb-4 print-hidden">
      <h2 className="text-lg font-bold mb-3">å·¥ç¨‹ç®¡ç†</h2>

      <div className="flex flex-wrap gap-2">

        {Object.keys(projects).map(key => (
          <button
            key={key}
            onClick={() => setCurrentProject(key)}
            className={
              "px-3 py-1 rounded border " +
              (currentProject === key
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {key}
          </button>
        ))}

        <button
          onClick={addProject}
          className="px-3 py-1 rounded bg-green-600 text-white font-bold"
        >
          ï¼‹ æ–°å¢å·¥ç¨‹
        </button>

        {currentProject && (
          <button
            onClick={() => deleteProject(currentProject)}
            className="px-3 py-1 rounded bg-red-600 text-white"
          >
            åˆªé™¤ç›®å‰å·¥ç¨‹
          </button>
        )}
      </div>
    </div>
  );
}
/****************************************************
 * PART 4 â€” MaterialsPageï¼ˆå«æ–°å¢ï¼‹åˆªé™¤ï¼‹åˆ—å…§ç·¨è¼¯ï¼‰
 ****************************************************/
function MaterialsPage({ materialDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [length, setLength] = React.useState("");
  const [width, setWidth] = React.useState("");
  const [pcs, setPcs] = React.useState("");

  const categories = React.useMemo(() => {
    const s = new Set();
    materialDB.forEach(r => s.add(r.category));
    return [...s];
  }, [materialDB]);

  const specs = React.useMemo(() => {
    return materialDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, materialDB]);

  const selectedRow = React.useMemo(() => {
    return materialDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, materialDB]);

  const unitWeight = selectedRow ? Number(selectedRow.weight) : 0;
  const price = selectedRow ? Number(selectedRow.price) : 0;

  const isPlate = category.includes("æ¿");

  const weight = React.useMemo(() => {
    if (!pcs || !length) return 0;
    if (isPlate && !width) return 0;
    return isPlate
      ? Number(length) * Number(width) * unitWeight * Number(pcs)
      : unitWeight * Number(length) * Number(pcs);
  }, [length, width, pcs, isPlate, unitWeight]);

  const subtotal = Math.round(weight * price);


  /****************************************************
   * æ–°å¢ææ–™
   ****************************************************/
  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡è¦æ ¼");
      return;
    }
    if (!length || !pcs || (isPlate && !width)) {
      alert("è«‹å®Œæ•´è¼¸å…¥é•·åº¦ / (å¯¬åº¦) / ç‰‡æ•¸");
      return;
    }

    const newItem = {
      type: "ææ–™",
      category,
      spec,
      length: Number(length),
      width: isPlate ? Number(width) : null,
      pcs: Number(pcs),
      unitWeight,
      weight,
      price,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, newItem]
    });

    setSpec("");
    setLength("");
    setWidth("");
    setPcs("");
  }


  /****************************************************
   * åˆªé™¤ææ–™ï¼ˆä½¿ç”¨ type éæ¿¾å¾Œå°ç…§çœŸå¯¦ indexï¼‰
   ****************************************************/
  function deleteMaterial(idx) {
    const items = projectData.allItems.filter(i => i.type === "ææ–™");
    const target = items[idx];

    const realIndex = projectData.allItems.indexOf(target);
    if (realIndex < 0) return;

    const updated = [...projectData.allItems];
    updated.splice(realIndex, 1);

    setProjectData({ ...projectData, allItems: updated });
  }


  /****************************************************
   * åˆ—å…§ç·¨è¼¯åŠŸèƒ½ï¼ˆInline Editingï¼‰
   ****************************************************/
  const [editIndex, setEditIndex] = React.useState(null);
  const [editData, setEditData] = React.useState({});

  function startEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "ææ–™");
    const item = items[idx];

    const itemSpecs = materialDB
      .filter(r => r.category === item.category)
      .map(r => r.spec);

    setEditData({
      ...item,
      specs: itemSpecs
    });
    setEditIndex(idx);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditData({});
  }

  function saveEdit(idx) {
    const items = projectData.allItems.filter(i => i.type === "ææ–™");
    const original = items[idx];

    const realIndex = projectData.allItems.indexOf(original);

    const dbRow = materialDB.find(
      r => r.category === editData.category && r.spec === editData.spec
    );

    const unitWeight = Number(dbRow.weight);
    const price = Number(dbRow.price);
    const isPlate = editData.category.includes("æ¿");

    const newWeight = isPlate
      ? Number(editData.length) *
        Number(editData.width) *
        unitWeight *
        Number(editData.pcs)
      : unitWeight * Number(editData.length) * Number(editData.pcs);

    const newSubtotal = Math.round(newWeight * price);

    const newItem = {
      ...editData,
      unitWeight,
      weight: newWeight,
      price,
      subtotal: newSubtotal
    };

    const updated = [...projectData.allItems];
    updated[realIndex] = newItem;

    setProjectData({ ...projectData, allItems: updated });
    cancelEdit();
  }


  /****************************************************
   * æŠ“å–æ‰€æœ‰ææ–™æ˜ç´°
   ****************************************************/
  const materialItems = projectData.allItems.filter(i => i.type === "ææ–™");

  const totalWeight = materialItems.reduce((s, i) => s + (i.weight || 0), 0);


  /****************************************************
   * æ¸²æŸ“
   ****************************************************/
  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">ææ–™</h2>

      {/* æ–°å¢è¼¸å…¥å€ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => {
            setCategory(e.target.value);
            setSpec("");
          }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => (
            <option key={c}>{c}</option>
          ))}
        </select>
      </div>

      {category && (
        <div className="mb-3">
          <label className="font-bold">è¦æ ¼ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡è¦æ ¼</option>
            {specs.map(s => (
              <option key={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {category && (
        <>
          <div className="mb-3">
            <label className="font-bold">é•·åº¦ (m)ï¼š</label>
            <input
              type="number"
              value={length}
              onChange={e => setLength(e.target.value)}
              className="border px-2 py-1 rounded ml-2 w-32"
            />
          </div>

          {isPlate && (
            <div className="mb-3">
              <label className="font-bold">å¯¬åº¦ (m)ï¼š</label>
              <input
                type="number"
                value={width}
                onChange={e => setWidth(e.target.value)}
                className="border px-2 py-1 rounded ml-2 w-32"
              />
            </div>
          )}

          <div className="mb-3">
            <label className="font-bold">ç‰‡æ•¸ï¼š</label>
            <input
              type="number"
              value={pcs}
              onChange={e => setPcs(e.target.value)}
              className="border px-2 py-1 rounded ml-2 w-32"
            />
          </div>

          <div className="mb-3 p-3 bg-gray-50 border rounded">
            é‡é‡ï¼š<b>{weight.toFixed(2)}</b> kg  
            ï¼ å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
          </div>

          <button
            onClick={addToList}
            className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
          >
            ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
          </button>
        </>
      )}

      {/* ææ–™æ˜ç´°è¡¨ */}
      <h3 className="text-lg font-bold mt-6 mb-2">ææ–™æˆæœ¬æ˜ç´°</h3>

      <table className="table-auto w-full border mb-4">
        <thead>
          <tr className="bg-gray-100">
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">é•·åº¦(m)</th>
            <th className="border px-2 py-1">å¯¬åº¦(m)</th>
            <th className="border px-2 py-1">ç‰‡æ•¸</th>
            <th className="border px-2 py-1">é‡é‡(kg)</th>
            <th className="border px-2 py-1">å°è¨ˆ(å…ƒ)</th>
            <th className="border px-2 py-1 w-32">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {materialItems.map((i, idx) => {
            const rowIsPlate = i.category.includes("æ¿");

            if (editIndex === idx) {
              // â­ ç·¨è¼¯åˆ— UI
              return (
                <tr key={idx} className="bg-yellow-50">
                  <td className="border px-2 py-1">{i.category}</td>

                  <td className="border px-2 py-1">
                    <select
                      value={editData.spec}
                      onChange={e => setEditData({ ...editData, spec: e.target.value })}
                      className="border px-1 py-1 rounded w-32"
                    >
                      {editData.specs.map(s => (
                        <option key={s}>{s}</option>
                      ))}
                    </select>
                  </td>

                  <td className="border px-2 py-1">
                    <input
                      type="number"
                      value={editData.length}
                      onChange={e => setEditData({ ...editData, length: e.target.value })}
                      className="border px-1 py-1 w-20"
                    />
                  </td>

                  <td className="border px-2 py-1">
                    {rowIsPlate ? (
                      <input
                        type="number"
                        value={editData.width}
                        onChange={e => setEditData({ ...editData, width: e.target.value })}
                        className="border px-1 py-1 w-20"
                      />
                    ) : (
                      "â€”"
                    )}
                  </td>

                  <td className="border px-2 py-1">
                    <input
                      type="number"
                      value={editData.pcs}
                      onChange={e => setEditData({ ...editData, pcs: e.target.value })}
                      className="border px-1 py-1 w-20"
                    />
                  </td>

                  <td className="border px-2 py-1">{i.weight.toFixed(2)}</td>

                  <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                  <td className="border px-2 py-1 text-center">
                    <button
                      onClick={() => saveEdit(idx)}
                      className="px-2 py-1 bg-green-600 text-white rounded mr-1"
                    >
                      å„²å­˜
                    </button>

                    <button
                      onClick={cancelEdit}
                      className="px-2 py-1 bg-gray-500 text-white rounded"
                    >
                      å–æ¶ˆ
                    </button>
                  </td>
                </tr>
              );
            }

            // â­ ä¸€èˆ¬åˆ— UI
            return (
              <tr key={idx}>
                <td className="border px-2 py-1">{i.category}</td>
                <td className="border px-2 py-1">{i.spec}</td>
                <td className="border px-2 py-1">{i.length}</td>
                <td className="border px-2 py-1">{i.width ?? "â€”"}</td>
                <td className="border px-2 py-1">{i.pcs}</td>
                <td className="border px-2 py-1">{i.weight.toFixed(2)}</td>
                <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                <td className="border px-2 py-1 text-center">
                  <button
                    onClick={() => startEdit(idx)}
                    className="px-2 py-1 bg-yellow-600 text-white rounded mr-1"
                  >
                    ç·¨è¼¯
                  </button>

                  <button
                    onClick={() => deleteMaterial(idx)}
                    className="px-2 py-1 bg-red-600 text-white rounded"
                  >
                    åˆªé™¤
                  </button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>

      {/* ç¸½é‡é‡ */}
      <div className="font-bold text-right">
        ææ–™ç¸½é‡é‡ï¼š{totalWeight.toFixed(2)} kg
      </div>

    </div>
  );
}
/****************************************************
 * PART 5 â€” PurchasePageï¼ˆå¸‚è³¼å“ï¼‰Inline ç·¨è¼¯ + å–®åƒ¹è‡ªå‹•æ›´æ–°
 ****************************************************/
function PurchasePage({ purchaseDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // ====== ä¸‹æ‹‰è³‡æ–™ ======
  const categories = React.useMemo(() => {
    const s = new Set();
    purchaseDB.forEach(r => s.add(r.category));
    return [...s];
  }, [purchaseDB]);

  const specs = React.useMemo(() => {
    return purchaseDB.filter(r => r.category === category).map(r => r.spec);
  }, [category, purchaseDB]);

  const selectedRow = React.useMemo(() => {
    return purchaseDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, purchaseDB]);

  const unit = selectedRow?.unit || "";
  const autoPrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(autoPrice * Number(qty || 0));

  // ===== æ–°å¢æ˜ç´° =====
  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡å“é …");
      return;
    }
    if (!qty) {
      alert("è«‹è¼¸å…¥æ•¸é‡");
      return;
    }

    const item = {
      type: "å¸‚è³¼å“",
      category,
      spec,
      qty: Number(qty),
      unit,
      price: autoPrice,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, item]
    });

    setSpec("");
    setQty("");
  }

  // ===== æ˜ç´° =====
  const items = projectData.allItems.filter(i => i.type === "å¸‚è³¼å“");

  // ===== Inline ç·¨è¼¯ç‹€æ…‹ =====
  const [editIndex, setEditIndex] = React.useState(null);
  const [editSpec, setEditSpec] = React.useState("");
  const [editQty, setEditQty] = React.useState("");
  const [editPrice, setEditPrice] = React.useState("");
  const [editUnit, setEditUnit] = React.useState("");
  const [isPriceEdited, setIsPriceEdited] = React.useState(false); // ğŸ”¥ æ˜¯å¦äººå·¥ä¿®æ”¹åƒ¹æ ¼

  function startEdit(idx) {
    const target = items[idx];

    setEditIndex(idx);
    setEditSpec(target.spec);
    setEditQty(target.qty);
    setEditPrice(target.price);
    setEditUnit(target.unit);
    setIsPriceEdited(false);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditSpec("");
    setEditQty("");
    setEditPrice("");
    setEditUnit("");
    setIsPriceEdited(false);
  }

  // ===== å„²å­˜æ˜ç´° =====
  function saveEdit(idx) {
    const original = items[idx];

    // æ‰¾å‡ºç›¸åŒåˆ†é¡ä¸‹çš„ DB row
    const dbRow = purchaseDB.find(
      r => r.category === original.category && r.spec === editSpec
    );

    // ä½¿ç”¨ DB å–®ä½
    let finalUnit = dbRow?.unit || editUnit;

    // åƒ¹æ ¼é‚è¼¯ï¼ˆä½ æœ€é‡è¦–çš„éƒ¨åˆ†ï¼‰ğŸ”¥
    let finalPrice = editPrice;

    // è‹¥åƒ¹æ ¼æ²’æœ‰è¢«äººå·¥ä¿®æ”¹ â†’ ä½¿ç”¨ DB åƒ¹æ ¼
    if (!isPriceEdited && dbRow) {
      finalPrice = Number(dbRow.price);
    }

    const newSubtotal = Math.round(Number(editQty) * Number(finalPrice));

    // æ‰¾çœŸæ­£ index
    let count = -1;
    let realIndex = -1;
    projectData.allItems.forEach((it, i) => {
      if (it.type === "å¸‚è³¼å“") {
        count++;
        if (count === idx) realIndex = i;
      }
    });

    const arr = [...projectData.allItems];
    arr[realIndex] = {
      ...arr[realIndex],
      spec: editSpec,
      qty: Number(editQty),
      price: Number(finalPrice),
      unit: finalUnit,
      subtotal: newSubtotal
    };

    setProjectData({ ...projectData, allItems: arr });
    cancelEdit();
  }

  // ===== åˆªé™¤ =====
  function deleteItem(idx) {
    let count = -1, realIndex = -1;
    projectData.allItems.forEach((it, i) => {
      if (it.type === "å¸‚è³¼å“") {
        count++;
        if (count === idx) realIndex = i;
      }
    });

    if (realIndex < 0) return;

    const arr = [...projectData.allItems];
    arr.splice(realIndex, 1);
    setProjectData({ ...projectData, allItems: arr });
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">å¸‚è³¼å“</h2>

      {/* ===== æ–°å¢å€å¡Š ===== */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => <option key={c}>{c}</option>)}
        </select>
      </div>

      {category && (
        <div className="mb-3">
          <label className="font-bold">å“é …ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡å“é …</option>
            {specs.map(s => <option key={s}>{s}</option>)}
          </select>
        </div>
      )}

      {selectedRow && (
        <div className="p-3 border bg-gray-50 rounded mb-3">
          <div>å–®ä½ï¼š{unit}</div>
          <div>å–®åƒ¹ï¼š<b>{autoPrice.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {selectedRow && (
        <div className="p-3 border bg-gray-50 rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* ===== æ˜ç´°è¡¨ ===== */}
      <h3 className="text-lg font-bold mt-6 mb-2">å¸‚è³¼å“æˆæœ¬æ˜ç´°</h3>

      <table className="w-full border">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">å“é …</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®ä½</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const isEdit = editIndex === idx;

            const specOptions = purchaseDB
              .filter(r => r.category === i.category)
              .map(r => r.spec);

            return (
              <tr key={idx}>
                <td className="border px-2 py-1">{i.category}</td>

                {/* è¦æ ¼ */}
                <td className="border px-2 py-1">
                  {isEdit ? (
                    <select
                      value={editSpec}
                      onChange={e => {
                        const newSpec = e.target.value;
                        setEditSpec(newSpec);

                        // æ‰¾å‡ºæ–°çš„ DB row
                        const row = purchaseDB.find(
                          r => r.category === i.category && r.spec === newSpec
                        );

                        if (row) {
                          setEditUnit(row.unit);
                          if (!isPriceEdited) setEditPrice(row.price);
                        }
                      }}
                      className="border px-1 py-1 rounded"
                    >
                      {specOptions.map(s => (
                        <option key={s} value={s}>{s}</option>
                      ))}
                    </select>
                  ) : i.spec}
                </td>

                {/* æ•¸é‡ */}
                <td className="border px-2 py-1">
                  {isEdit ? (
                    <input
                      value={editQty}
                      onChange={e => setEditQty(e.target.value)}
                      type="number"
                      className="border px-1 py-1 w-20 rounded"
                    />
                  ) : i.qty}
                </td>

                {/* å–®ä½ */}
                <td className="border px-2 py-1">{isEdit ? editUnit : i.unit}</td>

                {/* å–®åƒ¹ */}
                <td className="border px-2 py-1">
                  {isEdit ? (
                    <input
                      value={editPrice}
                      onChange={e => {
                        setEditPrice(e.target.value);
                        setIsPriceEdited(true); // ä½¿ç”¨è€…å·²äººå·¥æ”¹åƒ¹
                      }}
                      type="number"
                      className="border px-1 py-1 w-24 rounded"
                    />
                  ) : i.price.toLocaleString()}
                </td>

                {/* å°è¨ˆ */}
                <td className="border px-2 py-1">
                  {isEdit
                    ? (Number(editQty) * Number(editPrice)).toLocaleString()
                    : i.subtotal.toLocaleString()}
                </td>

                {/* æ“ä½œ */}
                <td className="border px-2 py-1 text-center">
                  {isEdit ? (
                    <>
                      <button
                        className="px-2 py-1 bg-green-600 text-white rounded mr-1"
                        onClick={() => saveEdit(idx)}
                      >
                        å„²å­˜
                      </button>
                      <button
                        className="px-2 py-1 bg-gray-500 text-white rounded"
                        onClick={cancelEdit}
                      >
                        å–æ¶ˆ
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        className="px-2 py-1 bg-blue-600 text-white rounded mr-1"
                        onClick={() => startEdit(idx)}
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        className="px-2 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteItem(idx)}
                      >
                        åˆªé™¤
                      </button>
                    </>
                  )}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 6 â€” FabricationPageï¼ˆè£½ä½œæˆæœ¬ï¼‰Inline ç·¨è¼¯ + å–®åƒ¹è‡ªå‹•æ›´æ–°
 ****************************************************/
function FabricationPage({ fabricationDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  /* === ä¸‹æ‹‰ === */
  const categories = React.useMemo(() => {
    const s = new Set();
    fabricationDB.forEach(r => s.add(r.category));
    return [...s];
  }, [fabricationDB]);

  const specs = React.useMemo(() => {
    return fabricationDB.filter(r => r.category === category).map(r => r.spec);
  }, [category, fabricationDB]);

  const selectedRow = React.useMemo(() => {
    return fabricationDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, fabricationDB]);

  const unit = selectedRow?.unit || "";
  const autoPrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round(autoPrice * Number(qty || 0));

  /* === æ–°å¢æ˜ç´° === */
  function addToList() {
    if (!category || !spec) {
      alert("è«‹é¸æ“‡åˆ†é¡èˆ‡é …ç›®");
      return;
    }
    if (!qty) {
      alert("è«‹è¼¸å…¥æ•¸é‡");
      return;
    }

    const item = {
      type: "è£½ä½œæˆæœ¬",
      category,
      spec,
      qty: Number(qty),
      unit,
      price: autoPrice,
      subtotal
    };

    setProjectData({
      ...projectData,
      allItems: [...projectData.allItems, item]
    });

    setSpec("");
    setQty("");
  }

  /* === æ˜ç´° === */
  const items = projectData.allItems.filter(i => i.type === "è£½ä½œæˆæœ¬");

  /* === Inline ç·¨è¼¯ç‹€æ…‹ === */
  const [editIndex, setEditIndex] = React.useState(null);
  const [editSpec, setEditSpec] = React.useState("");
  const [editQty, setEditQty] = React.useState("");
  const [editPrice, setEditPrice] = React.useState("");
  const [editUnit, setEditUnit] = React.useState("");
  const [isPriceEdited, setIsPriceEdited] = React.useState(false);

  function startEdit(idx) {
    const target = items[idx];
    setEditIndex(idx);
    setEditSpec(target.spec);
    setEditQty(target.qty);
    setEditPrice(target.price);
    setEditUnit(target.unit);
    setIsPriceEdited(false);
  }

  function cancelEdit() {
    setEditIndex(null);
    setEditSpec("");
    setEditQty("");
    setEditPrice("");
    setEditUnit("");
    setIsPriceEdited(false);
  }

  /* === å„²å­˜ç·¨è¼¯ === */
  function saveEdit(idx) {
    const original = items[idx];

    const dbRow = fabricationDB.find(
      r => r.category === original.category && r.spec === editSpec
    );

    let finalUnit = dbRow?.unit || editUnit;

    let finalPrice = editPrice;
    if (!isPriceEdited && dbRow) {
      finalPrice = Number(dbRow.price);
    }

    const newSubtotal = Math.round(Number(editQty) * Number(finalPrice));

    // æ‰¾çœŸæ­£ index
    let count = -1;
    let realIndex = -1;
    projectData.allItems.forEach((it, i) => {
      if (it.type === "è£½ä½œæˆæœ¬") {
        count++;
        if (count === idx) realIndex = i;
      }
    });

    const arr = [...projectData.allItems];
    arr[realIndex] = {
      ...arr[realIndex],
      spec: editSpec,
      qty: Number(editQty),
      unit: finalUnit,
      price: Number(finalPrice),
      subtotal: newSubtotal
    };

    setProjectData({ ...projectData, allItems: arr });
    cancelEdit();
  }

  /* === åˆªé™¤ === */
  function deleteItem(idx) {
    let count = -1;
    let realIndex = -1;

    projectData.allItems.forEach((it, i) => {
      if (it.type === "è£½ä½œæˆæœ¬") {
        count++;
        if (count === idx) realIndex = i;
      }
    });

    if (realIndex < 0) return;

    const arr = [...projectData.allItems];
    arr.splice(realIndex, 1);
    setProjectData({ ...projectData, allItems: arr });
  }

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">è£½ä½œæˆæœ¬</h2>

      {/* æ–°å¢å€ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => <option key={c}>{c}</option>)}
        </select>
      </div>

      {category && (
        <div className="mb-3">
          <label className="font-bold">é …ç›®ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">è«‹é¸æ“‡é …ç›®</option>
            {specs.map(s => <option key={s}>{s}</option>)}
          </select>
        </div>
      )}

      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>å–®ä½ï¼š{unit}</div>
          <div>å–®åƒ¹ï¼š<b>{autoPrice.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            value={qty}
            onChange={e => setQty(e.target.value)}
            type="number"
            className="border px-2 py-1 ml-2 w-32 rounded"
          />
        </div>
      )}

      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* æ˜ç´°è¡¨ */}
      <h3 className="mt-6 mb-2 text-lg font-bold">è£½ä½œæˆæœ¬æ˜ç´°</h3>

      <table className="w-full border mb-4">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">é …ç›®</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®ä½</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const isEdit = editIndex === idx;

            const specOptions = fabricationDB
              .filter(r => r.category === i.category)
              .map(r => r.spec);

            return (
              <tr key={idx}>
                <td className="border px-2 py-1">{i.category}</td>

                {/* è¦æ ¼ */}
                <td className="border px-2 py-1">
                  {isEdit ? (
                    <select
                      value={editSpec}
                      onChange={e => {
                        const newSpec = e.target.value;
                        setEditSpec(newSpec);

                        const row = fabricationDB.find(
                          r => r.category === i.category && r.spec === newSpec
                        );

                        if (row) {
                          setEditUnit(row.unit);
                          if (!isPriceEdited) {
                            setEditPrice(row.price);
                          }
                        }
                      }}
                      className="border px-1 py-1 rounded"
                    >
                      {specOptions.map(s => (
                        <option key={s} value={s}>{s}</option>
                      ))}
                    </select>
                  ) : i.spec}
                </td>

                {/* æ•¸é‡ */}
                <td className="border px-2 py-1">
                  {isEdit ? (
                    <input
                      value={editQty}
                      onChange={e => setEditQty(e.target.value)}
                      type="number"
                      className="border px-1 py-1 w-20 rounded"
                    />
                  ) : i.qty}
                </td>

                {/* å–®ä½ */}
                <td className="border px-2 py-1">{isEdit ? editUnit : i.unit}</td>

                {/* å–®åƒ¹ */}
                <td className="border px-2 py-1">
                  {isEdit ? (
                    <input
                      value={editPrice}
                      onChange={e => {
                        setEditPrice(e.target.value);
                        setIsPriceEdited(true);
                      }}
                      type="number"
                      className="border px-1 py-1 w-24 rounded"
                    />
                  ) : i.price.toLocaleString()}
                </td>

                {/* å°è¨ˆ */}
                <td className="border px-2 py-1">
                  {isEdit
                    ? (Number(editQty) * Number(editPrice)).toLocaleString()
                    : i.subtotal.toLocaleString()}
                </td>

                {/* æ“ä½œ */}
                <td className="border px-2 py-1 text-center">
                  {isEdit ? (
                    <>
                      <button
                        className="px-2 py-1 bg-green-600 text-white rounded mr-1"
                        onClick={() => saveEdit(idx)}
                      >
                        å„²å­˜
                      </button>
                      <button
                        className="px-2 py-1 bg-gray-500 text-white rounded"
                        onClick={cancelEdit}
                      >
                        å–æ¶ˆ
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        className="px-2 py-1 bg-blue-600 text-white rounded mr-1"
                        onClick={() => startEdit(idx)}
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        className="px-2 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteItem(idx)}
                      >
                        åˆªé™¤
                      </button>
                    </>
                  )}
                </td>

              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 7 â€” TransportPageï¼ˆé‹è¼¸è²»ç”¨ï¼‰
 * - åˆ†é¡ä¸å¯æ”¹
 * - è¦æ ¼å¯æ”¹ï¼ˆæœƒè‡ªå‹•æ›´æ–°ï¼šåœ°å€ / å–®ä½ / å–®åƒ¹ï¼‰
 * - å–®åƒ¹å¯æ‰‹å‹•è¦†å¯«
 * - æ•¸é‡å¯ä¿®æ”¹
 * - Inline ç·¨è¼¯ã€åˆªé™¤
 ****************************************************/

function TransportPage({ transportDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // å»ºç«‹åˆ†é¡æ¸…å–®
  const categories = React.useMemo(() => {
    const s = new Set();
    transportDB.forEach(r => s.add(r.category));
    return [...s];
  }, [transportDB]);

  // ä¾åˆ†é¡å–å¾—è¦æ ¼
  const specs = React.useMemo(() => {
    return transportDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, transportDB]);

  // é¸åˆ°çš„è³‡æ–™ row
  const selectedRow = React.useMemo(() => {
    return transportDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, transportDB]);

  const basePrice = selectedRow ? Number(selectedRow.price) : 0;
  const region = selectedRow?.region || "";
  const unit = selectedRow?.unit || "å°";
  const subtotal = Math.round((Number(qty) || 0) * basePrice);

  /** åŠ å…¥æ˜ç´° */
  function addToList() {
    if (!category || !spec) return alert("è«‹é¸æ“‡åˆ†é¡èˆ‡é …ç›®");
    if (!qty) return alert("è«‹è¼¸å…¥æ•¸é‡");

    const item = {
      type: "é‹è¼¸è²»ç”¨",
      category,
      spec,
      region,
      unit,
      qty: Number(qty),
      price: basePrice,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);
    setSpec("");
    setQty("");
  }

  /** æ˜ç´°è³‡æ–™ï¼ˆæ­¤å·¥ç¨‹æ‰€æœ‰çš„é‹è¼¸è²»ç”¨ï¼‰ */
  const items = projectData.allItems.filter(i => i.type === "é‹è¼¸è²»ç”¨");

  /** ä¿®æ”¹æ˜ç´° */
  function updateItem(index, field, value) {
    const updated = { ...projectData };
    const item = updated.allItems[index];

    // è¦æ ¼ä¸‹æ‹‰ â†’ è‡ªå‹•åŒæ­¥ DB å¸¶è³‡æ–™
    if (field === "spec") {
      const row = transportDB.find(
        r => r.category === item.category && r.spec === value
      );

      item.spec = value;
      if (row) {
        item.region = row.region;
        item.unit = row.unit;
        item.price = Number(row.price);
      }
    }
    // æ‰‹å‹•æ”¹å–®åƒ¹
    else if (field === "price") {
      item.price = Number(value || 0);
    }
    // æ•¸é‡
    else if (field === "qty") {
      item.qty = Number(value || 0);
    }

    // å°è¨ˆé‡æ–°ç®—
    item.subtotal = Math.round(item.qty * item.price);

    setProjectData(updated);
  }

  /** åˆªé™¤é …ç›® */
  function deleteItem(index) {
    const updated = { ...projectData };
    updated.allItems = updated.allItems.filter((_, i) => i !== index);
    setProjectData(updated);
  }

  return (
    <div className="p-4 bg-white rounded shadow">

      <h2 className="text-xl font-bold mb-4">é‹è¼¸è²»ç”¨</h2>

      {/* ---- æ–°å¢è¼¸å…¥å€ ---- */}
      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* é …ç›® */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">é …ç›®ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">è«‹é¸æ“‡é …ç›®</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* é¡¯ç¤º DB å¸¶å‡ºçš„è³‡æ–™ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>åœ°å€ï¼š<b>{region}</b></div>
          <div>å–®ä½ï¼š<b>{unit}</b></div>
          <div>å–®åƒ¹ï¼š<b>{basePrice.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-3">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 ml-2 w-32 rounded"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æˆæœ¬æ˜ç´°è¡¨
      </button>

      {/* ---- æ˜ç´°è¡¨ ---- */}
      <h3 className="mt-6 mb-2 text-lg font-bold">é‹è¼¸è²»ç”¨æ˜ç´°</h3>

      <table className="w-full border mb-4 text-sm">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">é …ç›®</th>
            <th className="border px-2 py-1">åœ°å€</th>
            <th className="border px-2 py-1">å–®ä½</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => (
            <tr key={idx}>
              <td className="border px-2 py-1">{i.category}</td>

              {/* è¦æ ¼ä¸‹æ‹‰ */}
              <td className="border px-2 py-1">
                <select
                  value={i.spec}
                  onChange={e => updateItem(
                    projectData.allItems.indexOf(i),
                    "spec",
                    e.target.value
                  )}
                  className="border px-1 py-1 rounded"
                >
                  {transportDB
                    .filter(r => r.category === i.category)
                    .map(r => (
                      <option key={r.spec} value={r.spec}>{r.spec}</option>
                    ))}
                </select>
              </td>

              {/* åœ°å€ï¼ˆåªè®€ï¼‰ */}
              <td className="border px-2 py-1">{i.region}</td>

              {/* å–®ä½ï¼ˆåªè®€ï¼‰ */}
              <td className="border px-2 py-1">{i.unit}</td>

              {/* æ•¸é‡ */}
              <td className="border px-2 py-1">
                <input
                  type="number"
                  value={i.qty}
                  onChange={e => updateItem(
                    projectData.allItems.indexOf(i),
                    "qty",
                    e.target.value
                  )}
                  className="border px-1 py-1 w-20 rounded"
                />
              </td>

              {/* å–®åƒ¹ */}
              <td className="border px-2 py-1">
                <input
                  type="number"
                  value={i.price}
                  onChange={e => updateItem(
                    projectData.allItems.indexOf(i),
                    "price",
                    e.target.value
                  )}
                  className="border px-1 py-1 w-24 rounded"
                />
              </td>

              <td className="border px-2 py-1">
                {i.subtotal.toLocaleString()}
              </td>

              {/* åˆªé™¤ */}
              <td className="border px-2 py-1 text-center">
                <button
                  onClick={() =>
                    deleteItem(projectData.allItems.indexOf(i))
                  }
                  className="text-red-600 font-bold"
                >
                  åˆªé™¤
                </button>
              </td>

            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 8 â€” InstallPageï¼ˆç¾å ´å®‰è£ï¼‰
 * - è¦æ ¼å¯æ”¹ï¼ˆè‡ªå‹•å¸¶ï¼šå–®ä½ / å–®åƒ¹ï¼‰
 * - å–®åƒ¹å¯æ‰‹å‹•è¦†å¯«
 * - æ•¸é‡å¯ä¿®æ”¹
 * - Inline ç·¨è¼¯ + åˆªé™¤
 ****************************************************/

function InstallPage({ installDB, projectData, setProjectData }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // åˆ†é¡
  const categories = React.useMemo(() => {
    const s = new Set();
    installDB.forEach(r => s.add(r.category));
    return [...s];
  }, [installDB]);

  // è¦æ ¼æ¸…å–®
  const specs = React.useMemo(() => {
    return installDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, installDB]);

  // é¸ä¸­çš„ row
  const selectedRow = React.useMemo(() => {
    return installDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, installDB]);

  const unit = selectedRow?.unit || "å°";
  const basePrice = selectedRow ? Number(selectedRow.price) : 0;
  const subtotal = Math.round((Number(qty) || 0) * basePrice);

  /** â• æ–°å¢ */
  function addToList() {
    if (!category || !spec) return alert("è«‹é¸æ“‡åˆ†é¡èˆ‡è¦æ ¼");
    if (!qty) return alert("è«‹è¼¸å…¥æ•¸é‡");

    const item = {
      type: "ç¾å ´å®‰è£",
      category,
      spec,
      unit,
      qty: Number(qty),
      price: basePrice,
      subtotal
    };

    const updated = {
      ...projectData,
      allItems: [...projectData.allItems, item]
    };

    setProjectData(updated);

    setSpec("");
    setQty("");
  }

  /** ç¾å ´å®‰è£æ˜ç´° */
  const items = projectData.allItems.filter(i => i.type === "ç¾å ´å®‰è£");

  /** âœ æ›´æ–°æ˜ç´° */
  function updateItem(index, field, value) {
    const updated = { ...projectData };
    const item = updated.allItems[index];

    if (field === "spec") {
      const row = installDB.find(
        r => r.category === item.category && r.spec === value
      );
      item.spec = value;

      if (row) {
        item.unit = row.unit;
        item.price = Number(row.price);
      }
    }
    else if (field === "qty") {
      item.qty = Number(value || 0);
    }
    else if (field === "price") {
      item.price = Number(value || 0);
    }

    item.subtotal = Math.round(item.qty * item.price);

    setProjectData(updated);
  }

  /** ğŸ—‘ åˆªé™¤ */
  function deleteItem(index) {
    const updated = { ...projectData };
    updated.allItems = updated.allItems.filter((_, i) => i !== index);
    setProjectData(updated);
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">ç¾å ´å®‰è£</h2>

      {/* --- æ–°å¢è¼¸å…¥å€ --- */}
      {/* åˆ†é¡ */}
      <div className="mb-3">
        <label className="font-bold">åˆ†é¡ï¼š</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">è«‹é¸æ“‡åˆ†é¡</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* è¦æ ¼ */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">è¦æ ¼ï¼š</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">è«‹é¸æ“‡è¦æ ¼</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* é¡¯ç¤º DB å¸¶è³‡æ–™ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          <div>å–®ä½ï¼š<b>{unit}</b></div>
          <div>å–®åƒ¹ï¼š<b>{basePrice.toLocaleString()}</b> å…ƒ</div>
        </div>
      )}

      {/* æ•¸é‡ */}
      {selectedRow && (
        <div className="mb-3">
          <label className="font-bold">æ•¸é‡ï¼š</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 ml-2 w-32 rounded"
          />
        </div>
      )}

      {/* å°è¨ˆ */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          å°è¨ˆï¼š<b>{subtotal.toLocaleString()}</b> å…ƒ
        </div>
      )}

      <button
        onClick={addToList}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ï¼‹ åŠ å…¥æ˜ç´°
      </button>

      {/* --- æ˜ç´°è¡¨ --- */}
      <h3 className="mt-6 mb-2 text-lg font-bold">ç¾å ´å®‰è£æ˜ç´°</h3>

      <table className="w-full border mb-4 text-sm">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-2 py-1">åˆ†é¡</th>
            <th className="border px-2 py-1">è¦æ ¼</th>
            <th className="border px-2 py-1">å–®ä½</th>
            <th className="border px-2 py-1">æ•¸é‡</th>
            <th className="border px-2 py-1">å–®åƒ¹</th>
            <th className="border px-2 py-1">å°è¨ˆ</th>
            <th className="border px-2 py-1">æ“ä½œ</th>
          </tr>
        </thead>

        <tbody>
          {items.map((i, idx) => {
            const globalIndex = projectData.allItems.indexOf(i);

            return (
              <tr key={idx}>
                <td className="border px-2 py-1">{i.category}</td>

                {/* è¦æ ¼ä¸‹æ‹‰å¯æ”¹ */}
                <td className="border px-2 py-1">
                  <select
                    value={i.spec}
                    onChange={e => updateItem(globalIndex, "spec", e.target.value)}
                    className="border px-1 py-1 rounded"
                  >
                    {installDB
                      .filter(r => r.category === i.category)
                      .map(r => (
                        <option key={r.spec} value={r.spec}>{r.spec}</option>
                      ))}
                  </select>
                </td>

                {/* å–®ä½ï¼ˆåªè®€ï¼‰ */}
                <td className="border px-2 py-1">{i.unit}</td>

                {/* æ•¸é‡å¯æ”¹ */}
                <td className="border px-2 py-1">
                  <input
                    type="number"
                    value={i.qty}
                    onChange={e => updateItem(globalIndex, "qty", e.target.value)}
                    className="border px-1 py-1 w-20 rounded"
                  />
                </td>

                {/* å–®åƒ¹å¯æ”¹ */}
                <td className="border px-2 py-1">
                  <input
                    type="number"
                    value={i.price}
                    onChange={e => updateItem(globalIndex, "price", e.target.value)}
                    className="border px-1 py-1 w-24 rounded"
                  />
                </td>

                <td className="border px-2 py-1">{i.subtotal.toLocaleString()}</td>

                {/* åˆªé™¤ */}
                <td className="border px-2 py-1 text-center">
                  <button
                    onClick={() => deleteItem(globalIndex)}
                    className="text-red-600 font-bold"
                  >
                    åˆªé™¤
                  </button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
/****************************************************
 * PART 9 â€” SummaryPageï¼ˆç¸½è¡¨ï¼‰
 ****************************************************/
function SummaryPage({ projectData, currentProject, updateProjectData }) {
  const chartRef = React.useRef(null);

  /*************** äº”å¤§é¡æˆæœ¬å°è¨ˆ ***************/
  const sumByType = type =>
    projectData.allItems
      .filter(i => i.type === type)
      .reduce((a, b) => a + (b.subtotal || 0), 0);

  const materialSum = sumByType("ææ–™");
  const purchaseSum = sumByType("å¸‚è³¼å“");
  const fabSum = sumByType("è£½ä½œæˆæœ¬");
  const transSum = sumByType("é‹è¼¸è²»ç”¨");
  const installSum = sumByType("ç¾å ´å®‰è£");

  const fiveTotal = materialSum + purchaseSum + fabSum + transSum + installSum;

  /*************** äººå·¥èª¿æ•´æ¬„ä½ ***************/
  const manualAdjustDetail = projectData.manualAdjustDetail || {
    material: 0,
    purchase: 0,
    fabrication: 0,
    transport: 0,
    install: 0
  };

  const manualTotal = Object.values(manualAdjustDetail).reduce(
    (a, b) => a + Number(b || 0),
    0
  );

  const finalCost = fiveTotal + manualTotal;

  /*************** ç®¡éŠ· / æ¯›åˆ© / å”®åƒ¹ ***************/
  const [adminRate, setAdminRate] = React.useState(15);
  const [profitRate, setProfitRate] = React.useState(35);

  const adminFee = Math.round(finalCost * (adminRate / 100));
  const suggestPrice = Math.round(
    (finalCost + adminFee) / (1 - profitRate / 100)
  );

  /*************** æ›´æ–°äººå·¥èª¿æ•´æ•¸å€¼ï¼ˆå…è¨±ä»»æ„ä½æ•¸ï¼‰ ***************/
  function updateManualAdjust(field, value) {
    const num = value === "" ? "" : Number(value);

    const newDetail = {
      ...manualAdjustDetail,
      [field]: num
    };

    updateProjectData({
      ...projectData,
      manualAdjustDetail: newDetail
    });
  }

  /*************** åœ“é¤…åœ– ***************/
  React.useEffect(() => {
    const ctx = document.getElementById("summaryChart");
    if (!ctx) return;

    if (window.summaryChart && typeof window.summaryChart.destroy === "function") {
      window.summaryChart.destroy();
    }

    const data = [materialSum, purchaseSum, fabSum, transSum, installSum];
    const labels = ["ææ–™", "å¸‚è³¼å“", "è£½ä½œ", "é‹è¼¸", "å®‰è£"];

    window.summaryChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [
          {
            data,
            backgroundColor: ["#4fa3d1", "#ffcc66", "#66cc99", "#ff6666", "#9999ff"]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom" },
          datalabels: {
            color: "#000",
            font: { weight: "bold", size: 16 },
            formatter: (value, ctx) => {
              const total = data.reduce((a, b) => a + b, 0);
              return total === 0 ? "0%" : ((value / total) * 100).toFixed(1) + "%";
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }, [materialSum, purchaseSum, fabSum, transSum, installSum]);

  /*************** åŒ¯å‡º Excel ***************/
  function exportExcel() {
    const wb = XLSX.utils.book_new();

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");

    const projectName = currentProject || "æœªå‘½åå·¥ç¨‹";
    const fileName = `${yyyy}${mm}${dd}-${projectName}-æˆæœ¬åˆ†æ.xlsx`;

    const rows = [];

    rows.push(["ææ–™æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "é•·m", "å¯¬m", "æ•¸é‡", "é‡é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "ææ–™")
      .forEach(i =>
        rows.push([
          i.category,
          i.spec,
          i.length || "",
          i.width || "",
          i.qty,
          i.weight || "",
          i.price,
          i.subtotal
        ])
      );
    rows.push(["åˆè¨ˆ", "", "", "", "", "", "", materialSum]);
    rows.push([]);

    rows.push(["å¸‚è³¼å“æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "å¸‚è³¼å“")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", purchaseSum]);
    rows.push([]);

    rows.push(["è£½ä½œæˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "è£½ä½œæˆæœ¬")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", fabSum]);
    rows.push([]);

    rows.push(["é‹è¼¸æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "é‹è¼¸è²»ç”¨")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", transSum]);
    rows.push([]);

    rows.push(["ç¾å ´å®‰è£æˆæœ¬æ˜ç´°è¡¨"]);
    rows.push(["åˆ†é¡", "è¦æ ¼", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]);
    projectData.allItems
      .filter(i => i.type === "ç¾å ´å®‰è£")
      .forEach(i =>
        rows.push([i.category, i.spec, i.qty, i.price, i.subtotal])
      );
    rows.push(["åˆè¨ˆ", "", "", "", installSum]);
    rows.push([]);

    rows.push(["", "é …ç›®", "é‡‘é¡"]);
    rows.push(["", "äº”å¤§æˆæœ¬åˆè¨ˆ", fiveTotal]);
    rows.push(["", "äººå·¥èª¿æ•´åˆè¨ˆ", manualTotal]);
    rows.push(["", "æœ€çµ‚æˆæœ¬", finalCost]);
    rows.push(["", "ç®¡éŠ·(%)", adminRate]);
    rows.push(["", "ç®¡éŠ·è²»", adminFee]);
    rows.push(["", "æ¯›åˆ©ç‡(%)", profitRate]);
    rows.push(["", "å»ºè­°å”®åƒ¹", suggestPrice]);

    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "æˆæœ¬åˆ†æ");

    XLSX.writeFile(wb, fileName);
  }

  /*************** RETURNï¼šé é¢ UI ***************/
  return (
    <div className="p-4 max-w-5xl mx-auto">
      <h2 className="text-2xl font-bold mb-4">æˆæœ¬ç¸½è¡¨</h2>

      {/* åœ“é¤…åœ– */}
      <div className="w-full h-80 mb-6">
        <canvas id="summaryChart"></canvas>
      </div>

{/* äº”å¤§æˆæœ¬èˆ‡äººå·¥èª¿æ•´ï¼šåˆä½µç‰ˆ */}
<div className="bg-white p-4 rounded shadow mb-4">
  <h3 className="font-bold text-lg mb-2">äº”å¤§æˆæœ¬ + äººå·¥èª¿æ•´</h3>

  <div className="grid grid-cols-2 gap-3">
    {/* ææ–™ */}
    <div>
      <p>ææ–™æˆæœ¬ï¼š{materialSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.material}
          onChange={e => updateManualAdjust("material", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* å¸‚è³¼å“ */}
    <div>
      <p>å¸‚è³¼å“æˆæœ¬ï¼š{purchaseSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.purchase}
          onChange={e => updateManualAdjust("purchase", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* è£½ä½œ */}
    <div>
      <p>è£½ä½œæˆæœ¬ï¼š{fabSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.fabrication}
          onChange={e => updateManualAdjust("fabrication", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* é‹è¼¸ */}
    <div>
      <p>é‹è¼¸è²»ç”¨ï¼š{transSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.transport}
          onChange={e => updateManualAdjust("transport", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>

    {/* å®‰è£ */}
    <div>
      <p>ç¾å ´å®‰è£æˆæœ¬ï¼š{installSum}</p>
    </div>
    <div>
      <label>äººå·¥èª¿æ•´ï¼š
        <input
          type="number"
          value={manualAdjustDetail.install}
          onChange={e => updateManualAdjust("install", e.target.value)}
          className="border p-1 w-full"
        />
      </label>
    </div>
  </div>

  {/* å°è¨ˆå€ */}
  <div className="mt-4">
    <p className="font-bold">äººå·¥èª¿æ•´å°è¨ˆï¼š{manualTotal}</p>
    <p className="font-bold text-lg">æœ€çµ‚æˆæœ¬ï¼š{finalCost}</p>
  </div>
</div>

{/* ç®¡éŠ·ã€æ¯›åˆ©ç‡ã€å»ºè­°å”®åƒ¹ */}
<div className="bg-white p-4 rounded shadow mb-4">
  <div className="grid grid-cols-2 gap-2 mt-2">

    <label>ç®¡éŠ·(%)
      <input
        type="number"
        value={adminRate}
        onChange={(e) => setAdminRate(Number(e.target.value))}
        className="border p-1 w-full"
      />
    </label>

    <p>ç®¡éŠ·è²»ï¼š{adminFee}</p>

    <label>æ¯›åˆ©ç‡(%)
      <input
        type="number"
        value={profitRate}
        onChange={(e) => setProfitRate(Number(e.target.value))}
        className="border p-1 w-full"
      />
    </label>

    <p className="font-bold text-lg">å»ºè­°å”®åƒ¹ï¼š{suggestPrice}</p>

  </div>
</div>

      {/* åŒ¯å‡º Excel + åˆ—å° */}
      <div className="flex gap-3 print-hidden mt-4">

        <button
          onClick={exportExcel}
          className="bg-green-600 text-white px-4 py-2 rounded shadow"
        >
          åŒ¯å‡º Excel
        </button>

        {/* ğŸ–¨ åˆ—å°æŒ‰éˆ• */}
              <button
        onClick={() => window.print()}
        className="bg-gray-700 text-white px-4 py-2 rounded shadow"
      >
        åˆ—å°
      </button>
      </div>

    </div>
  );
}   
/****************************************************
 * PART 10 â€” Appï¼ˆä¸»æ§åˆ¶ï¼‰
 * - å¤šå·¥ç¨‹ç®¡ç†
 * - Google Sheet åŒæ­¥
 * - åˆ†é åˆ‡æ›
 * - æ¸²æŸ“äº”å¤§æˆæœ¬é  + SummaryPage
 ****************************************************/
function App() {
  // è¼‰å…¥å¾Œä¿è­‰æ°¸é æ˜¯æ­£å¸¸è³‡æ–™çµæ§‹
  const safeProjects = loadProjects();

  const [projects, setProjects] = React.useState(safeProjects);

  const [currentProject, setCurrentProject] = React.useState(
    Object.keys(safeProjects)[0] || ""
  );

  // é é¢åˆ‡æ›
  const [page, setPage] = React.useState("ææ–™");

  // äº”å¤§è³‡æ–™åº«
  const [materialDB, setMaterialDB] = React.useState([]);
  const [purchaseDB, setPurchaseDB] = React.useState([]);
  const [fabricationDB, setFabricationDB] = React.useState([]);
  const [transportDB, setTransportDB] = React.useState([]);
  const [installDB, setInstallDB] = React.useState([]);

  // Google Sheet + localStorage åŒæ­¥ï¼ˆæ¨¡å¼ Cï¼‰
  async function fetchCSV(url) {
    const text = await fetch(url).then(r => r.text());
    const rows = text.split("\n").map(r => r.trim());
    const version = `${rows.length}-${rows[0]}-${rows[rows.length - 1]}`;
    return { rows, version };
  }

  async function loadDB(name, url, setter) {
    const local = localStorage.getItem("db_" + name);
    const localV = localStorage.getItem("dbv_" + name);

    const { rows, version } = await fetchCSV(url);

    if (local && localV === version) {
      setter(JSON.parse(local));
    } else {
      const parsed = rows
  .slice(1)
  .map(r => r.split(","))
  .filter(r => r.length >= 2)
  .map(r => {

    // â‘  ææ–™ï¼ˆæœ‰é‡é‡ï¼‰
    if (name === "material") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        weight: Number(r[3] || 0),
        price: Number(r[4] || 0)
      };
    }

    // â‘¡ å¸‚è³¼å“ï¼ˆç„¡é‡é‡ï¼‰
    if (name === "purchase") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        price: Number(r[3] || 0)
      };
    }

    // â‘¢ è£½ä½œæˆæœ¬ï¼ˆç„¡é‡é‡ï¼‰
    if (name === "fabrication") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        price: Number(r[3] || 0)
      };
    }

    // â‘£ é‹è¼¸è²»ç”¨ï¼ˆæ¬„ä½é †åºä¸åŒï¼‰
    if (name === "transport") {
      return {
        category: r[0],   // é«˜ç©ºä½œæ¥­è»Š
        spec: r[1],       // 21M
        region: r[2],     // å—/åŒ—/ä¸­
        price: Number(r[3] || 0),
        unit: r[4] || "å°"
      };
    }

    // â‘¤ ç¾å ´å®‰è£ï¼ˆç„¡é‡é‡ï¼‰
    if (name === "install") {
      return {
        category: r[0],
        spec: r[1],
        unit: r[2],
        price: Number(r[3] || 0)
      };
    }

  });


setter(parsed);
localStorage.setItem("db_" + name, JSON.stringify(parsed));
localStorage.setItem("dbv_" + name, version);
localStorage.setItem("dbts_" + name, new Date().toISOString());
    }
  }

// åˆå§‹åŒ–ï¼Œè¼‰å…¥äº”å¤§è³‡æ–™åº«
React.useEffect(() => {
  loadDB("material", CSV_URLS.material, setMaterialDB);
  loadDB("purchase", CSV_URLS.purchase, setPurchaseDB);
  loadDB("fabrication", CSV_URLS.fabrication, setFabricationDB);
  loadDB("transport", CSV_URLS.transport, setTransportDB);
  loadDB("install", CSV_URLS.install, setInstallDB);
}, []);

  // å–å¾—ç›®å‰å·¥ç¨‹è³‡æ–™
  const projectData = projects[currentProject] || {
    projectName: "",     // â† åŠ é€™ä¸€è¡Œ
    allItems: [],
    manualAdjust: 0
  };

  // æ›´æ–°ç›®å‰å·¥ç¨‹è³‡æ–™
  function updateProjectData(newData) {
    const updated = {
      ...projects,
      [currentProject]: newData
    };
    setProjects(updated);
    saveProjects(updated);
  }

  return (
    <div className="p-4 max-w-5xl mx-auto">


      {/* å·¥ç¨‹ç®¡ç† */}
      <ProjectManager
        currentProject={currentProject}
        setCurrentProject={setCurrentProject}
        projects={projects}
        setProjects={setProjects}
      />

      {/* åˆ†é åŠŸèƒ½ */}
      <div className="flex gap-2 mb-4">
        {["ææ–™", "å¸‚è³¼å“", "è£½ä½œæˆæœ¬", "é‹è¼¸è²»ç”¨", "ç¾å ´å®‰è£", "ç¸½è¡¨"].map(tab => (
          <button
            key={tab}
            onClick={() => setPage(tab)}
            className={
              "px-3 py-1 rounded border " +
              (page === tab
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {tab}
          </button>
        ))}
      </div>

      {/* é é¢å…§å®¹ */}
      {page === "ææ–™" && (
        <MaterialsPage
          materialDB={materialDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "å¸‚è³¼å“" && (
        <PurchasePage
          purchaseDB={purchaseDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "è£½ä½œæˆæœ¬" && (
        <FabricationPage
          fabricationDB={fabricationDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "é‹è¼¸è²»ç”¨" && (
        <TransportPage
          transportDB={transportDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

      {page === "ç¾å ´å®‰è£" && (
        <InstallPage
          installDB={installDB}
          projectData={projectData}
          setProjectData={updateProjectData}
        />
      )}

     {page === "ç¸½è¡¨" && (
  <SummaryPage
    projectData={projectData}
    currentProject={currentProject}
    updateProjectData={updateProjectData}
  />
)}
    </div>
  );
}
/****************************************************
 * æ¸²æŸ“ App
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>  <!-- â†â†â† é€™å€‹çµæŸ script æ˜¯æ•´ç«™èƒ½å¦æ­£å¸¸æ¸²æŸ“çš„é—œéµ -->
  
</body>
</html>
