<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>工程五大成本試算系統（需人工整合 PART 1–10）</title>
</head>
<body>
{
  工程1: { allItems:[], manualAdjust:0 },
  工程2: { ... }
}
/****************************************************
 * PART 2 — ProjectManager Component
 * 多工程管理：新增工程、刪除工程、切換工程
 * 結構：
 * {
 *   "工程名稱A": { allItems:[], manualAdjust:0 },
 *   "工程名稱B": { allItems:[], manualAdjust:0 }
 * }
 ****************************************************/

// 讀取 localStorage
function loadProjects() {
  try {
    const raw = localStorage.getItem("projects_v2");
    if (!raw) return {};
    return JSON.parse(raw);
  } catch {
    return {};
  }
}

// 存入 localStorage
function saveProjects(projects) {
  localStorage.setItem("projects_v2", JSON.stringify(projects));
}

// 工程管理元件
function ProjectManager({ currentProject, setCurrentProject, projects, setProjects }) {

  // 新增工程
  function addProject() {
    const name = prompt("請輸入工程名稱：");
    if (!name) return;

    if (projects[name]) {
      alert("工程名稱已存在");
      return;
    }

    const updated = {
      ...projects,
      [name]: { allItems: [], manualAdjust: 0 }
    };

    setProjects(updated);
    setCurrentProject(name);
    saveProjects(updated);
  }

  // 刪除工程
  function deleteProject(name) {
    if (!window.confirm(`確定要刪除工程「${name}」？`)) return;

    const updated = { ...projects };
    delete updated[name];

    const nextKey = Object.keys(updated)[0] || "";

    setProjects(updated);
    setCurrentProject(nextKey);
    saveProjects(updated);
  }

  return (
    <div className="mb-4 p-3 bg-white rounded shadow">
      <h2 className="text-lg font-bold mb-2">工程管理</h2>
      <div className="flex flex-wrap gap-2">

        {/* 工程切換按鈕 */}
        {Object.keys(projects).map(key => (
          <button
            key={key}
            onClick={() => setCurrentProject(key)}
            className={
              "px-3 py-1 rounded border " +
              (currentProject === key
                ? "bg-blue-600 text-white border-blue-600"
                : "bg-white text-gray-700 border-gray-400")
            }
          >
            {key}
          </button>
        ))}

        {/* 新增工程 */}
        <button
          onClick={addProject}
          className="px-3 py-1 rounded bg-green-600 text-white font-bold"
        >
          ＋ 新增工程
        </button>

        {/* 刪除工程 */}
        {currentProject && (
          <button
            onClick={() => deleteProject(currentProject)}
            className="px-3 py-1 rounded bg-red-600 text-white"
          >
            刪除目前工程
          </button>
        )}

      </div>
    </div>
  );
}
/****************************************************
 * PART 3 — MaterialsPage Component
 * 材料成本（板材 / 型鋼）
 * 必須支援：
 *  - 板材(B1)：L、W、pcs、自動算面積、自動算重量
 *  - 型鋼(B2)：長度 len、支數 qty、自動算重量
 *  - 選單來源：材料資料庫（CSV）
 ****************************************************/

function MaterialsPage({ materialDB, addItemToProject }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [mode, setMode] = React.useState(""); // "板材" or "型鋼"

  // 板材用
  const [L, setL] = React.useState("");
  const [W, setW] = React.useState("");
  const [pcs, setPcs] = React.useState("");

  // 型鋼用
  const [lenVal, setLenVal] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 從資料庫中取得分類
  const categories = React.useMemo(() => {
    const setCat = new Set();
    materialDB.forEach(row => setCat.add(row.category));
    return [...setCat];
  }, [materialDB]);

  // 依分類取出 spec
  const specs = React.useMemo(() => {
    return materialDB
      .filter(row => row.category === category)
      .map(row => row.spec);
  }, [category, materialDB]);

  // 取得當前 spec 的資料（包含 weight 單位重、price 等）
  const selectedRow = React.useMemo(() => {
    return materialDB.find(row => row.category === category && row.spec === spec);
  }, [category, spec, materialDB]);


  // 計算重量與金額
  let weight = 0;
  let subtotal = 0;

  if (selectedRow) {
    const unitWeight = parseFloat(selectedRow.weight || 0);
    const unitPrice = parseFloat(selectedRow.price || 0);

    if (mode === "板材") {
      const area = (parseFloat(L || 0) * parseFloat(W || 0)) / 1_000_000; // mm² → m²
      weight = area * unitWeight * parseFloat(pcs || 0);
      subtotal = weight * unitPrice;
    }

    if (mode === "型鋼") {
      weight = parseFloat(lenVal || 0) * unitWeight * parseFloat(qty || 0);
      subtotal = weight * unitPrice;
    }
  }

  // 新增到工程資料
  function addToProject() {
    if (!category || !spec || !mode) {
      alert("請先選擇分類、規格與模式！");
      return;
    }
    if (mode === "板材" && (!L || !W || !pcs)) {
      alert("板材模式請輸入 L / W / 片數");
      return;
    }
    if (mode === "型鋼" && (!lenVal || !qty)) {
      alert("型鋼模式請輸入長度與支數");
      return;
    }

    const item = {
      type: "材料",
      category,
      spec,
      mode,
      L,
      W,
      pcs,
      lenVal,
      qty,
      weight,
      price: selectedRow ? selectedRow.price : 0,
      subtotal
    };

    addItemToProject(item);

    // 清除輸入
    setSpec("");
    setL(""); setW(""); setPcs("");
    setLenVal(""); setQty("");
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">材料成本</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* 規格 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">規格：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇規格</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* 選擇模式 */}
      {spec && (
        <div className="mb-3">
          <label className="font-bold">模式：</label>
          <select
            value={mode}
            onChange={e => { setMode(e.target.value); }}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇模式</option>
            <option value="板材">板材</option>
            <option value="型鋼">型鋼</option>
          </select>
        </div>
      )}

      {/* 板材模式 */}
      {mode === "板材" && (
        <div className="grid grid-cols-3 gap-4 mb-4">
          <div>
            <label className="font-bold">長度 L (mm)：</label>
            <input value={L} onChange={e => setL(e.target.value)} className="border w-full px-2 py-1 rounded" />
          </div>
          <div>
            <label className="font-bold">寬度 W (mm)：</label>
            <input value={W} onChange={e => setW(e.target.value)} className="border w-full px-2 py-1 rounded" />
          </div>
          <div>
            <label className="font-bold">片數 pcs：</label>
            <input value={pcs} onChange={e => setPcs(e.target.value)} className="border w-full px-2 py-1 rounded" />
          </div>
        </div>
      )}

      {/* 型鋼模式 */}
      {mode === "型鋼" && (
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label className="font-bold">長度 len (m)：</label>
            <input value={lenVal} onChange={e => setLenVal(e.target.value)} className="border w-full px-2 py-1 rounded" />
          </div>
          <div>
            <label className="font-bold">支數 qty：</label>
            <input value={qty} onChange={e => setQty(e.target.value)} className="border w-full px-2 py-1 rounded" />
          </div>
        </div>
      )}

      {/* 計算結果 */}
      {selectedRow && mode && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          <div>重量：<b>{weight.toFixed(2)}</b> kg</div>
          <div>小計：<b>{subtotal.toFixed(0)}</b> 元</div>
        </div>
      )}

      {/* 加入工程 */}
      <button
        onClick={addToProject}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入工程
      </button>
    </div>
  );
}
/****************************************************
 * PART 4 — PurchasePage Component
 * 市購品：
 *  - 選擇分類 → 規格(spec)
 *  - 顯示單價
 *  - 輸入數量 → 小計
 *  - 加入工程資料
 ****************************************************/

function PurchasePage({ purchaseDB, addItemToProject }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類
  const categories = React.useMemo(() => {
    const s = new Set();
    purchaseDB.forEach(r => s.add(r.category));
    return [...s];
  }, [purchaseDB]);

  // 依分類取得 spec
  const specs = React.useMemo(() => {
    return purchaseDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, purchaseDB]);

  // 取得所選 spec 資料
  const selectedRow = React.useMemo(() => {
    return purchaseDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, purchaseDB]);

  const unitPrice = selectedRow ? parseFloat(selectedRow.price || 0) : 0;
  const subtotal = unitPrice * parseFloat(qty || 0);

  function addToProject() {
    if (!category || !spec) {
      alert("請選擇分類與品項");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "市購品",
      category,
      spec,
      qty,
      price: unitPrice,
      subtotal
    };

    addItemToProject(item);
    setSpec("");
    setQty("");
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">市購品</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* 規格 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">品項：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇品項</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* 顯示單價 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{unitPrice}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：<b>{subtotal.toFixed(0)}</b> 元
        </div>
      )}

      {/* 加入工程 */}
      <button
        onClick={addToProject}
        className="px-4 py-2 bg-blue-600 text-white font-bold rounded"
      >
        ＋ 加入工程
      </button>
    </div>
  );
}
/****************************************************
 * PART 5 — FabricationPage Component
 * 製作成本：
 *  - 選分類 → 項目
 *  - 顯示單位 / 單價
 *  - 輸入數量 → 小計
 *  - 加入工程資料
 ****************************************************/

function FabricationPage({ fabricationDB, addItemToProject }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類
  const categories = React.useMemo(() => {
    const s = new Set();
    fabricationDB.forEach(r => s.add(r.category));
    return [...s];
  }, [fabricationDB]);

  // 依分類取得 spec
  const specs = React.useMemo(() => {
    return fabricationDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, fabricationDB]);

  // 取得所選 spec 資料
  const selectedRow = React.useMemo(() => {
    return fabricationDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, fabricationDB]);

  const unitPrice = selectedRow ? parseFloat(selectedRow.price || 0) : 0;
  const subtotal = unitPrice * parseFloat(qty || 0);

  function addToProject() {
    if (!category || !spec) {
      alert("請先選擇分類與項目");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "製作成本",
      category,
      spec,
      qty,
      price: unitPrice,
      subtotal
    };

    addItemToProject(item);
    setSpec("");
    setQty("");
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">製作成本</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* 項目（spec） */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">項目：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇項目</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* 單位 & 單價 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{unitPrice}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：<b>{subtotal.toFixed(0)}</b> 元
        </div>
      )}

      {/* 加入工程 */}
      <button
        onClick={addToProject}
        className="px-4 py-2 bg-blue-600 text-white font-bold rounded"
      >
        ＋ 加入工程
      </button>
    </div>
  );
}
/****************************************************
 * PART 6 — TransportPage Component
 * 運輸費用：
 *  - 選分類（車種）
 *  - 選項目（spec）
 *  - region 不計算，但可顯示
 *  - 數量 → 小計
 ****************************************************/

function TransportPage({ transportDB, addItemToProject }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得分類
  const categories = React.useMemo(() => {
    const s = new Set();
    transportDB.forEach(r => s.add(r.category));
    return [...s];
  }, [transportDB]);

  // 取得 spec
  const specs = React.useMemo(() => {
    return transportDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, transportDB]);

  // 找到選擇的項目
  const selectedRow = React.useMemo(() => {
    return transportDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, transportDB]);

  const unitPrice = selectedRow ? parseFloat(selectedRow.price || 0) : 0;
  const subtotal = unitPrice * parseFloat(qty || 0);

  function addToProject() {
    if (!category || !spec) {
      alert("請選擇分類與項目");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "運輸費用",
      category,
      spec,
      region: selectedRow ? selectedRow.region : "",
      qty,
      price: unitPrice,
      subtotal
    };

    addItemToProject(item);

    setSpec("");
    setQty("");
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">運輸費用</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 rounded ml-2"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
      </div>

      {/* 項目 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">項目：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 rounded ml-2"
          >
            <option value="">請選擇項目</option>
            {specs.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      )}

      {/* 顯示 region / 單價 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-3">
          <div>地區（region）：{selectedRow.region || "無"}</div>
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{unitPrice}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 rounded ml-2 w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：<b>{subtotal.toFixed(0)}</b> 元
        </div>
      )}

      {/* 加入工程 */}
      <button
        onClick={addToProject}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入工程
      </button>
    </div>
  );
}
/****************************************************
 * PART 7 — InstallPage Component
 * 現場安裝：
 *  - 選分類 → 規格
 *  - 顯示單位 / 單價
 *  - 數量 → 小計
 *  - 加入工程項目
 ****************************************************/

function InstallPage({ installDB, addItemToProject }) {
  const [category, setCategory] = React.useState("");
  const [spec, setSpec] = React.useState("");
  const [qty, setQty] = React.useState("");

  // 取得所有分類
  const categories = React.useMemo(() => {
    const s = new Set();
    installDB.forEach(r => s.add(r.category));
    return [...s];
  }, [installDB]);

  // 依分類選規格 spec
  const specs = React.useMemo(() => {
    return installDB
      .filter(r => r.category === category)
      .map(r => r.spec);
  }, [category, installDB]);

  // 尋找所選規格
  const selectedRow = React.useMemo(() => {
    return installDB.find(r => r.category === category && r.spec === spec);
  }, [category, spec, installDB]);

  const unitPrice = selectedRow ? parseFloat(selectedRow.price || 0) : 0;
  const subtotal = unitPrice * parseFloat(qty || 0);

  function addToProject() {
    if (!category || !spec) {
      alert("請選擇分類與項目");
      return;
    }
    if (!qty) {
      alert("請輸入數量");
      return;
    }

    const item = {
      type: "現場安裝",
      category,
      spec,
      qty,
      price: unitPrice,
      subtotal
    };

    addItemToProject(item);

    setSpec("");
    setQty("");
  }

  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">現場安裝</h2>

      {/* 分類 */}
      <div className="mb-3">
        <label className="font-bold">分類：</label>
        <select
          value={category}
          onChange={e => { setCategory(e.target.value); setSpec(""); }}
          className="border px-2 py-1 ml-2 rounded"
        >
          <option value="">請選擇分類</option>
          {categories.map(c => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
      </div>

      {/* 規格 */}
      {category && (
        <div className="mb-3">
          <label className="font-bold">規格：</label>
          <select
            value={spec}
            onChange={e => setSpec(e.target.value)}
            className="border px-2 py-1 ml-2 rounded"
          >
            <option value="">請選擇規格</option>
            {specs.map(s => (
              <option key={s} value={s}>{s}</option>
            ))}
          </select>
        </div>
      )}

      {/* 顯示單位與單價 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          <div>單位：{selectedRow.unit}</div>
          <div>單價：<b>{unitPrice}</b> 元</div>
        </div>
      )}

      {/* 數量 */}
      {selectedRow && (
        <div className="mb-4">
          <label className="font-bold">數量：</label>
          <input
            type="number"
            value={qty}
            onChange={e => setQty(e.target.value)}
            className="border px-2 py-1 ml-2 rounded w-32"
          />
        </div>
      )}

      {/* 小計 */}
      {selectedRow && (
        <div className="p-3 bg-gray-50 border rounded mb-4">
          小計：<b>{subtotal.toFixed(0)}</b> 元
        </div>
      )}

      {/* 加入工程 */}
      <button
        onClick={addToProject}
        className="px-4 py-2 bg-blue-600 text-white rounded font-bold"
      >
        ＋ 加入工程
      </button>
    </div>
  );
}
/****************************************************
 * PART 8 — CSV Loader + Mode-C version sync
 * 功能：
 *   - 抓取五大 Google Sheet CSV
 *   - CSV → JSON parser
 *   - 版本比較（行數 + 第一列 + 最後一列）
 *   - 若版本一致 → 用 localStorage
 *   - 若版本不同 → 更新 localStorage
 *   - 回傳五大資料庫
 ****************************************************/

// 五大 CSV URL
const CSV_URLS = {
  material:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=0&single=true&output=csv",
  purchase:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1300343145&single=true&output=csv",
  fabrication:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=1755952578&single=true&output=csv",
  transport:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=11669107&single=true&output=csv",
  install:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4AmTB3LJQYXPtKDAyY3efChJ1EMU5qlAfMzZ33_qqcVPhIAinukL8IVGq8RTCpIOf7O_bf-xHh5My/pub?gid=183776968&single=true&output=csv",
};


// ★ 通用 CSV Parser：輸出 JSON array
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim());
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(",");
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = cols[idx] ? cols[idx].trim() : "";
    });
    rows.push(obj);
  }
  return rows;
}

// ★ 建立 version 字串（行數 + 第一列 + 最後一列）
function buildVersion(rows) {
  if (!rows.length) return "empty";

  const first = JSON.stringify(rows[0]);
  const last = JSON.stringify(rows[rows.length - 1]);
  return `${rows.length}-${first}-${last}`;
}

// ★ 從 localStorage 讀資料（若資料不存在回傳 null）
function loadLocalDB(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch {
    return null;
  }
}

// ★ 寫入 localStorage
function saveLocalDB(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

// ★ Mode-C 同步總控制：回傳五大 DB 與版本資訊
async function loadAllDBs() {
  const results = {
    materialDB: [],
    purchaseDB: [],
    fabricationDB: [],
    transportDB: [],
    installDB: [],
    versionInfo: {},
    syncTime: "",
  };

  const nowTime = new Date().toLocaleString();
  results.syncTime = nowTime;

  // 五大 DB 的 key
  const keys = [
    ["materialDB", CSV_URLS.material],
    ["purchaseDB", CSV_URLS.purchase],
    ["fabricationDB", CSV_URLS.fabrication],
    ["transportDB", CSV_URLS.transport],
    ["installDB", CSV_URLS.install],
  ];

  for (const [dbKey, url] of keys) {
    try {
      const resp = await fetch(url);
      const text = await resp.text();
      const parsed = parseCSV(text);

      const version = buildVersion(parsed);
      const localVersion = localStorage.getItem(dbKey + "_version");
      const localDB = loadLocalDB(dbKey);

      if (localDB && localVersion === version) {
        // ★ 版本相同 → 使用 localStorage
        results[dbKey] = localDB;
        results.versionInfo[dbKey] = { version, source: "localStorage" };
      } else {
        // ★ 版本不同 → 更新 localStorage
        results[dbKey] = parsed;
        results.versionInfo[dbKey] = { version, source: "remote" };
        saveLocalDB(dbKey, parsed);
        localStorage.setItem(dbKey + "_version", version);
      }
    } catch (e) {
      console.error("CSV 載入失敗：", dbKey, e);
    }
  }

  // 儲存最後同步時間
  localStorage.setItem("syncTime", nowTime);

  return results;
}
/****************************************************
 * PART 9 — SummaryPage Component
 * 五大類別加總 + 圓餅圖 + manualAdjust
 ****************************************************/

function SummaryPage({ projectData, setProjectData, syncTime }) {

  const canvasRef = React.useRef(null);
  const chartRef = React.useRef(null);

  // 計算各類別金額
  const summary = React.useMemo(() => {
    const sum = {
      材料: 0,
      市購品: 0,
      製作成本: 0,
      運輸費用: 0,
      現場安裝: 0,
    };

    if (projectData && projectData.allItems) {
      projectData.allItems.forEach(item => {
        if (sum[item.type] !== undefined) {
          sum[item.type] += Number(item.subtotal || 0);
        }
      });
    }

    return sum;
  }, [projectData]);

  const total =
    summary.材料 +
    summary.市購品 +
    summary.製作成本 +
    summary.運輸費用 +
    summary.現場安裝 +
    Number(projectData?.manualAdjust || 0);


  // 手動調整
  function updateAdjust(v) {
    const updated = {
      ...projectData,
      manualAdjust: Number(v || 0),
    };
    setProjectData(updated);
  }


  // ★ 圓餅圖 render
  React.useEffect(() => {
    if (!canvasRef.current) return;

    // 清除舊圖
    if (chartRef.current) {
      chartRef.current.destroy();
      chartRef.current = null;
    }

    const ctx = canvasRef.current.getContext("2d");

    const labels = ["材料", "市購品", "製作成本", "運輸費用", "現場安裝"];
    const values = [
      summary.材料,
      summary.市購品,
      summary.製作成本,
      summary.運輸費用,
      summary.現場安裝,
    ];

    chartRef.current = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [
          {
            data: values,
            backgroundColor: [
              "#2563eb", // 藍
              "#16a34a", // 綠
              "#f59e0b", // 黃
              "#dc2626", // 紅
              "#9333ea", // 紫
            ],
          },
        ],
      },
      options: {
        plugins: {
          datalabels: {
            color: "#fff",
            formatter: (value) => value.toFixed(0),
          },
        },
      },
      plugins: [ChartDataLabels],
    });
  }, [summary]);


  return (
    <div className="p-4 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">總表 Summary</h2>

      {/* 加總表 */}
      <table className="w-full mb-4 border">
        <thead className="bg-gray-100">
          <tr>
            <th className="border px-3 py-2">項目</th>
            <th className="border px-3 py-2">金額 (元)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td className="border px-3 py-2">材料</td><td className="border px-3 py-2">{summary.材料.toLocaleString()}</td></tr>
          <tr><td className="border px-3 py-2">市購品</td><td className="border px-3 py-2">{summary.市購品.toLocaleString()}</td></tr>
          <tr><td className="border px-3 py-2">製作成本</td><td className="border px-3 py-2">{summary.製作成本.toLocaleString()}</td></tr>
          <tr><td className="border px-3 py-2">運輸費用</td><td className="border px-3 py-2">{summary.運輸費用.toLocaleString()}</td></tr>
          <tr><td className="border px-3 py-2">現場安裝</td><td className="border px-3 py-2">{summary.現場安裝.toLocaleString()}</td></tr>
          <tr>
            <td className="border px-3 py-2 font-bold">人工調整</td>
            <td className="border px-3 py-2">
              <input
                type="number"
                value={projectData?.manualAdjust || 0}
                onChange={e => updateAdjust(e.target.value)}
                className="border px-2 py-1 w-32 rounded"
              />
            </td>
          </tr>
          <tr className="bg-blue-50 font-bold">
            <td className="border px-3 py-2">總金額</td>
            <td className="border px-3 py-2 text-blue-700">
              {total.toLocaleString()}
            </td>
          </tr>
        </tbody>
      </table>

      {/* 圓餅圖 */}
      <div className="flex justify-center mb-4">
        <canvas ref={canvasRef} width="300" height="300"></canvas>
      </div>

      {/* 最後同步時間 */}
      <div className="text-sm text-gray-500">
        最後資料同步時間： {syncTime || "尚未同步"}
      </div>
    </div>
  );
}
/****************************************************
 * PART 10 — App 主體
 * 功能：
 *  - 載入 CSV + version 同步
 *  - 工程管理 + 切換
 *  - Tab 分頁（A 版）
 *  - 五大頁面整合
 *  - 總表 SummaryPage
 ****************************************************/

function App() {
  const [loading, setLoading] = React.useState(true);

  // 五大資料庫
  const [materialDB, setMaterialDB] = React.useState([]);
  const [purchaseDB, setPurchaseDB] = React.useState([]);
  const [fabricationDB, setFabricationDB] = React.useState([]);
  const [transportDB, setTransportDB] = React.useState([]);
  const [installDB, setInstallDB] = React.useState([]);

  const [syncTime, setSyncTime] = React.useState("");

  // 工程資料
  const [projects, setProjects] = React.useState(loadProjects());
  const [currentProject, setCurrentProject] = React.useState(
    Object.keys(loadProjects())[0] || ""
  );

  // Tab 頁面
  const tabs = ["材料", "市購品", "製作成本", "運輸", "現場安裝", "總表"];
  const [activeTab, setActiveTab] = React.useState("材料");

  // ★ 初始化：載入五大資料庫（Mode-C）
  React.useEffect(() => {
    async function init() {
      const r = await loadAllDBs();
      setMaterialDB(r.materialDB);
      setPurchaseDB(r.purchaseDB);
      setFabricationDB(r.fabricationDB);
      setTransportDB(r.transportDB);
      setInstallDB(r.installDB);

      setSyncTime(r.syncTime);

      setLoading(false);
    }
    init();
  }, []);

  // ★ 若沒有工程，建立一個預設工程
  React.useEffect(() => {
    if (!currentProject && Object.keys(projects).length === 0) {
      const def = { "新工程": { allItems: [], manualAdjust: 0 } };
      setProjects(def);
      setCurrentProject("新工程");
      saveProjects(def);
    }
  }, []);

  // ★ 取得目前工程資料
  const projectData = projects[currentProject] || { allItems: [], manualAdjust: 0 };

  // ★ 更新目前工程資料（SummaryPage 或其他頁面會用到）
  function setProjectData(newData) {
    const updated = {
      ...projects,
      [currentProject]: newData,
    };
    setProjects(updated);
    saveProjects(updated);
  }

  // ★ 新增項目到工程
  function addItemToProject(item) {
    const updatedProject = {
      ...projectData,
      allItems: [...projectData.allItems, item],
    };

    const updated = {
      ...projects,
      [currentProject]: updatedProject,
    };

    setProjects(updated);
    saveProjects(updated);
  }


  /* ------------------------- RENDER ------------------------- */

  if (loading) {
    return (
      <div className="p-10 text-center text-xl">
        ⏳ 正在同步 Google Sheet 資料，請稍候…
      </div>
    );
  }

  return (
    <div className="max-w-5xl mx-auto p-4">

      {/* 工程管理 */}
      <ProjectManager
        currentProject={currentProject}
        setCurrentProject={setCurrentProject}
        projects={projects}
        setProjects={setProjects}
      />

      {/* Tabs */}
      <div className="flex gap-2 mb-4 border-b pb-2">
        {tabs.map(t => (
          <button
            key={t}
            onClick={() => setActiveTab(t)}
            className={
              "px-4 py-2 rounded-t font-bold " +
              (activeTab === t
                ? "bg-blue-600 text-white"
                : "bg-gray-200 text-gray-700")
            }
          >
            {t}
          </button>
        ))}
      </div>

      {/* 各分頁內容 */}
      {activeTab === "材料" && (
        <MaterialsPage
          materialDB={materialDB}
          addItemToProject={addItemToProject}
        />
      )}

      {activeTab === "市購品" && (
        <PurchasePage
          purchaseDB={purchaseDB}
          addItemToProject={addItemToProject}
        />
      )}

      {activeTab === "製作成本" && (
        <FabricationPage
          fabricationDB={fabricationDB}
          addItemToProject={addItemToProject}
        />
      )}

      {activeTab === "運輸" && (
        <TransportPage
          transportDB={transportDB}
          addItemToProject={addItemToProject}
        />
      )}

      {activeTab === "現場安裝" && (
        <InstallPage
          installDB={installDB}
          addItemToProject={addItemToProject}
        />
      )}

      {activeTab === "總表" && (
        <SummaryPage
          projectData={projectData}
          setProjectData={setProjectData}
          syncTime={syncTime}
        />
      )}
    </div>
  );
}

/****************************************************
 * ReactDOM Render
 ****************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</body>
</html>
